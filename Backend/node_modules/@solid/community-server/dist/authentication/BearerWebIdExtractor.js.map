{"version":3,"file":"BearerWebIdExtractor.js","sourceRoot":"","sources":["../../src/authentication/BearerWebIdExtractor.ts"],"names":[],"mappings":";;;AACA,wEAAwE;AACxE,gDAAkD;AAElD,4EAAyE;AACzE,oFAAiF;AACjF,mDAAgE;AAEhE,iEAA8D;AAE9D,MAAa,oBAAqB,SAAQ,2CAAoB;IACzC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAC9B,MAAM,CAA6B;IAEpD;QACE,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,IAAA,gDAAwB,GAAE,CAAC;IAC3C,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,EAAE,OAAO,EAAe;QAC7C,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;QAClC,IAAI,CAAC,IAAA,uCAA0B,EAAC,QAAQ,EAAE,aAAa,CAAC,EAAE,CAAC;YACzD,MAAM,IAAI,iDAAuB,CAAC,2CAA2C,CAAC,CAAC;QACjF,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,OAAoB;QACtC,MAAM,EAAE,OAAO,EAAE,EAAE,aAAa,EAAE,EAAC,GAAG,OAAO,CAAC;QAE9C,IAAI,CAAC;YACH,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,aAAc,CAAC,CAAC;YAC7F,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,wDAAwD,KACzE,gBAAgB,QAAQ,aAAa,MAAM,EAAE,CAAC,CAAC;YAC/C,MAAM,WAAW,GAAgB,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,EAAE,MAAM,EAAE,EAAE,GAAG,EAAE,MAAM,EAAE,EAAC,CAAC;YAC9E,IAAI,QAAQ,EAAE,CAAC;gBACb,WAAW,CAAC,MAAM,GAAG,EAAE,QAAQ,EAAE,CAAC;YACpC,CAAC;YACD,OAAO,WAAW,CAAC;QACrB,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,MAAM,OAAO,GAAG,kDAAmD,KAAe,CAAC,OAAO,EAAE,CAAC;YAC7F,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC1B,MAAM,IAAI,yCAAmB,CAAC,OAAO,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;QAC3D,CAAC;IACH,CAAC;CACF;AAlCD,oDAkCC","sourcesContent":["import type { SolidTokenVerifierFunction } from '@solid/access-token-verifier';\nimport { createSolidTokenVerifier } from '@solid/access-token-verifier';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport type { HttpRequest } from '../server/HttpRequest';\nimport { BadRequestHttpError } from '../util/errors/BadRequestHttpError';\nimport { NotImplementedHttpError } from '../util/errors/NotImplementedHttpError';\nimport { matchesAuthorizationScheme } from '../util/HeaderUtil';\nimport type { Credentials } from './Credentials';\nimport { CredentialsExtractor } from './CredentialsExtractor';\n\nexport class BearerWebIdExtractor extends CredentialsExtractor {\n  protected readonly logger = getLoggerFor(this);\n  private readonly verify: SolidTokenVerifierFunction;\n\n  public constructor() {\n    super();\n    this.verify = createSolidTokenVerifier();\n  }\n\n  public async canHandle({ headers }: HttpRequest): Promise<void> {\n    const { authorization } = headers;\n    if (!matchesAuthorizationScheme('Bearer', authorization)) {\n      throw new NotImplementedHttpError('No Bearer Authorization header specified.');\n    }\n  }\n\n  public async handle(request: HttpRequest): Promise<Credentials> {\n    const { headers: { authorization }} = request;\n\n    try {\n      const { webid: webId, client_id: clientId, iss: issuer } = await this.verify(authorization!);\n      this.logger.info(`Verified credentials via Bearer access token. WebID: ${webId\n      }, client ID: ${clientId}, issuer: ${issuer}`);\n      const credentials: Credentials = { agent: { webId }, issuer: { url: issuer }};\n      if (clientId) {\n        credentials.client = { clientId };\n      }\n      return credentials;\n    } catch (error: unknown) {\n      const message = `Error verifying WebID via Bearer access token: ${(error as Error).message}`;\n      this.logger.warn(message);\n      throw new BadRequestHttpError(message, { cause: error });\n    }\n  }\n}\n"]}