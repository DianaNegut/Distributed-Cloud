{"version":3,"file":"OwnerPermissionReader.js","sourceRoot":"","sources":["../../src/authorization/OwnerPermissionReader.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AuxiliaryIdentifierStrategy } from '../http/auxiliary/AuxiliaryIdentifierStrategy';\nimport type { ResourceIdentifier } from '../http/representation/ResourceIdentifier';\nimport type { PodStore } from '../identity/interaction/pod/util/PodStore';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport type { StorageLocationStrategy } from '../server/description/StorageLocationStrategy';\nimport { filter } from '../util/IterableUtil';\nimport { IdentifierMap } from '../util/map/IdentifierMap';\nimport type { PermissionReaderInput } from './PermissionReader';\nimport { PermissionReader } from './PermissionReader';\nimport type { AclPermissionSet } from './permissions/AclPermissionSet';\nimport type { PermissionMap } from './permissions/Permissions';\n\n/**\n * Allows control access if the request is being made by an owner of the pod containing the resource.\n */\nexport class OwnerPermissionReader extends PermissionReader {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly podStore: PodStore;\n  private readonly authStrategy: AuxiliaryIdentifierStrategy;\n  private readonly storageStrategy: StorageLocationStrategy;\n\n  public constructor(\n    podStore: PodStore,\n    authStrategy: AuxiliaryIdentifierStrategy,\n    storageStrategy: StorageLocationStrategy,\n  ) {\n    super();\n    this.podStore = podStore;\n    this.authStrategy = authStrategy;\n    this.storageStrategy = storageStrategy;\n  }\n\n  public async handle(input: PermissionReaderInput): Promise<PermissionMap> {\n    const result: PermissionMap = new IdentifierMap();\n    const requestedResources = input.requestedModes.distinctKeys();\n    const auths = [ ...filter(requestedResources, (id): boolean => this.authStrategy.isAuxiliaryIdentifier(id)) ];\n    if (auths.length === 0) {\n      this.logger.debug(`No authorization resources found that need an ownership check.`);\n      return result;\n    }\n\n    const webId = input.credentials.agent?.webId;\n    if (!webId) {\n      this.logger.debug(`No WebId found for an ownership check on the pod.`);\n      return result;\n    }\n\n    const pods = await this.findPods(auths);\n    const owners = await this.findOwners(Object.values(pods));\n\n    for (const auth of auths) {\n      const webIds = owners[pods[auth.path]];\n      if (!webIds) {\n        continue;\n      }\n      if (webIds.includes(webId)) {\n        this.logger.debug(`Granting Control permissions to owner on ${auth.path}`);\n        result.set(auth, {\n          read: true,\n          write: true,\n          append: true,\n          create: true,\n          delete: true,\n          control: true,\n        } as AclPermissionSet);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Finds all pods that contain the given identifiers.\n   * Return value is a record where the keys are the identifiers and the values the associated pod.\n   */\n  protected async findPods(identifiers: ResourceIdentifier[]): Promise<Record<string, string>> {\n    const pods: Record<string, string> = {};\n    for (const identifier of identifiers) {\n      let pod: ResourceIdentifier;\n      try {\n        pod = await this.storageStrategy.getStorageIdentifier(identifier);\n      } catch {\n        this.logger.error(`Unable to find root storage for ${identifier.path}`);\n        continue;\n      }\n      pods[identifier.path] = pod.path;\n    }\n    return pods;\n  }\n\n  /**\n   * Finds the owners of the given pods.\n   * Return value is a record where the keys are the pods and the values are all the WebIDs that own this pod.\n   */\n  protected async findOwners(pods: string[]): Promise<Record<string, string[]>> {\n    const owners: Record<string, string[]> = {};\n    // Set to only have the unique values\n    for (const baseUrl of new Set(pods)) {\n      const pod = await this.podStore.findByBaseUrl(baseUrl);\n      if (!pod) {\n        this.logger.error(`Unable to find pod ${baseUrl}`);\n        continue;\n      }\n\n      const podOwners = await this.podStore.getOwners(pod.id);\n      if (!podOwners) {\n        this.logger.error(`Unable to find owners for ${baseUrl}`);\n        continue;\n      }\n      owners[baseUrl] = podOwners.map((owner): string => owner.webId);\n    }\n    return owners;\n  }\n}\n"]}