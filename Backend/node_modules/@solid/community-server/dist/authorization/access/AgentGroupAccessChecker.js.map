{"version":3,"file":"AgentGroupAccessChecker.js","sourceRoot":"","sources":["../../../src/authorization/access/AgentGroupAccessChecker.ts"],"names":[],"mappings":";;;AAEA,oDAAoD;AACpD,wDAAqD;AACrD,sDAAwD;AACxD,0DAAqD;AAErD,mDAAgD;AAEhD;;;GAGG;AACH,MAAa,uBAAwB,SAAQ,6BAAa;IACxD;QACE,KAAK,EAAE,CAAC;IACV,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,WAAW,EAAqB;QAC/D,IAAI,OAAO,WAAW,CAAC,KAAK,EAAE,KAAK,KAAK,QAAQ,EAAE,CAAC;YACjD,MAAM,EAAE,KAAK,EAAE,GAAG,WAAW,CAAC,KAAK,CAAC;YACpC,MAAM,MAAM,GAAG,GAAG,CAAC,UAAU,CAAC,IAAI,EAAE,kBAAG,CAAC,KAAK,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;YAEhE,OAAO,IAAA,yBAAW,EAAC,MAAM,CAAC,GAAG,CAAC,KAAK,EAAC,KAAW,EAAoB,EAAE,CACnE,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;QACzC,CAAC;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAED;;;;;;;OAOG;IACK,KAAK,CAAC,eAAe,CAAC,KAAa,EAAE,KAAW;QACtD,MAAM,aAAa,GAAuB,EAAE,IAAI,EAAE,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAE,CAAC,CAAC,CAAC,EAAE,CAAC;QAEpF,sCAAsC;QACtC,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QACxD,OAAO,KAAK,CAAC,UAAU,CAAC,KAAK,EAAE,oBAAK,CAAC,KAAK,CAAC,SAAS,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;IAC3E,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,UAAU,CAAC,GAAW;QAClC,MAAM,IAAI,GAAG,CAAC,KAAK,IAAmB,EAAE;YACtC,MAAM,cAAc,GAAG,MAAM,IAAA,wBAAY,EAAC,GAAG,CAAC,CAAC;YAC/C,OAAO,IAAA,4BAAe,EAAC,cAAc,CAAC,IAAI,CAAC,CAAC;QAC9C,CAAC,CAAC,EAAE,CAAC;QACL,OAAO,IAAI,CAAC;IACd,CAAC;CACF;AA1CD,0DA0CC","sourcesContent":["import type { Store, Term } from 'n3';\nimport type { ResourceIdentifier } from '../../http/representation/ResourceIdentifier';\nimport { fetchDataset } from '../../util/FetchUtil';\nimport { promiseSome } from '../../util/PromiseUtil';\nimport { readableToQuads } from '../../util/StreamUtil';\nimport { ACL, VCARD } from '../../util/Vocabularies';\nimport type { AccessCheckerArgs } from './AccessChecker';\nimport { AccessChecker } from './AccessChecker';\n\n/**\n * Checks if the given WebID belongs to a group that has access.\n * Implements the behaviour of groups from the WAC specification.\n */\nexport class AgentGroupAccessChecker extends AccessChecker {\n  public constructor() {\n    super();\n  }\n\n  public async handle({ acl, rule, credentials }: AccessCheckerArgs): Promise<boolean> {\n    if (typeof credentials.agent?.webId === 'string') {\n      const { webId } = credentials.agent;\n      const groups = acl.getObjects(rule, ACL.terms.agentGroup, null);\n\n      return promiseSome(groups.map(async(group: Term): Promise<boolean> =>\n        this.isMemberOfGroup(webId, group)));\n    }\n    return false;\n  }\n\n  /**\n   * Checks if the given agent is member of a given vCard group.\n   *\n   * @param webId - WebID of the agent that needs access.\n   * @param group - URL of the vCard group that needs to be checked.\n   *\n   * @returns If the agent is member of the given vCard group.\n   */\n  private async isMemberOfGroup(webId: string, group: Term): Promise<boolean> {\n    const groupDocument: ResourceIdentifier = { path: /^[^#]*/u.exec(group.value)![0] };\n\n    // Fetch the required vCard group file\n    const quads = await this.fetchQuads(groupDocument.path);\n    return quads.countQuads(group, VCARD.terms.hasMember, webId, null) !== 0;\n  }\n\n  /**\n   * Fetches quads from the given URL.\n   */\n  private async fetchQuads(url: string): Promise<Store> {\n    const prom = (async(): Promise<Store> => {\n      const representation = await fetchDataset(url);\n      return readableToQuads(representation.data);\n    })();\n    return prom;\n  }\n}\n"]}