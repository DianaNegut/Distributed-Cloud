{"version":3,"file":"IdentityProviderHttpHandler.js","sourceRoot":"","sources":["../../src/identity/IdentityProviderHttpHandler.ts"],"names":[],"mappings":";;;AAAA,yFAAsF;AAEtF,gDAAkD;AAElD,yEAAsE;AACtE,wDAA8D;AAC9D,uDAAkD;AAoBlD;;;;;GAKG;AACH,MAAa,2BAA4B,SAAQ,2CAAoB;IAChD,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,eAAe,CAAkB;IACjC,WAAW,CAAc;IACzB,OAAO,CAAqB;IAE7C,YAAmB,IAAqC;QACtD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,eAAe,CAAC;QAC5C,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC;QACpC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;IAC9B,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,OAAO,EAAE,QAAQ,EAA6B;QAC7E,oDAAoD;QACpD,IAAI,eAAwC,CAAC;QAC7C,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,CAAC;YAC1D,eAAe,GAAG,MAAM,QAAQ,CAAC,kBAAkB,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;YACvE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,mCAAmC,CAAC,CAAC;QACzD,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,qCAAqC,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,CAAC,CAAC;QACtF,CAAC;QAED,oBAAoB;QACpB,IAAI,SAA6B,CAAC;QAClC,MAAM,MAAM,GAAG,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,CAAC;QAClF,IAAI,MAAM,EAAE,CAAC;YACX,SAAS,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACjD,CAAC;QAED,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,SAAS,EAAE,eAAe,EAAE,SAAS,EAAE,CAAC,CAAC;QAChG,OAAO,IAAI,6CAAqB,CAAC,cAAc,CAAC,QAAQ,EAAE,cAAc,CAAC,IAAI,CAAC,CAAC;IACjF,CAAC;CACF;AAnCD,kEAmCC","sourcesContent":["import { OkResponseDescription } from '../http/output/response/OkResponseDescription';\nimport type { ResponseDescription } from '../http/output/response/ResponseDescription';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport type { OperationHttpHandlerInput } from '../server/OperationHttpHandler';\nimport { OperationHttpHandler } from '../server/OperationHttpHandler';\nimport { createErrorMessage } from '../util/errors/ErrorUtil';\nimport { SOLID_HTTP } from '../util/Vocabularies';\nimport type { ProviderFactory } from './configuration/ProviderFactory';\nimport type { CookieStore } from './interaction/account/util/CookieStore';\nimport type { Interaction, InteractionHandler } from './interaction/InteractionHandler';\n\nexport interface IdentityProviderHttpHandlerArgs {\n  /**\n   * Used to generate the OIDC provider.\n   */\n  providerFactory: ProviderFactory;\n  /**\n   * Used to determine the account of the requesting agent.\n   */\n  cookieStore: CookieStore;\n  /**\n   * Handles the requests.\n   */\n  handler: InteractionHandler;\n}\n\n/**\n * Generates the active Interaction object if there is an ongoing OIDC interaction.\n * Finds the account ID if there is cookie metadata.\n *\n * Calls the stored {@link InteractionHandler} with that information and returns the result.\n */\nexport class IdentityProviderHttpHandler extends OperationHttpHandler {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly providerFactory: ProviderFactory;\n  private readonly cookieStore: CookieStore;\n  private readonly handler: InteractionHandler;\n\n  public constructor(args: IdentityProviderHttpHandlerArgs) {\n    super();\n    this.providerFactory = args.providerFactory;\n    this.cookieStore = args.cookieStore;\n    this.handler = args.handler;\n  }\n\n  public async handle({ operation, request, response }: OperationHttpHandlerInput): Promise<ResponseDescription> {\n    // This being defined means we're in an OIDC session\n    let oidcInteraction: Interaction | undefined;\n    try {\n      const provider = await this.providerFactory.getProvider();\n      oidcInteraction = await provider.interactionDetails(request, response);\n      this.logger.debug('Found an active OIDC interaction.');\n    } catch (error: unknown) {\n      this.logger.debug(`No active OIDC interaction found: ${createErrorMessage(error)}`);\n    }\n\n    // Determine account\n    let accountId: string | undefined;\n    const cookie = operation.body.metadata.get(SOLID_HTTP.terms.accountCookie)?.value;\n    if (cookie) {\n      accountId = await this.cookieStore.get(cookie);\n    }\n\n    const representation = await this.handler.handleSafe({ operation, oidcInteraction, accountId });\n    return new OkResponseDescription(representation.metadata, representation.data);\n  }\n}\n"]}