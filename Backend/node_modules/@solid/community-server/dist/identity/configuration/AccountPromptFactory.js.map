{"version":3,"file":"AccountPromptFactory.js","sourceRoot":"","sources":["../../../src/identity/configuration/AccountPromptFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import type { interactionPolicy, KoaContextWithOIDC } from '../../../templates/types/oidc-provider';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport { InternalServerError } from '../../util/errors/InternalServerError';\nimport { importOidcProvider } from '../IdentityUtil';\nimport type { CookieStore } from '../interaction/account/util/CookieStore';\nimport { ACCOUNT_PROMPT } from '../interaction/InteractionUtil';\nimport type { WebIdStore } from '../interaction/webid/util/WebIdStore';\nimport { PromptFactory } from './PromptFactory';\n\ntype OIDCContext = NonNullable<KoaContextWithOIDC['oidc']['entities']['OIDCContext']>;\ntype ExtendedContext = OIDCContext & { internalAccountId?: string };\n\n/**\n * Creates the prompt necessary to ensure a user is logged in with their account when doing an OIDC interaction.\n * This is done by checking the presence of the account-related cookie.\n *\n * Adds a Check to the login policy that verifies if the stored accountId, which corresponds to the chosen WebID,\n * belongs to the currently logged in account.\n */\nexport class AccountPromptFactory extends PromptFactory {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly webIdStore: WebIdStore;\n  private readonly cookieStore: CookieStore;\n  private readonly cookieName: string;\n\n  public constructor(webIdStore: WebIdStore, cookieStore: CookieStore, cookieName: string) {\n    super();\n    this.webIdStore = webIdStore;\n    this.cookieStore = cookieStore;\n    this.cookieName = cookieName;\n  }\n\n  public async handle(policy: interactionPolicy.DefaultPolicy): Promise<void> {\n    const { interactionPolicy: ip } = await importOidcProvider();\n    this.addAccountPrompt(policy, ip);\n    this.addWebIdVerificationPrompt(policy, ip);\n  }\n\n  private addAccountPrompt(policy: interactionPolicy.DefaultPolicy, ip: typeof interactionPolicy): void {\n    const check = new ip.Check('no_account', 'An account cookie is required.', async(ctx): Promise<boolean> => {\n      const cookie = ctx.cookies.get(this.cookieName);\n      let accountId: string | undefined;\n      if (cookie) {\n        accountId = await this.cookieStore.get(cookie);\n        // This is an ugly way to pass a value to the other prompts/checks,\n        // but the oidc-provider library does similar things internally.\n        (ctx.oidc as ExtendedContext).internalAccountId = accountId;\n      }\n      this.logger.debug(`Found account cookie ${cookie} and accountID ${accountId}`);\n\n      // Check needs to return true if the prompt has to trigger\n      return !accountId;\n    });\n    const accountPrompt = new ip.Prompt({ name: ACCOUNT_PROMPT, requestable: true }, check);\n    policy.add(accountPrompt, 0);\n  }\n\n  private addWebIdVerificationPrompt(policy: interactionPolicy.DefaultPolicy, ip: typeof interactionPolicy): void {\n    const check = new ip.Check(\n      'no_webid_ownserhip',\n      'The stored WebID does not belong to the account.',\n      async(ctx): Promise<boolean> => {\n        const webId = ctx.oidc.session?.accountId;\n        if (!webId) {\n          return false;\n        }\n\n        const accountId = (ctx.oidc as ExtendedContext).internalAccountId;\n        if (!accountId) {\n          this.logger.error(`Missing 'internalAccountId' value in OIDC context`);\n          return false;\n        }\n\n        const isLinked = await this.webIdStore.isLinked(webId, accountId);\n        this.logger.debug(`Session has WebID ${webId\n        }, which ${isLinked ? 'belongs' : 'does not belong'} to the authenticated account`);\n\n        return !isLinked;\n      },\n    );\n    const loginPrompt = policy.get('login');\n    if (!loginPrompt) {\n      throw new InternalServerError('Missing default login policy');\n    }\n    loginPrompt.checks.add(check);\n  }\n}\n"]}