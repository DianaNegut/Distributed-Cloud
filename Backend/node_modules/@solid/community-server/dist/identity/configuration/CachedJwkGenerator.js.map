{"version":3,"file":"CachedJwkGenerator.js","sourceRoot":"","sources":["../../../src/identity/configuration/CachedJwkGenerator.ts"],"names":[],"mappings":";;;AAAA,6CAA8C;AAE9C,+BAA6D;AAK7D;;;;;;;GAOG;AACH,MAAa,kBAAkB;IACb,GAAG,CAA6B;IAE/B,GAAG,CAAS;IACZ,OAAO,CAAgC;IAEhD,UAAU,CAAU;IACpB,SAAS,CAAU;IAE3B,YAAmB,GAA+B,EAAE,UAAkB,EAAE,OAAsC;QAC5G,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;QACf,IAAI,CAAC,GAAG,GAAG,UAAU,CAAC;QACtB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACzB,CAAC;IAEM,KAAK,CAAC,aAAa;QACxB,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;YACpB,OAAO,IAAI,CAAC,UAAU,CAAC;QACzB,CAAC;QAED,+DAA+D;QAC/D,sFAAsF;QACtF,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAC9C,IAAI,IAAI,EAAE,CAAC;YACT,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC,CAAW,CAAC;YACzC,OAAO,IAAI,CAAC,UAAU,CAAC;QACzB,CAAC;QAED,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,IAAA,sBAAe,EAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEvD,uDAAuD;QACvD,MAAM,UAAU,GAAG,EAAE,GAAG,MAAM,IAAA,gBAAS,EAAC,UAAU,CAAC,EAAY,CAAC;QAChE,UAAU,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;QAE1B,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,IAAI,EAAE,CAAE,UAAU,CAAE,EAAC,CAAC,CAAC;QAC1D,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,OAAO,UAAU,CAAC;IACpB,CAAC;IAEM,KAAK,CAAC,YAAY;QACvB,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,OAAO,IAAI,CAAC,SAAS,CAAC;QACxB,CAAC;QAED,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;QAE9C,oGAAoG;QACpG,6FAA6F;QAC7F,4CAA4C;QAC5C,MAAM,UAAU,GAAG,MAAM,IAAA,gBAAS,EAAC,UAAU,CAAC,CAAC;QAC/C,MAAM,SAAS,GAAG,IAAA,6BAAe,EAAC,UAAuB,CAAC,CAAC;QAE3D,MAAM,SAAS,GAAG,EAAE,GAAG,MAAM,IAAA,gBAAS,EAAC,SAAS,CAAC,EAAY,CAAC;QAC9D,gDAAgD;QAChD,SAAS,CAAC,GAAG,GAAG,UAAU,CAAC,GAAG,CAAC;QAE/B,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAE3B,OAAO,SAAS,CAAC;IACnB,CAAC;CACF;AA5DD,gDA4DC","sourcesContent":["import { createPublicKey } from 'node:crypto';\nimport type { KeyObject } from 'node:crypto';\nimport { exportJWK, generateKeyPair, importJWK } from 'jose';\nimport type { AsymmetricSigningAlgorithm, JWKS } from '../../../templates/types/oidc-provider';\nimport type { KeyValueStorage } from '../../storage/keyvalue/KeyValueStorage';\nimport type { AlgJwk, JwkGenerator } from './JwkGenerator';\n\n/**\n * Generates a key pair once and then caches it using both an internal variable and a {@link KeyValueStorage}.\n * The storage makes sure the keys remain the same between server restarts,\n * while the internal variable makes it so the storage doesn't have to be accessed every time a key is needed.\n *\n * Only the private key is stored in the internal storage, using the `storageKey` parameter.\n * The public key is determined based on the private key and then also stored in memory.\n */\nexport class CachedJwkGenerator implements JwkGenerator {\n  public readonly alg: AsymmetricSigningAlgorithm;\n\n  private readonly key: string;\n  private readonly storage: KeyValueStorage<string, JWKS>;\n\n  private privateJwk?: AlgJwk;\n  private publicJwk?: AlgJwk;\n\n  public constructor(alg: AsymmetricSigningAlgorithm, storageKey: string, storage: KeyValueStorage<string, JWKS>) {\n    this.alg = alg;\n    this.key = storageKey;\n    this.storage = storage;\n  }\n\n  public async getPrivateKey(): Promise<AlgJwk> {\n    if (this.privateJwk) {\n      return this.privateJwk;\n    }\n\n    // We store in JWKS format for backwards compatibility reasons.\n    // If we want to just store the key instead we will need some way to do the migration.\n    const jwks = await this.storage.get(this.key);\n    if (jwks) {\n      this.privateJwk = jwks.keys[0] as AlgJwk;\n      return this.privateJwk;\n    }\n\n    const { privateKey } = await generateKeyPair(this.alg);\n\n    // Make sure the JWK is a plain node object for storage\n    const privateJwk = { ...await exportJWK(privateKey) } as AlgJwk;\n    privateJwk.alg = this.alg;\n\n    await this.storage.set(this.key, { keys: [ privateJwk ]});\n    this.privateJwk = privateJwk;\n    return privateJwk;\n  }\n\n  public async getPublicKey(): Promise<AlgJwk> {\n    if (this.publicJwk) {\n      return this.publicJwk;\n    }\n\n    const privateJwk = await this.getPrivateKey();\n\n    // The main reason we generate the public key from the private key is, so we don't have to store it.\n    // This allows our storage to not break previous versions where we only used the private key.\n    // In practice this results in the same key.\n    const privateKey = await importJWK(privateJwk);\n    const publicKey = createPublicKey(privateKey as KeyObject);\n\n    const publicJwk = { ...await exportJWK(publicKey) } as AlgJwk;\n    // These fields get lost during the above proces\n    publicJwk.alg = privateJwk.alg;\n\n    this.publicJwk = publicJwk;\n\n    return publicJwk;\n  }\n}\n"]}