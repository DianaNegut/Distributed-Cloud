{"version":3,"file":"IdentityProviderFactory.js","sourceRoot":"","sources":["../../../src/identity/configuration/IdentityProviderFactory.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable ts/naming-convention */\nimport { randomBytes } from 'node:crypto';\nimport type {\n  Account,\n  Adapter,\n  AsymmetricSigningAlgorithm,\n  Configuration,\n  ErrorOut,\n  errors,\n  KoaContextWithOIDC,\n  ResourceServer,\n  UnknownObject,\n} from '../../../templates/types/oidc-provider';\nimport type Provider from '../../../templates/types/oidc-provider';\nimport type { ErrorHandler } from '../../http/output/error/ErrorHandler';\nimport type { ResponseWriter } from '../../http/output/ResponseWriter';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport type { KeyValueStorage } from '../../storage/keyvalue/KeyValueStorage';\nimport { BadRequestHttpError } from '../../util/errors/BadRequestHttpError';\nimport type { HttpError } from '../../util/errors/HttpError';\nimport { errorTermsToMetadata } from '../../util/errors/HttpErrorUtil';\nimport { OAuthHttpError } from '../../util/errors/OAuthHttpError';\nimport { guardStream } from '../../util/GuardedStream';\nimport { joinUrl } from '../../util/PathUtil';\nimport { importOidcProvider } from '../IdentityUtil';\nimport type { ClientCredentialsStore } from '../interaction/client-credentials/util/ClientCredentialsStore';\nimport type { InteractionRoute } from '../interaction/routing/InteractionRoute';\nimport type { AdapterFactory } from '../storage/AdapterFactory';\nimport type { AlgJwk, JwkGenerator } from './JwkGenerator';\nimport type { PromptFactory } from './PromptFactory';\nimport type { ProviderFactory } from './ProviderFactory';\n\nexport interface IdentityProviderFactoryArgs {\n  /**\n   * Used to generate new prompt that are needed in addition to the defaults prompts.\n   */\n  promptFactory: PromptFactory;\n  /**\n   * Factory that creates the adapter used for OIDC data storage.\n   */\n  adapterFactory: AdapterFactory;\n  /**\n   * Base URL of the server.\n   */\n  baseUrl: string;\n  /**\n   * Path for all requests targeting the OIDC library.\n   */\n  oidcPath: string;\n  /**\n   * The route where requests should be redirected to in case of an OIDC interaction.\n   */\n  interactionRoute: InteractionRoute;\n  /**\n   * Store containing the generated client credentials with their associated WebID.\n   */\n  clientCredentialsStore: ClientCredentialsStore;\n  /**\n   * Storage used to store cookie keys, so they can be re-used in case of multithreading.\n   */\n  storage: KeyValueStorage<string, string[]>;\n  /**\n   * Generates the JWK used for signing and decryption.\n   */\n  jwkGenerator: JwkGenerator;\n  /**\n   * Extra information will be added to the error output if this is true.\n   */\n  showStackTrace: boolean;\n  /**\n   * Used to convert errors thrown by the OIDC library.\n   */\n  errorHandler: ErrorHandler;\n  /**\n   * Used to write out errors thrown by the OIDC library.\n   */\n  responseWriter: ResponseWriter;\n}\n\nconst COOKIES_KEY = 'cookie-secret';\n\n/**\n * Creates an OIDC Provider based on the provided configuration and parameters.\n * The provider will be cached and returned on subsequent calls.\n * Cookie and JWT keys will be stored in an internal storage, so they can be re-used over multiple threads.\n * Necessary claims for Solid OIDC interactions will be added.\n * Routes will be updated based on the `baseUrl` and `oidcPath`.\n */\nexport class IdentityProviderFactory implements ProviderFactory {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly promptFactory: PromptFactory;\n  private readonly config: Configuration;\n  private readonly adapterFactory: AdapterFactory;\n  private readonly baseUrl: string;\n  private readonly oidcPath: string;\n  private readonly interactionRoute: InteractionRoute;\n  private readonly clientCredentialsStore: ClientCredentialsStore;\n  private readonly storage: KeyValueStorage<string, string[]>;\n  private readonly jwkGenerator: JwkGenerator;\n  private readonly showStackTrace: boolean;\n  private readonly errorHandler: ErrorHandler;\n  private readonly responseWriter: ResponseWriter;\n\n  private provider?: Provider;\n\n  /**\n   * @param config - JSON config for the OIDC library @range {json}\n   * @param args - Remaining parameters required for the factory.\n   */\n  public constructor(config: Configuration, args: IdentityProviderFactoryArgs) {\n    this.config = config;\n\n    this.promptFactory = args.promptFactory;\n    this.adapterFactory = args.adapterFactory;\n    this.baseUrl = args.baseUrl;\n    this.oidcPath = args.oidcPath;\n    this.interactionRoute = args.interactionRoute;\n    this.clientCredentialsStore = args.clientCredentialsStore;\n    this.storage = args.storage;\n    this.jwkGenerator = args.jwkGenerator;\n    this.showStackTrace = args.showStackTrace;\n    this.errorHandler = args.errorHandler;\n    this.responseWriter = args.responseWriter;\n  }\n\n  public async getProvider(): Promise<Provider> {\n    if (this.provider) {\n      return this.provider;\n    }\n    this.provider = await this.createProvider();\n    return this.provider;\n  }\n\n  /**\n   * Creates a Provider by building a Configuration using all the stored parameters.\n   */\n  private async createProvider(): Promise<Provider> {\n    const key = await this.jwkGenerator.getPrivateKey();\n\n    const config = await this.initConfig(key);\n\n    // Add correct claims to IdToken/AccessToken responses\n    this.configureClaims(config, key.alg);\n\n    // Make sure routes are contained in the IDP space\n    this.configureRoutes(config);\n\n    // Render errors with our own error handler\n    this.configureErrors(config);\n\n    const oidcImport = await importOidcProvider();\n\n    // Adds new prompts\n    const policy = oidcImport.interactionPolicy.base();\n    await this.promptFactory.handleSafe(policy);\n    config.interactions!.policy = policy;\n\n    // eslint-disable-next-line new-cap\n    const provider = new oidcImport.default(this.baseUrl, config);\n\n    // Allow provider to interpret reverse proxy headers.\n    provider.proxy = true;\n\n    this.captureErrorResponses(provider);\n\n    return provider;\n  }\n\n  /**\n   * In the `configureErrors` function below, we configure the `renderError` function of the provider configuration.\n   * This function is called by the OIDC provider library to render errors,\n   * but only does this if the accept header is HTML.\n   * Otherwise, it just returns the error object itself as a JSON object.\n   * See https://github.com/panva/node-oidc-provider/blob/0fcc112e0a95b3b2dae4eba6da812253277567c9/lib/shared/error_handler.js#L48-L52.\n   *\n   * In this function we override the `ctx.accepts` function\n   * to make the above code think HTML is always requested there.\n   * This way we have full control over error representation as configured in `configureErrors`.\n   * We still check the accept headers ourselves so there still is content negotiation on the output,\n   * the client will not simply always receive HTML.\n   *\n   * Should this part of the OIDC library code ever change, our function will break,\n   * at which point behaviour will simply revert to what it was before.\n   */\n  private captureErrorResponses(provider: Provider): void {\n    provider.use(async(ctx, next): Promise<void> => {\n      const accepts = ctx.accepts.bind(ctx);\n\n      // This is how you get the correct typing for an overloaded function\n      type AcceptFn = {\n        (): string[];\n        (...types: string[]): string | false;\n        (types: string[]): string | false;\n      };\n\n      ctx.accepts = ((...types): string[] | string | false => {\n        // Make sure we only override our specific case\n        if (types.length === 2 && types[0] === 'json' && types[1] === 'html') {\n          return 'html';\n        }\n        return accepts(...types as string[]);\n      }) as AcceptFn;\n\n      return next();\n    });\n  }\n\n  /**\n   * Creates a configuration by copying the internal configuration\n   * and adding the adapter, default audience and jwks/cookie keys.\n   */\n  private async initConfig(key: AlgJwk): Promise<Configuration> {\n    // Create a deep copy\n    const config = JSON.parse(JSON.stringify(this.config)) as Configuration;\n\n    // Indicates which Adapter should be used for storing oidc data\n    // The adapter function MUST be a named function.\n    // See https://github.com/panva/node-oidc-provider/issues/799\n    const factory = this.adapterFactory;\n    config.adapter = function loadAdapter(name: string): Adapter {\n      return factory.createStorageAdapter(name);\n    };\n\n    config.jwks = { keys: [ key ]};\n    config.cookies = {\n      ...config.cookies,\n      keys: await this.generateCookieKeys(),\n    };\n\n    // Solid OIDC requires pkce https://solid.github.io/solid-oidc/#concepts\n    config.pkce = {\n      methods: [ 'S256' ],\n      required: (): true => true,\n    };\n\n    // Default client settings that might not be defined.\n    // Mostly relevant for WebID clients.\n    config.clientDefaults = {\n      id_token_signed_response_alg: key.alg,\n    };\n\n    return config;\n  }\n\n  /**\n   * Generates a cookie secret to be used for cookie signing.\n   * The key will be cached so subsequent calls return the same key.\n   */\n  private async generateCookieKeys(): Promise<string[]> {\n    // Check to see if the keys are already saved\n    const cookieSecret = await this.storage.get(COOKIES_KEY);\n    if (Array.isArray(cookieSecret)) {\n      return cookieSecret;\n    }\n    // If they are not, generate and save them\n    const newCookieSecret = [ randomBytes(64).toString('hex') ];\n    await this.storage.set(COOKIES_KEY, newCookieSecret);\n    return newCookieSecret;\n  }\n\n  /**\n   * Checks whether the given token is an access token.\n   * The AccessToken interface is not exported, so we have to access it like this.\n   */\n  private isAccessToken(token: unknown): token is KoaContextWithOIDC['oidc']['accessToken'] {\n    return (token as KoaContextWithOIDC['oidc']['accessToken'])?.kind === 'AccessToken';\n  }\n\n  /**\n   * Adds the necessary claims to the id and access tokens based on the Solid OIDC spec.\n   */\n  private configureClaims(config: Configuration, jwtAlg: AsymmetricSigningAlgorithm): void {\n    // Returns the id_token\n    // See https://solid.github.io/authentication-panel/solid-oidc/#tokens-id\n    // Some fields are still missing, see https://github.com/CommunitySolidServer/CommunitySolidServer/issues/1154#issuecomment-1040233385\n    config.findAccount = async(ctx: KoaContextWithOIDC, sub: string): Promise<Account> => ({\n      accountId: sub,\n      async claims(): Promise<{ sub: string; [key: string]: unknown }> {\n        return { sub, webid: sub, azp: ctx.oidc.client?.clientId };\n      },\n    });\n\n    // Add extra claims in case an AccessToken is being issued.\n    // Specifically this sets the required webid and client_id claims for the access token\n    // See https://solid.github.io/solid-oidc/#resource-access-validation\n    config.extraTokenClaims = async(ctx, token): Promise<UnknownObject> => {\n      if (this.isAccessToken(token)) {\n        return { webid: token.accountId };\n      }\n      const clientId = token.client?.clientId;\n      if (!clientId) {\n        throw new BadRequestHttpError('Missing client ID from client credentials.');\n      }\n      const webId = (await this.clientCredentialsStore.findByLabel(clientId))?.webId;\n      if (!webId) {\n        throw new BadRequestHttpError(`Unknown client credentials token ${clientId}`);\n      }\n      return { webid: webId };\n    };\n\n    config.features = {\n      ...config.features,\n      resourceIndicators: {\n        defaultResource(): string {\n          // This value is irrelevant, but is necessary to trigger the `getResourceServerInfo` call below,\n          // where it will be an input parameter in case the client provided no value.\n          // Note that an empty string is not a valid value.\n          return 'http://example.com/';\n        },\n        enabled: true,\n        // This call is necessary to force the OIDC library to return a JWT access token.\n        // See https://github.com/panva/node-oidc-provider/discussions/959#discussioncomment-524757\n        getResourceServerInfo: (): ResourceServer => ({\n          // The scopes of the Resource Server.\n          // These get checked when requesting client credentials.\n          scope: '',\n          audience: 'solid',\n          accessTokenFormat: 'jwt',\n          jwt: {\n            sign: { alg: jwtAlg },\n          },\n        }),\n      },\n    };\n  }\n\n  /**\n   * Creates the route string as required by the `oidc-provider` library.\n   * In case base URL is `http://test.com/foo/`, `oidcPath` is `/idp` and `relative` is `device/auth`,\n   * this would result in `/foo/idp/device/auth`.\n   */\n  private createRoute(relative: string): string {\n    return new URL(joinUrl(this.baseUrl, this.oidcPath, relative)).pathname;\n  }\n\n  /**\n   * Sets up all the IDP routes relative to the IDP path.\n   */\n  private configureRoutes(config: Configuration): void {\n    // When oidc-provider cannot fulfill the authorization request for any of the possible reasons\n    // (missing user session, requested ACR not fulfilled, prompt requested, ...)\n    // it will resolve the interactions.url helper function and redirect the User-Agent to that url.\n    // Another requirement is that `features.userinfo` is disabled in the configuration.\n    config.interactions = {\n      url: async(): Promise<string> => this.interactionRoute.getPath(),\n    };\n\n    config.routes = {\n      authorization: this.createRoute('auth'),\n      backchannel_authentication: this.createRoute('backchannel'),\n      code_verification: this.createRoute('device'),\n      device_authorization: this.createRoute('device/auth'),\n      end_session: this.createRoute('session/end'),\n      introspection: this.createRoute('token/introspection'),\n      jwks: this.createRoute('jwks'),\n      pushed_authorization_request: this.createRoute('request'),\n      registration: this.createRoute('reg'),\n      revocation: this.createRoute('token/revocation'),\n      token: this.createRoute('token'),\n      userinfo: this.createRoute('me'),\n    };\n  }\n\n  /**\n   * Pipes library errors to the provided ErrorHandler and ResponseWriter.\n   */\n  private configureErrors(config: Configuration): void {\n    config.renderError = async(ctx: KoaContextWithOIDC, out: ErrorOut, error: errors.OIDCProviderError | Error):\n    Promise<void> => {\n      // This allows us to stream directly to the response object, see https://github.com/koajs/koa/issues/944\n      ctx.respond = false;\n\n      // Doesn't really matter which type it is since all relevant fields are optional\n      const oidcError = error as errors.OIDCProviderError;\n\n      // Create a more detailed error message for logging and to show is `showStackTrace` is enabled.\n      let detailedError = oidcError.message;\n      if (oidcError.error_description) {\n        detailedError += ` - ${oidcError.error_description}`;\n      }\n      if (oidcError.error_detail) {\n        detailedError += ` - ${oidcError.error_detail}`;\n      }\n\n      this.logger.warn(`OIDC request failed: ${detailedError}`);\n\n      // Convert to our own error object.\n      // This ensures serializing the error object will generate the correct output later on.\n      // We specifically copy the fields instead of passing the object to contain the `oidc-provider` dependency\n      // to the current file.\n      let resultingError: HttpError = new OAuthHttpError(out, oidcError.name, oidcError.statusCode, oidcError.message);\n      // Keep the original stack to make debugging easier\n      resultingError.stack = oidcError.stack;\n\n      if (this.showStackTrace) {\n        // Expose more information if `showStackTrace` is enabled\n        resultingError.message = detailedError;\n\n        // Also change the error message in the stack trace\n        if (resultingError.stack) {\n          resultingError.stack = resultingError.stack.replace(/.*/u, `${oidcError.name}: ${oidcError.message}`);\n        }\n      }\n\n      // A client not being found is quite often the result of cookies being stored by the authn client,\n      // so we want to provide a more detailed error message explaining what to do.\n      if (oidcError.error_description === 'client is invalid' && oidcError.error_detail === 'client not found') {\n        const unknownClientError = new BadRequestHttpError(\n          'Unknown client, you might need to clear the local storage on the client.',\n          {\n            errorCode: 'E0003',\n            metadata: errorTermsToMetadata({\n              client_id: ctx.request.query.client_id as string,\n              redirect_uri: ctx.request.query.redirect_uri as string,\n            }),\n          },\n        );\n        unknownClientError.stack = oidcError.stack;\n        resultingError = unknownClientError;\n      }\n\n      const result = await this.errorHandler.handleSafe({ error: resultingError, request: guardStream(ctx.req) });\n      await this.responseWriter.handleSafe({ response: ctx.res, result });\n    };\n  }\n}\n"]}