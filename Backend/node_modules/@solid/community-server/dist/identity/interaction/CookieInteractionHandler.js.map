{"version":3,"file":"CookieInteractionHandler.js","sourceRoot":"","sources":["../../../src/identity/interaction/CookieInteractionHandler.ts"],"names":[],"mappings":";;;AAAA,6FAA0F;AAC1F,0DAAqD;AACrD,8DAA8E;AAK9E,qEAAkE;AAElE;;;;;;GAMG;AACH,MAAa,wBAAyB,SAAQ,+CAAsB;IACjD,MAAM,CAAyB;IAC/B,YAAY,CAAe;IAC3B,WAAW,CAAc;IAE1C,YAAmB,MAA8B,EAAE,YAA0B,EAAE,WAAwB;QACrG,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;IACjC,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAAkC;QACvD,OAAO,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACtC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAkC;QACpD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE/C,IAAI,EAAE,QAAQ,EAAE,cAAc,EAAE,GAAG,MAAM,CAAC;QAE1C,oGAAoG;QACpG,MAAM,MAAM,GAAG,cAAc,EAAE,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK;YACvE,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,CAAC;QAC5D,qEAAqE;QACrE,6DAA6D;QAC7D,IAAI,CAAC,MAAM,IAAI,cAAc,EAAE,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,uBAAuB,CAAC,EAAE,CAAC;YAC7E,OAAO,MAAM,CAAC;QAChB,CAAC;QACD,6CAA6C;QAC7C,yFAAyF;QACzF,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QAErD,4FAA4F;QAC5F,IAAI,CAAC,SAAS,EAAE,CAAC;YACf,OAAO,MAAM,CAAC;QAChB,CAAC;QACD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,UAAU,CAAC,SAAS,EAAE,8CAA+B,CAAC,CAAC;QAC/F,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO,MAAM,CAAC;QAChB,CAAC;QAED,4EAA4E;QAC5E,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,UAAU,EAAE,CAAC;YACf,cAAc,GAAG,cAAc,IAAI,IAAI,+CAAsB,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAC5E,cAAc,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC;YAC3D,cAAc,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,uBAAuB,EAAE,UAAU,CAAC,WAAW,EAAE,CAAC,CAAC;YACvF,MAAM,CAAC,QAAQ,GAAG,cAAc,CAAC;QACnC,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;CACF;AArDD,4DAqDC","sourcesContent":["import { RepresentationMetadata } from '../../http/representation/RepresentationMetadata';\nimport { SOLID_HTTP } from '../../util/Vocabularies';\nimport { ACCOUNT_SETTINGS_REMEMBER_LOGIN } from './account/util/AccountStore';\nimport type { AccountStore } from './account/util/AccountStore';\nimport type { CookieStore } from './account/util/CookieStore';\nimport type { JsonRepresentation } from './InteractionUtil';\nimport type { JsonInteractionHandlerInput } from './JsonInteractionHandler';\nimport { JsonInteractionHandler } from './JsonInteractionHandler';\n\n/**\n * Handles all the necessary steps for having cookies.\n * Refreshes the cookie expiration if there was a successful account interaction.\n * Adds the cookie and cookie expiration data to the output metadata,\n * unless it is already present in that metadata.\n * Checks the account settings to see if the cookie needs to be remembered.\n */\nexport class CookieInteractionHandler extends JsonInteractionHandler {\n  private readonly source: JsonInteractionHandler;\n  private readonly accountStore: AccountStore;\n  private readonly cookieStore: CookieStore;\n\n  public constructor(source: JsonInteractionHandler, accountStore: AccountStore, cookieStore: CookieStore) {\n    super();\n    this.source = source;\n    this.accountStore = accountStore;\n    this.cookieStore = cookieStore;\n  }\n\n  public async canHandle(input: JsonInteractionHandlerInput): Promise<void> {\n    return this.source.canHandle(input);\n  }\n\n  public async handle(input: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    const output = await this.source.handle(input);\n\n    let { metadata: outputMetadata } = output;\n\n    // The cookie could be new, in the output, or the one received in the input if no new cookie is made\n    const cookie = outputMetadata?.get(SOLID_HTTP.terms.accountCookie)?.value ??\n      input.metadata.get(SOLID_HTTP.terms.accountCookie)?.value;\n    // Only update the expiration if it wasn't set by the source handler,\n    // as that might have a specific reason, such as logging out.\n    if (!cookie || outputMetadata?.has(SOLID_HTTP.terms.accountCookieExpiration)) {\n      return output;\n    }\n    // Not reusing the account ID from the input,\n    // as that could potentially belong to a different account if this is a new login action.\n    const accountId = await this.cookieStore.get(cookie);\n\n    // Only refresh the cookie if it points to an account that exists and wants to be remembered\n    if (!accountId) {\n      return output;\n    }\n    const setting = await this.accountStore.getSetting(accountId, ACCOUNT_SETTINGS_REMEMBER_LOGIN);\n    if (!setting) {\n      return output;\n    }\n\n    // Refresh the cookie, could be undefined if it was deleted by the operation\n    const expiration = await this.cookieStore.refresh(cookie);\n    if (expiration) {\n      outputMetadata = outputMetadata ?? new RepresentationMetadata(input.target);\n      outputMetadata.set(SOLID_HTTP.terms.accountCookie, cookie);\n      outputMetadata.set(SOLID_HTTP.terms.accountCookieExpiration, expiration.toISOString());\n      output.metadata = outputMetadata;\n    }\n\n    return output;\n  }\n}\n"]}