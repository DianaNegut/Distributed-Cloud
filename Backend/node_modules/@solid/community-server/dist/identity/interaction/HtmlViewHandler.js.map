{"version":3,"file":"HtmlViewHandler.js","sourceRoot":"","sources":["../../../src/identity/interaction/HtmlViewHandler.ts"],"names":[],"mappings":";;;AAAA,uFAAoF;AAEpF,4EAA0F;AAC1F,0DAAsE;AACtE,2FAAwF;AACxF,2EAAwE;AACxE,uFAAoF;AAGpF,6DAA0D;AAG1D;;;;;GAKG;AACH,MAAa,aAAa;IAEN;IACA;IAFlB,YACkB,KAAuB,EACvB,QAAgB;QADhB,UAAK,GAAL,KAAK,CAAkB;QACvB,aAAQ,GAAR,QAAQ,CAAQ;IAC/B,CAAC;CACL;AALD,sCAKC;AAED;;;;;;;;;;GAUG;AACH,MAAa,eAAgB,SAAQ,uCAAkB;IACpC,QAAQ,CAAS;IACjB,cAAc,CAAiB;IAC/B,SAAS,CAAkB;IAE5C,YAAmB,KAAuB,EAAE,cAA8B,EAAE,SAA0B;QACpG,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,OAAO,EAAE,CAAC;QAChC,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;QACrC,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC7B,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,EAAE,SAAS,EAA2B;QAC3D,IAAI,SAAS,CAAC,MAAM,KAAK,KAAK,EAAE,CAAC;YAC/B,MAAM,IAAI,qDAAyB,CAAC,CAAE,SAAS,CAAC,MAAM,CAAE,CAAC,CAAC;QAC5D,CAAC;QAED,MAAM,WAAW,GAAG,IAAA,iCAAgB,EAAC,SAAS,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QACjE,MAAM,UAAU,GAAG,IAAA,8BAAa,EAAC,wBAAS,EAAE,WAAW,CAAC,CAAC;QACzD,MAAM,UAAU,GAAG,IAAA,8BAAa,EAAC,+BAAgB,EAAE,WAAW,CAAC,CAAC;QAChE,IAAI,UAAU,IAAI,UAAU,EAAE,CAAC;YAC7B,MAAM,IAAI,iDAAuB,CAAC,uDAAuD,CAAC,CAAC;QAC7F,CAAC;QAED,wCAAwC;QACxC,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IAC3C,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,eAAe,EAA2B;QACzE,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAC1D,MAAM,QAAQ,GAAG,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,EAAE,cAAc,EAAE,OAAO,CAAC,eAAe,CAAC,EAAE,CAAC;QACvF,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE,YAAY,EAAE,QAAQ,EAAE,EAAC,CAAC,CAAC;QACvG,OAAO,IAAI,yCAAmB,CAAC,MAAM,EAAE,SAAS,CAAC,MAAM,EAAE,wBAAS,CAAC,CAAC;IACtE,CAAC;IAED;;OAEG;IACK,YAAY,CAAC,MAAc;QACjC,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACtC,IAAI,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC;gBACrC,OAAO,QAAQ,CAAC,QAAQ,CAAC;YAC3B,CAAC;QACH,CAAC;QACD,MAAM,IAAI,qCAAiB,EAAE,CAAC;IAChC,CAAC;CACF;AA9CD,0CA8CC","sourcesContent":["import { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { Representation } from '../../http/representation/Representation';\nimport { cleanPreferences, getTypeWeight } from '../../storage/conversion/ConversionUtil';\nimport { APPLICATION_JSON, TEXT_HTML } from '../../util/ContentTypes';\nimport { MethodNotAllowedHttpError } from '../../util/errors/MethodNotAllowedHttpError';\nimport { NotFoundHttpError } from '../../util/errors/NotFoundHttpError';\nimport { NotImplementedHttpError } from '../../util/errors/NotImplementedHttpError';\nimport type { TemplateEngine } from '../../util/templates/TemplateEngine';\nimport type { InteractionHandlerInput } from './InteractionHandler';\nimport { InteractionHandler } from './InteractionHandler';\nimport type { InteractionRoute } from './routing/InteractionRoute';\n\n/**\n * Used to link file paths and URLs together.\n * The reason we use a separate object instead of a key/value Record,\n * is that this makes it easier to override the values in Components.js,\n * which can be useful if someone wants to replace the HTML for certain URLs.\n */\nexport class HtmlViewEntry {\n  public constructor(\n    public readonly route: InteractionRoute,\n    public readonly filePath: string,\n  ) {}\n}\n\n/**\n * Stores the HTML templates associated with specific InteractionRoutes.\n *\n * This class will only handle GET operations for which there is a matching template,\n * if HTML is more preferred than JSON.\n * The reason for doing it like this instead of a standard content negotiation flow,\n * is because we only want to return the HTML pages on GET requests.\n *\n * Templates will receive the parameter `idpIndex` in their context pointing to the root index URL of the IDP API\n * and an `authenticating` parameter indicating if this is an active OIDC interaction.\n */\nexport class HtmlViewHandler extends InteractionHandler {\n  private readonly idpIndex: string;\n  private readonly templateEngine: TemplateEngine;\n  private readonly templates: HtmlViewEntry[];\n\n  public constructor(index: InteractionRoute, templateEngine: TemplateEngine, templates: HtmlViewEntry[]) {\n    super();\n    this.idpIndex = index.getPath();\n    this.templateEngine = templateEngine;\n    this.templates = templates;\n  }\n\n  public async canHandle({ operation }: InteractionHandlerInput): Promise<void> {\n    if (operation.method !== 'GET') {\n      throw new MethodNotAllowedHttpError([ operation.method ]);\n    }\n\n    const preferences = cleanPreferences(operation.preferences.type);\n    const htmlWeight = getTypeWeight(TEXT_HTML, preferences);\n    const jsonWeight = getTypeWeight(APPLICATION_JSON, preferences);\n    if (jsonWeight >= htmlWeight) {\n      throw new NotImplementedHttpError('HTML views are only returned when they are preferred.');\n    }\n\n    // Will throw error if no match is found\n    this.findTemplate(operation.target.path);\n  }\n\n  public async handle({ operation, oidcInteraction }: InteractionHandlerInput): Promise<Representation> {\n    const template = this.findTemplate(operation.target.path);\n    const contents = { idpIndex: this.idpIndex, authenticating: Boolean(oidcInteraction) };\n    const result = await this.templateEngine.handleSafe({ contents, template: { templateFile: template }});\n    return new BasicRepresentation(result, operation.target, TEXT_HTML);\n  }\n\n  /**\n   * Finds the template for the given URL.\n   */\n  private findTemplate(target: string): string {\n    for (const template of this.templates) {\n      if (template.route.matchPath(target)) {\n        return template.filePath;\n      }\n    }\n    throw new NotFoundHttpError();\n  }\n}\n"]}