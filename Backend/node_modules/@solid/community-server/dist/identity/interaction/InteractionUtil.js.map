{"version":3,"file":"InteractionUtil.js","sourceRoot":"","sources":["../../../src/identity/interaction/InteractionUtil.ts"],"names":[],"mappings":";;;AA4BA,sDAQC;AAoBD,8CAaC;AAUD,kCAeC;AA3FD,mDAAqD;AACrD,+EAA4E;AAK5E,MAAM,MAAM,GAAG,IAAA,sBAAY,EAAC,aAAa,CAAC,CAAC;AAY3C;;;;;;GAMG;AACH,SAAgB,qBAAqB,CAAC,eAA6B;IACjE,IAAI,CAAC,eAAe,EAAE,CAAC;QACrB,MAAM,CAAC,IAAI,CAAC,+EAA+E,CAAC,CAAC;QAC7F,MAAM,IAAI,yCAAmB,CAC3B,2EAA2E,EAC3E,EAAE,SAAS,EAAE,OAAO,EAAE,CACvB,CAAC;IACJ,CAAC;AACH,CAAC;AAED;;;;GAIG;AACU,QAAA,cAAc,GAAG,SAAS,CAAC;AAMxC;;;;;;GAMG;AACI,KAAK,UAAU,iBAAiB,CACrC,eAA4B,EAC5B,MAAiC,EACjC,uBAAgC;IAEhC,IAAI,uBAAuB,EAAE,CAAC;QAC5B,MAAM,GAAG,EAAE,GAAG,eAAe,CAAC,cAAc,EAAE,GAAG,MAAM,EAAE,CAAC;IAC5D,CAAC;IAED,eAAe,CAAC,MAAM,GAAG,MAAM,CAAC;IAChC,MAAM,eAAe,CAAC,OAAO,EAAE,CAAC;IAEhC,OAAO,eAAe,CAAC,QAAQ,CAAC;AAClC,CAAC;AAED;;;;;;;GAOG;AACI,KAAK,UAAU,WAAW,CAAC,QAAkB,EAAE,eAA4B;IAChF,IAAI,eAAe,CAAC,OAAO,EAAE,CAAC;QAC5B,MAAM,OAAO,GAAG,CAAC,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,CAAC,CAAE,CAAC;QAC/E,MAAM,CAAC,KAAK,CAAC,oBAAoB,OAAO,CAAC,SAAS,oBAAoB,CAAC,CAAC;QACxE,OAAO,OAAO,CAAC,SAAS,CAAC;QACzB,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IAED,gGAAgG;IAChG,iFAAiF;IACjF,gGAAgG;IAChG,IAAI,eAAe,CAAC,OAAO,EAAE,CAAC;QAC5B,MAAM,KAAK,GAAG,MAAM,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QACjE,MAAM,KAAK,EAAE,OAAO,EAAE,CAAC;IACzB,CAAC;AACH,CAAC","sourcesContent":["import type { InteractionResults } from '../../../templates/types/oidc-provider';\nimport type Provider from '../../../templates/types/oidc-provider';\nimport type { RepresentationMetadata } from '../../http/representation/RepresentationMetadata';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../util/errors/BadRequestHttpError';\nimport type { Json } from '../../util/Json';\nimport type { Interaction } from './InteractionHandler';\nimport Dict = NodeJS.Dict;\n\nconst logger = getLoggerFor('AccountUtil');\n\n/**\n * Contains a JSON object and any associated metadata.\n * Similar to a {@link Representation} but with all the data in memory instead of as a stream\n * and specific to JSON.\n */\nexport interface JsonRepresentation<T extends Dict<Json> = Dict<Json>> {\n  json: T;\n  metadata?: RepresentationMetadata;\n}\n\n/**\n * Asserts `oidcInteraction` is defined, throws the correct error in case this is not the case.\n * The error contains the relevant error code that can be used to explain more extensively what the issue is\n * and why an OIDC interaction is needed.\n *\n * @param oidcInteraction - Interaction object to check.\n */\nexport function assertOidcInteraction(oidcInteraction?: Interaction): asserts oidcInteraction is Interaction {\n  if (!oidcInteraction) {\n    logger.warn(`Trying to perform OIDC operation without being in an OIDC authentication flow`);\n    throw new BadRequestHttpError(\n      'This action can only be performed as part of an OIDC authentication flow.',\n      { errorCode: 'E0002' },\n    );\n  }\n}\n\n/**\n * The prompt that is used to track the account ID of a user during an OIDC interaction.\n * The already existing `login` prompt in the {@link InteractionResults}\n * is used to track the WebID that is chosen in an OIDC interaction.\n */\nexport const ACCOUNT_PROMPT = 'account';\n/**\n * {@link InteractionResults} extended with our custom key for tracking a user's account ID.\n */\nexport type AccountInteractionResults = { [ACCOUNT_PROMPT]?: string } & InteractionResults;\n\n/**\n * Updates the `oidcInteraction` object with the necessary data in case a prompt gets updated.\n *\n * @param oidcInteraction - Interaction to update.\n * @param result - New data to add to the interaction.\n * @param mergeWithLastSubmission - If this new data needs to be merged with already existing data in the interaction.\n */\nexport async function finishInteraction(\n  oidcInteraction: Interaction,\n  result: AccountInteractionResults,\n  mergeWithLastSubmission: boolean,\n): Promise<string> {\n  if (mergeWithLastSubmission) {\n    result = { ...oidcInteraction.lastSubmission, ...result };\n  }\n\n  oidcInteraction.result = result;\n  await oidcInteraction.persist();\n\n  return oidcInteraction.returnTo;\n}\n\n/**\n * Removes the WebID, the `accountId`, from the OIDC session object,\n * allowing us to replace it with a new value.\n * If there is no session in the Interaction, nothing will happen.\n *\n * @param provider - The OIDC provider.\n * @param oidcInteraction - The current interaction.\n */\nexport async function forgetWebId(provider: Provider, oidcInteraction: Interaction): Promise<void> {\n  if (oidcInteraction.session) {\n    const session = (await provider.Session.find(oidcInteraction.session.cookie))!;\n    logger.debug(`Forgetting WebID ${session.accountId} in active session`);\n    delete session.accountId;\n    await session.persist();\n  }\n\n  // If a client previously successfully completed an interaction, a grant will have been created.\n  // If such a session is reused to authenticate with a different WebID, we need to\n  // first delete the previously created grant, as the oidc-provider will try to reuse it as well.\n  if (oidcInteraction.grantId) {\n    const grant = await provider.Grant.find(oidcInteraction.grantId);\n    await grant?.destroy();\n  }\n}\n"]}