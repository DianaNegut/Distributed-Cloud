{"version":3,"file":"JsonConversionHandler.js","sourceRoot":"","sources":["../../../src/identity/interaction/JsonConversionHandler.ts"],"names":[],"mappings":";;;AAAA,uFAAoF;AAEpF,6FAA0F;AAE1F,0DAA2D;AAE3D,sDAAuD;AAEvD,6DAA0D;AAG1D;;;;;;;;GAQG;AACH,MAAa,qBAAsB,SAAQ,uCAAkB;IAC1C,MAAM,CAAyB;IAC/B,SAAS,CAA0B;IAEpD,YAAmB,MAA8B,EAAE,SAAkC;QACnF,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC7B,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,EAAE,SAAS,EAA2B;QAC3D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YAC5B,MAAM,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC;gBAC7B,UAAU,EAAE,SAAS,CAAC,MAAM;gBAC5B,WAAW,EAAE,EAAE,IAAI,EAAE,EAAE,CAAC,+BAAgB,CAAC,EAAE,CAAC,EAAE,EAAC;gBAC/C,cAAc,EAAE,SAAS,CAAC,IAAI;aAC/B,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,eAAe,EAAE,SAAS,EAA2B;QACpF,IAAI,IAAI,GAAS,EAAE,CAAC;QACpB,IAAI,YAAY,GAAG,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC;QAE3C,kDAAkD;QAClD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YAC5B,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;gBAC5C,UAAU,EAAE,SAAS,CAAC,MAAM;gBAC5B,WAAW,EAAE,EAAE,IAAI,EAAE,EAAE,CAAC,+BAAgB,CAAC,EAAE,CAAC,EAAE,EAAC;gBAC/C,cAAc,EAAE,SAAS,CAAC,IAAI;aAC/B,CAAC,CAAC;YACH,IAAI,GAAG,MAAM,IAAA,2BAAc,EAAC,SAAS,CAAC,IAAI,CAAC,CAAC;YAC5C,YAAY,GAAG,SAAS,CAAC,QAAQ,CAAC;QACpC,CAAC;QAED,wBAAwB;QACxB,MAAM,KAAK,GAAgC;YACzC,MAAM,EAAE,SAAS,CAAC,MAAM;YACxB,MAAM,EAAE,SAAS,CAAC,MAAM;YACxB,QAAQ,EAAE,YAAY;YACtB,IAAI;YACJ,eAAe;YACf,SAAS;SACV,CAAC;QAEF,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;QAEnD,qDAAqD;QACrD,MAAM,gBAAgB,GAAG,MAAM,CAAC,QAAQ,IAAI,IAAI,+CAAsB,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QACzF,OAAO,IAAI,yCAAmB,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,gBAAgB,EAAE,+BAAgB,CAAC,CAAC;IAClG,CAAC;CACF;AAnDD,sDAmDC","sourcesContent":["import { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { Representation } from '../../http/representation/Representation';\nimport { RepresentationMetadata } from '../../http/representation/RepresentationMetadata';\nimport type { RepresentationConverter } from '../../storage/conversion/RepresentationConverter';\nimport { APPLICATION_JSON } from '../../util/ContentTypes';\nimport type { Json } from '../../util/Json';\nimport { readJsonStream } from '../../util/StreamUtil';\nimport type { InteractionHandlerInput } from './InteractionHandler';\nimport { InteractionHandler } from './InteractionHandler';\nimport type { JsonInteractionHandler, JsonInteractionHandlerInput } from './JsonInteractionHandler';\n\n/**\n * An {@link InteractionHandler} that sits in-between\n * an {@link InteractionHandler} and a {@link JsonInteractionHandler}.\n * It converts the input data stream into a JSON object to be used by the stored handler.\n *\n * Since the JSON body is only made during the `handle` call, it can not be used during the `canHandle`,\n * so the `canHandle` call of the stored handler is not called,\n * meaning this class accepts all input that can be converted to JSON.\n */\nexport class JsonConversionHandler extends InteractionHandler {\n  private readonly source: JsonInteractionHandler;\n  private readonly converter: RepresentationConverter;\n\n  public constructor(source: JsonInteractionHandler, converter: RepresentationConverter) {\n    super();\n    this.source = source;\n    this.converter = converter;\n  }\n\n  public async canHandle({ operation }: InteractionHandlerInput): Promise<void> {\n    if (!operation.body.isEmpty) {\n      await this.converter.canHandle({\n        identifier: operation.target,\n        preferences: { type: { [APPLICATION_JSON]: 1 }},\n        representation: operation.body,\n      });\n    }\n  }\n\n  public async handle({ operation, oidcInteraction, accountId }: InteractionHandlerInput): Promise<Representation> {\n    let json: Json = {};\n    let jsonMetadata = operation.body.metadata;\n\n    // Convert to JSON and read out if there is a body\n    if (!operation.body.isEmpty) {\n      const converted = await this.converter.handle({\n        identifier: operation.target,\n        preferences: { type: { [APPLICATION_JSON]: 1 }},\n        representation: operation.body,\n      });\n      json = await readJsonStream(converted.data);\n      jsonMetadata = converted.metadata;\n    }\n\n    // Input for the handler\n    const input: JsonInteractionHandlerInput = {\n      method: operation.method,\n      target: operation.target,\n      metadata: jsonMetadata,\n      json,\n      oidcInteraction,\n      accountId,\n    };\n\n    const result = await this.source.handleSafe(input);\n\n    // Convert the response JSON back to a Representation\n    const responseMetadata = result.metadata ?? new RepresentationMetadata(operation.target);\n    return new BasicRepresentation(JSON.stringify(result.json), responseMetadata, APPLICATION_JSON);\n  }\n}\n"]}