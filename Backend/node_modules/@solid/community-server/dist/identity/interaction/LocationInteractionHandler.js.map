{"version":3,"file":"LocationInteractionHandler.js","sourceRoot":"","sources":["../../../src/identity/interaction/LocationInteractionHandler.ts"],"names":[],"mappings":";;;AAAA,6FAA0F;AAC1F,mDAAqD;AACrD,2EAAwE;AACxE,0DAAqD;AAGrD,qEAAkE;AAElE;;;;;;;;;;;;;;;;GAgBG;AACH,MAAa,0BAA2B,SAAQ,+CAAsB;IACnD,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE5B,MAAM,CAAyB;IAEhD,YAAmB,MAA8B;QAC/C,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACvB,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAAkC;QACvD,MAAM,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACrC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAkC;QACpD,IAAI,CAAC;YACH,OAAO,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACzC,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,IAAI,qCAAiB,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC;gBACxC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,0EAA0E,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC;gBAC9G,MAAM,QAAQ,GAAG,IAAI,+CAAsB,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBAC1D,QAAQ,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;gBACxD,OAAO,EAAE,IAAI,EAAE,EAAE,QAAQ,EAAE,KAAK,CAAC,QAAQ,EAAE,EAAE,QAAQ,EAAE,CAAC;YAC1D,CAAC;YACD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF;AA3BD,gEA2BC","sourcesContent":["import { RepresentationMetadata } from '../../http/representation/RepresentationMetadata';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport { RedirectHttpError } from '../../util/errors/RedirectHttpError';\nimport { SOLID_HTTP } from '../../util/Vocabularies';\nimport type { JsonRepresentation } from './InteractionUtil';\nimport type { JsonInteractionHandlerInput } from './JsonInteractionHandler';\nimport { JsonInteractionHandler } from './JsonInteractionHandler';\n\n/**\n * Transforms an HTTP redirect into a hypermedia document with a redirection link,\n * such that scripts running in a browser can redirect the user to the next page.\n *\n * This handler addresses the situation where:\n * - the user visits a first page\n * - this first page contains a script that performs interactions with a JSON API\n * - as a result of a certain interaction, the user needs to be redirected to a second page\n *\n * Regular HTTP redirects are performed via responses with 3xx status codes.\n * However, since the consumer of the API in this case is a browser script,\n * a 3xx response would only reach that script and not move the page for the user.\n *\n * Therefore, this handler changes a 3xx response into a 200 response\n * with an explicit link to the next page,\n * enabling the script to move the user to the next page.\n */\nexport class LocationInteractionHandler extends JsonInteractionHandler {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly source: JsonInteractionHandler;\n\n  public constructor(source: JsonInteractionHandler) {\n    super();\n    this.source = source;\n  }\n\n  public async canHandle(input: JsonInteractionHandlerInput): Promise<void> {\n    await this.source.canHandle(input);\n  }\n\n  public async handle(input: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    try {\n      return await this.source.handle(input);\n    } catch (error: unknown) {\n      if (RedirectHttpError.isInstance(error)) {\n        this.logger.debug(`Converting redirect error to location field in JSON body with location ${error.location}`);\n        const metadata = new RepresentationMetadata(input.target);\n        metadata.set(SOLID_HTTP.terms.location, error.location);\n        return { json: { location: error.location }, metadata };\n      }\n      throw error;\n    }\n  }\n}\n"]}