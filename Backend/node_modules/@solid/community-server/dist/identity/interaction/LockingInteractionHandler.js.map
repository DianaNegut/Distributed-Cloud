{"version":3,"file":"LockingInteractionHandler.js","sourceRoot":"","sources":["../../../src/identity/interaction/LockingInteractionHandler.ts"],"names":[],"mappings":";;;AAIA,6DAA0D;AAE1D,MAAM,YAAY,GAAG,IAAI,GAAG,CAAC,CAAE,SAAS,EAAE,MAAM,EAAE,KAAK,CAAE,CAAC,CAAC;AAE3D;;;GAGG;AACH,MAAa,yBAA0B,SAAQ,uCAAkB;IAC9C,MAAM,CAAkB;IACxB,YAAY,CAAiB;IAC7B,MAAM,CAAqB;IAE5C,YAAmB,MAAuB,EAAE,YAA4B,EAAE,MAA0B;QAClG,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACvB,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAA8B;QACnD,OAAO,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACtC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAA8B;QAChD,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG,KAAK,CAAC;QAEvC,iCAAiC;QACjC,IAAI,CAAC,SAAS,EAAE,CAAC;YACf,OAAO,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACnC,CAAC;QAED,MAAM,UAAU,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,CAAC,EAAE,CAAC;QACtE,IAAI,YAAY,CAAC,GAAG,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC;YACvC,OAAO,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,EAAE,KAAK,IAA4B,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;QAC7G,CAAC;QAED,OAAO,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,UAAU,EAAE,KAAK,IAA4B,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;IAC9G,CAAC;CACF;AA/BD,8DA+BC","sourcesContent":["import type { Representation } from '../../http/representation/Representation';\nimport type { ReadWriteLocker } from '../../util/locking/ReadWriteLocker';\nimport type { AccountIdRoute } from './account/AccountIdRoute';\nimport type { InteractionHandlerInput } from './InteractionHandler';\nimport { InteractionHandler } from './InteractionHandler';\n\nconst READ_METHODS = new Set([ 'OPTIONS', 'HEAD', 'GET' ]);\n\n/**\n * An {@link InteractionHandler} that locks the path generated with the stored route during an operation.\n * If the route is the base account route, this can be used to prevent multiple operations on the same account.\n */\nexport class LockingInteractionHandler extends InteractionHandler {\n  private readonly locker: ReadWriteLocker;\n  private readonly accountRoute: AccountIdRoute;\n  private readonly source: InteractionHandler;\n\n  public constructor(locker: ReadWriteLocker, accountRoute: AccountIdRoute, source: InteractionHandler) {\n    super();\n    this.locker = locker;\n    this.accountRoute = accountRoute;\n    this.source = source;\n  }\n\n  public async canHandle(input: InteractionHandlerInput): Promise<void> {\n    return this.source.canHandle(input);\n  }\n\n  public async handle(input: InteractionHandlerInput): Promise<Representation> {\n    const { accountId, operation } = input;\n\n    // No lock if there is no account\n    if (!accountId) {\n      return this.source.handle(input);\n    }\n\n    const identifier = { path: this.accountRoute.getPath({ accountId }) };\n    if (READ_METHODS.has(operation.method)) {\n      return this.locker.withReadLock(identifier, async(): Promise<Representation> => this.source.handle(input));\n    }\n\n    return this.locker.withWriteLock(identifier, async(): Promise<Representation> => this.source.handle(input));\n  }\n}\n"]}