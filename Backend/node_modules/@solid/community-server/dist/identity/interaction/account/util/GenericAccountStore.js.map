{"version":3,"file":"GenericAccountStore.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/account/util/GenericAccountStore.ts"],"names":[],"mappings":";;;AAAA,8DAA2D;AAC3D,yDAA2D;AAM3D,iEAAuE;AACvE,qFAAkF;AAGlF,iDAA8C;AAE9C;;;GAGG;AACH,MAAa,mBACX,SAAQ,yBAAW;IACA,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE5B,WAAW,CAAQ;IACnB,OAAO,CAAiD;IACjE,WAAW,GAAG,KAAK,CAAC;IAE9B,uDAAuD;IACvD,YAAmB,OAAmD,EAAE,WAAkB;QACxF,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAC/B,IAAI,CAAC,OAAO,GAAG,OAAyC,CAAC;IAC3D,CAAC;IAED,kCAAkC;IAC3B,KAAK,CAAC,MAAM;QACjB,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,OAAO;QACT,CAAC;QACD,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,2BAAY,EAAE,IAAI,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;YACrE,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAC1B,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,MAAM,IAAI,yCAAmB,CAAC,sCAAsC,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QAC9G,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAM;QACjB,qEAAqE;QACrE,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,2BAAY,EAAE,EAA6B,CAAC,CAAC;QACtF,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,uBAAuB,EAAE,EAAE,CAAC,CAAC;QAE/C,OAAO,EAAE,CAAC;IACZ,CAAC;IAEM,KAAK,CAAC,UAAU,CAA2B,EAAU,EAAE,OAAa;QAEzE,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,2BAAY,EAAE,EAAE,CAAC,CAAC;QACzD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO;QACT,CAAC;QACD,OAAO,OAAO,CAAC,OAAO,CAAC,CAAC;IAC1B,CAAC;IAEM,KAAK,CAAC,aAAa,CAAgC,EAAU,EAAE,OAAa,EAAE,KAA8B;QAEjH,MAAM,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,2BAAY,EAAE,EAAE,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;IAChE,CAAC;CACF;AAjDD,kDAiDC","sourcesContent":["import { Initializer } from '../../../../init/Initializer';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport type {\n  CreateTypeObject,\n  StringKey,\n  TypeObject,\n} from '../../../../storage/keyvalue/IndexedStorage';\nimport { createErrorMessage } from '../../../../util/errors/ErrorUtil';\nimport { InternalServerError } from '../../../../util/errors/InternalServerError';\nimport type { AccountStore, MinimalAccountSettings } from './AccountStore';\nimport type { AccountLoginStorage } from './LoginStorage';\nimport { ACCOUNT_TYPE } from './LoginStorage';\n\n/**\n * A {@link AccountStore} that uses an {@link AccountLoginStorage} to keep track of the accounts.\n * Needs to be initialized before it can be used.\n */\nexport class GenericAccountStore<TDesc extends MinimalAccountSettings>\n  extends Initializer implements AccountStore<TDesc> {\n  protected readonly logger = getLoggerFor(this);\n\n  protected readonly description: TDesc;\n  protected readonly storage: AccountLoginStorage<{ [ACCOUNT_TYPE]: TDesc }>;\n  protected initialized = false;\n\n  // Wrong typings to prevent Components.js typing issues\n  public constructor(storage: AccountLoginStorage<Record<string, never>>, description: TDesc) {\n    super();\n    this.description = description;\n    this.storage = storage as unknown as typeof this.storage;\n  }\n\n  // Initialize the type definitions\n  public async handle(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n    try {\n      await this.storage.defineType(ACCOUNT_TYPE, this.description, false);\n      this.initialized = true;\n    } catch (cause: unknown) {\n      throw new InternalServerError(`Error defining account in storage: ${createErrorMessage(cause)}`, { cause });\n    }\n  }\n\n  public async create(): Promise<string> {\n    // {} is valid as only optional fields are allowed in the description\n    const { id } = await this.storage.create(ACCOUNT_TYPE, {} as CreateTypeObject<TDesc>);\n    this.logger.debug(`Created new account ${id}`);\n\n    return id;\n  }\n\n  public async getSetting<TKey extends keyof TDesc>(id: string, setting: TKey):\n  Promise<TypeObject<TDesc>[TKey] | undefined> {\n    const account = await this.storage.get(ACCOUNT_TYPE, id);\n    if (!account) {\n      return;\n    }\n    return account[setting];\n  }\n\n  public async updateSetting<TKey extends StringKey<TDesc>>(id: string, setting: TKey, value: TypeObject<TDesc>[TKey]):\n  Promise<void> {\n    await this.storage.setField(ACCOUNT_TYPE, id, setting, value);\n  }\n}\n"]}