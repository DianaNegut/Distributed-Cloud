{"version":3,"file":"ClientCredentialsAdapterFactory.js","sourceRoot":"","sources":["../../../../src/identity/interaction/client-credentials/ClientCredentialsAdapterFactory.ts"],"names":[],"mappings":";;;AACA,sDAAwD;AAExD,uFAAwG;AAIxG;;;;GAIG;AACH,MAAa,wBAAyB,SAAQ,8CAAkB;IAC3C,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,UAAU,CAAa;IACvB,sBAAsB,CAAyB;IAEhE,YACE,IAAY,EACZ,MAAe,EACf,UAAsB,EACtB,sBAA8C;QAE9C,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QACpB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,sBAAsB,GAAG,sBAAsB,CAAC;IACvD,CAAC;IAEM,KAAK,CAAC,IAAI,CAAC,KAAa;QAC7B,IAAI,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAE5C,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;YACvC,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YACzE,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,OAAO,OAAO,CAAC;YACjB,CAAC;YAED,sDAAsD;YACtD,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,WAAW,CAAC,KAAK,EAAE,WAAW,CAAC,SAAS,CAAC,CAAC;YACvF,IAAI,CAAC,KAAK,EAAE,CAAC;gBACX,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,4BAA4B,KAAK,sEAAsE,CACxG,CAAC;gBACF,MAAM,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;gBACzD,OAAO,OAAO,CAAC;YACjB,CAAC;YAED,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,qBAAqB,WAAW,CAAC,KAAK,2BAA2B,CAAC,CAAC;YAErF,yCAAyC;YACzC,OAAO,GAAG;gBACR,SAAS,EAAE,KAAK;gBAChB,aAAa,EAAE,WAAW,CAAC,MAAM;gBACjC,WAAW,EAAE,CAAE,oBAAoB,CAAE;gBACrC,aAAa,EAAE,EAAE;gBACjB,cAAc,EAAE,EAAE;aACnB,CAAC;YACF,wCAAwC;QAC1C,CAAC;QACD,OAAO,OAAO,CAAC;IACjB,CAAC;CACF;AAlDD,4DAkDC;AAED,MAAa,+BAAgC,SAAQ,qDAAyB;IAC3D,UAAU,CAAa;IACvB,sBAAsB,CAAyB;IAEhE,YAAmB,MAAsB,EAAE,UAAsB,EAAE,sBAA8C;QAC/G,KAAK,CAAC,MAAM,CAAC,CAAC;QACd,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,sBAAsB,GAAG,sBAAsB,CAAC;IACvD,CAAC;IAEM,oBAAoB,CAAC,IAAY;QACtC,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;QACvD,OAAO,IAAI,wBAAwB,CAAC,IAAI,EAAE,OAAO,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,sBAAsB,CAAC,CAAC;IACnG,CAAC;CACF;AAdD,0EAcC","sourcesContent":["import type { Adapter, AdapterPayload } from '../../../../templates/types/oidc-provider';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { AdapterFactory } from '../../storage/AdapterFactory';\nimport { PassthroughAdapter, PassthroughAdapterFactory } from '../../storage/PassthroughAdapterFactory';\nimport type { WebIdStore } from '../webid/util/WebIdStore';\nimport type { ClientCredentialsStore } from './util/ClientCredentialsStore';\n\n/**\n * A {@link PassthroughAdapter} that overrides the `find` function\n * by checking if there are stored client credentials for the given ID\n * if no payload is found in the source.\n */\nexport class ClientCredentialsAdapter extends PassthroughAdapter {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly webIdStore: WebIdStore;\n  private readonly clientCredentialsStore: ClientCredentialsStore;\n\n  public constructor(\n    name: string,\n    source: Adapter,\n    webIdStore: WebIdStore,\n    clientCredentialsStore: ClientCredentialsStore,\n  ) {\n    super(name, source);\n    this.webIdStore = webIdStore;\n    this.clientCredentialsStore = clientCredentialsStore;\n  }\n\n  public async find(label: string): Promise<AdapterPayload | void | undefined> {\n    let payload = await this.source.find(label);\n\n    if (!payload && this.name === 'Client') {\n      const credentials = await this.clientCredentialsStore.findByLabel(label);\n      if (!credentials) {\n        return payload;\n      }\n\n      // Make sure the WebID wasn't unlinked in the meantime\n      const valid = await this.webIdStore.isLinked(credentials.webId, credentials.accountId);\n      if (!valid) {\n        this.logger.error(\n          `Client credentials token ${label} contains WebID that is no longer linked to the account. Removing...`,\n        );\n        await this.clientCredentialsStore.delete(credentials.id);\n        return payload;\n      }\n\n      this.logger.debug(`Authenticating as ${credentials.webId} using client credentials`);\n\n      /* eslint-disable ts/naming-convention */\n      payload = {\n        client_id: label,\n        client_secret: credentials.secret,\n        grant_types: [ 'client_credentials' ],\n        redirect_uris: [],\n        response_types: [],\n      };\n      /* eslint-enable ts/naming-convention */\n    }\n    return payload;\n  }\n}\n\nexport class ClientCredentialsAdapterFactory extends PassthroughAdapterFactory {\n  private readonly webIdStore: WebIdStore;\n  private readonly clientCredentialsStore: ClientCredentialsStore;\n\n  public constructor(source: AdapterFactory, webIdStore: WebIdStore, clientCredentialsStore: ClientCredentialsStore) {\n    super(source);\n    this.webIdStore = webIdStore;\n    this.clientCredentialsStore = clientCredentialsStore;\n  }\n\n  public createStorageAdapter(name: string): Adapter {\n    const adapter = this.source.createStorageAdapter(name);\n    return new ClientCredentialsAdapter(name, adapter, this.webIdStore, this.clientCredentialsStore);\n  }\n}\n"]}