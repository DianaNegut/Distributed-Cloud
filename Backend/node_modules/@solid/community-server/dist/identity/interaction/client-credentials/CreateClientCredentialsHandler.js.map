{"version":3,"file":"CreateClientCredentialsHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/client-credentials/CreateClientCredentialsHandler.ts"],"names":[],"mappings":";;;AAAA,+BAA0B;AAC1B,6BAAqC;AACrC,sDAAwD;AACxD,kFAA+E;AAC/E,yDAA2D;AAC3D,6DAA8D;AAE9D,sEAAmE;AAInE,wCAA4D;AAI5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,IAAI,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;IAChC,KAAK,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;CAClC,CAAC,CAAC;AAQH;;GAEG;AACH,MAAa,8BAA+B,SAAQ,+CAA+B;IAC9D,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,UAAU,CAAa;IACvB,sBAAsB,CAAyB;IAC/C,sBAAsB,CAA2B;IAElE,YACE,UAAsB,EACtB,sBAA8C,EAC9C,sBAAgD;QAEhD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,sBAAsB,GAAG,sBAAsB,CAAC;QACrD,IAAI,CAAC,sBAAsB,GAAG,sBAAsB,CAAC;IACvD,CAAC;IAEM,KAAK,CAAC,OAAO,CAAC,EAAE,SAAS,EAA+B;QAC7D,IAAA,6BAAe,EAAC,SAAS,CAAC,CAAC;QAC3B,MAAM,iBAAiB,GAA2B,EAAE,CAAC;QACrD,KAAK,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,IAAI,MAAM,IAAI,CAAC,sBAAsB,CAAC,aAAa,CAAC,SAAS,CAAC,EAAE,CAAC;YACvF,iBAAiB,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,mBAAmB,EAAE,EAAE,EAAE,CAAC,CAAC;QACzG,CAAC;QACD,OAAO,EAAE,IAAI,EAAE,EAAE,GAAG,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,iBAAiB,EAAE,EAAC,CAAC;IAClE,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,IAAI,EAA+B;QAClE,IAAA,6BAAe,EAAC,SAAS,CAAC,CAAC;QAE3B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QAEhE,IAAI,CAAC,MAAM,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,KAAK,EAAE,SAAS,CAAC,EAAE,CAAC;YACtD,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,8BAA8B,KAAK,qCAAqC,SAAS,EAAE,CAAC,CAAC;YACtG,MAAM,IAAI,yCAAmB,CAAC,wCAAwC,CAAC,CAAC;QAC1E,CAAC;QAED,MAAM,WAAW,GAAG,IAAI,CAAC,CAAC,CAAC,IAAA,4BAAe,EAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;QAC7D,MAAM,KAAK,GAAG,GAAG,WAAW,IAAI,IAAA,SAAE,GAAE,EAAE,CAAC;QAEvC,MAAM,EAAE,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,KAAK,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;QACzF,MAAM,QAAQ,GAAG,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,mBAAmB,EAAE,EAAE,EAAE,CAAC,CAAC;QAE7F,6FAA6F;QAC7F,gFAAgF;QAChF,OAAO,EAAE,IAAI,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,QAAQ,EAAE,EAAC,CAAC;IAClD,CAAC;CACF;AA/CD,wEA+CC","sourcesContent":["import { v4 } from 'uuid';\nimport { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../../util/errors/BadRequestHttpError';\nimport { sanitizeUrlPart } from '../../../util/StringUtil';\nimport { assertAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport type { WebIdStore } from '../webid/util/WebIdStore';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { ClientCredentialsIdRoute } from './util/ClientCredentialsIdRoute';\nimport type { ClientCredentialsStore } from './util/ClientCredentialsStore';\n\nconst inSchema = object({\n  name: string().trim().optional(),\n  webId: string().trim().required(),\n});\n\ntype OutType = {\n  id: string;\n  secret: string;\n  resource: string;\n};\n\n/**\n * Handles the creation of client credential tokens.\n */\nexport class CreateClientCredentialsHandler extends JsonInteractionHandler<OutType> implements JsonView {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly webIdStore: WebIdStore;\n  private readonly clientCredentialsStore: ClientCredentialsStore;\n  private readonly clientCredentialsRoute: ClientCredentialsIdRoute;\n\n  public constructor(\n    webIdStore: WebIdStore,\n    clientCredentialsStore: ClientCredentialsStore,\n    clientCredentialsRoute: ClientCredentialsIdRoute,\n  ) {\n    super();\n    this.webIdStore = webIdStore;\n    this.clientCredentialsStore = clientCredentialsStore;\n    this.clientCredentialsRoute = clientCredentialsRoute;\n  }\n\n  public async getView({ accountId }: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    assertAccountId(accountId);\n    const clientCredentials: Record<string, string> = {};\n    for (const { id, label } of await this.clientCredentialsStore.findByAccount(accountId)) {\n      clientCredentials[label] = this.clientCredentialsRoute.getPath({ accountId, clientCredentialsId: id });\n    }\n    return { json: { ...parseSchema(inSchema), clientCredentials }};\n  }\n\n  public async handle({ accountId, json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    assertAccountId(accountId);\n\n    const { name, webId } = await validateWithError(inSchema, json);\n\n    if (!await this.webIdStore.isLinked(webId, accountId)) {\n      this.logger.warn(`Trying to create token for ${webId} which does not belong to account ${accountId}`);\n      throw new BadRequestHttpError('WebID does not belong to this account.');\n    }\n\n    const cleanedName = name ? sanitizeUrlPart(name.trim()) : '';\n    const label = `${cleanedName}_${v4()}`;\n\n    const { secret, id } = await this.clientCredentialsStore.create(label, webId, accountId);\n    const resource = this.clientCredentialsRoute.getPath({ accountId, clientCredentialsId: id });\n\n    // Exposing the field as `id` as that is how we originally defined the client credentials API\n    // and is more consistent with how the field names are explained in other places\n    return { json: { id: label, secret, resource }};\n  }\n}\n"]}