{"version":3,"file":"BaseClientCredentialsStore.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/client-credentials/util/BaseClientCredentialsStore.ts"],"names":[],"mappings":";;;AAAA,6CAA0C;AAC1C,8DAA2D;AAC3D,yDAA2D;AAC3D,iEAAuE;AACvE,qFAAkF;AAClF,kEAA+D;AAIlD,QAAA,+BAA+B,GAAG,mBAAmB,CAAC;AACtD,QAAA,sCAAsC,GAAG;IACpD,KAAK,EAAE,QAAQ;IACf,SAAS,EAAE,MAAM,2BAAY,EAAE;IAC/B,MAAM,EAAE,QAAQ;IAChB,KAAK,EAAE,QAAQ;CACP,CAAC;AAEX;;;GAGG;AACH,MAAa,0BAA2B,SAAQ,yBAAW;IACxC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE5B,OAAO,CAC8B;IAE9C,WAAW,GAAG,KAAK,CAAC;IAE5B,uDAAuD;IACvD,YAAmB,OAAmD;QACpE,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,OAAO,GAAG,OAAyC,CAAC;IAC3D,CAAC;IAED,kCAAkC;IAC3B,KAAK,CAAC,MAAM;QACjB,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,OAAO;QACT,CAAC;QACD,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,uCAA+B,EAAE,8CAAsC,EAAE,KAAK,CAAC,CAAC;YAC9G,MAAM,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,uCAA+B,EAAE,WAAW,CAAC,CAAC;YAC7E,MAAM,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,uCAA+B,EAAE,OAAO,CAAC,CAAC;YACzE,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAC1B,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,MAAM,IAAI,yCAAmB,CAC3B,iDAAiD,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,EAC5E,EAAE,KAAK,EAAE,CACV,CAAC;QACJ,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,GAAG,CAAC,EAAU;QACzB,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,uCAA+B,EAAE,EAAE,CAAC,CAAC;IAC/D,CAAC;IAEM,KAAK,CAAC,WAAW,CAAC,KAAa;QACpC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,uCAA+B,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACnF,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACxB,OAAO;QACT,CAAC;QACD,OAAO,MAAM,CAAC,CAAC,CAAC,CAAC;IACnB,CAAC;IAEM,KAAK,CAAC,aAAa,CAAC,SAAiB;QAC1C,OAAO,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,uCAA+B,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;IAC3E,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAa,EAAE,KAAa,EAAE,SAAiB;QACjE,MAAM,MAAM,GAAG,IAAA,yBAAW,EAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAE/C,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,gDAAgD,KAAK,cAAc,KAAK,gBAAgB,SAAS,EAAE,CACpG,CAAC;QAEF,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,uCAA+B,EAAE,EAAE,SAAS,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IACnG,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAU;QAC5B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,6CAA6C,EAAE,EAAE,CAAC,CAAC;QACrE,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,uCAA+B,EAAE,EAAE,CAAC,CAAC;IAClE,CAAC;CACF;AA9DD,gEA8DC","sourcesContent":["import { randomBytes } from 'node:crypto';\nimport { Initializer } from '../../../../init/Initializer';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport { createErrorMessage } from '../../../../util/errors/ErrorUtil';\nimport { InternalServerError } from '../../../../util/errors/InternalServerError';\nimport { ACCOUNT_TYPE } from '../../account/util/LoginStorage';\nimport type { AccountLoginStorage } from '../../account/util/LoginStorage';\nimport type { ClientCredentials, ClientCredentialsStore } from './ClientCredentialsStore';\n\nexport const CLIENT_CREDENTIALS_STORAGE_TYPE = 'clientCredentials';\nexport const CLIENT_CREDENTIALS_STORAGE_DESCRIPTION = {\n  label: 'string',\n  accountId: `id:${ACCOUNT_TYPE}`,\n  secret: 'string',\n  webId: 'string',\n} as const;\n\n/**\n * A {@link ClientCredentialsStore} that uses a {@link AccountLoginStorage} for storing the tokens.\n * Needs to be initialized before it can be used.\n */\nexport class BaseClientCredentialsStore extends Initializer implements ClientCredentialsStore {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly storage: AccountLoginStorage<{ [CLIENT_CREDENTIALS_STORAGE_TYPE]:\n      typeof CLIENT_CREDENTIALS_STORAGE_DESCRIPTION; }>;\n\n  private initialized = false;\n\n  // Wrong typings to prevent Components.js typing issues\n  public constructor(storage: AccountLoginStorage<Record<string, never>>) {\n    super();\n    this.storage = storage as unknown as typeof this.storage;\n  }\n\n  // Initialize the type definitions\n  public async handle(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n    try {\n      await this.storage.defineType(CLIENT_CREDENTIALS_STORAGE_TYPE, CLIENT_CREDENTIALS_STORAGE_DESCRIPTION, false);\n      await this.storage.createIndex(CLIENT_CREDENTIALS_STORAGE_TYPE, 'accountId');\n      await this.storage.createIndex(CLIENT_CREDENTIALS_STORAGE_TYPE, 'label');\n      this.initialized = true;\n    } catch (cause: unknown) {\n      throw new InternalServerError(\n        `Error defining client credentials in storage: ${createErrorMessage(cause)}`,\n        { cause },\n      );\n    }\n  }\n\n  public async get(id: string): Promise<ClientCredentials | undefined> {\n    return this.storage.get(CLIENT_CREDENTIALS_STORAGE_TYPE, id);\n  }\n\n  public async findByLabel(label: string): Promise<ClientCredentials | undefined> {\n    const result = await this.storage.find(CLIENT_CREDENTIALS_STORAGE_TYPE, { label });\n    if (result.length === 0) {\n      return;\n    }\n    return result[0];\n  }\n\n  public async findByAccount(accountId: string): Promise<ClientCredentials[]> {\n    return this.storage.find(CLIENT_CREDENTIALS_STORAGE_TYPE, { accountId });\n  }\n\n  public async create(label: string, webId: string, accountId: string): Promise<ClientCredentials> {\n    const secret = randomBytes(64).toString('hex');\n\n    this.logger.debug(\n      `Creating client credentials token with label ${label} for WebID ${webId} and account ${accountId}`,\n    );\n\n    return this.storage.create(CLIENT_CREDENTIALS_STORAGE_TYPE, { accountId, label, webId, secret });\n  }\n\n  public async delete(id: string): Promise<void> {\n    this.logger.debug(`Deleting client credentials token with ID ${id}`);\n    return this.storage.delete(CLIENT_CREDENTIALS_STORAGE_TYPE, id);\n  }\n}\n"]}