{"version":3,"file":"ResolveLoginHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/login/ResolveLoginHandler.ts"],"names":[],"mappings":";;;AAAA,gGAA6F;AAC7F,sDAAwD;AAExD,6DAAwD;AACxD,+DAA+E;AAI/E,wDAAuD;AAEvD,sEAAmE;AAiBnE;;;;GAIG;AACH,MAAsB,mBAAoB,SAAQ,+CAAsB;IACnD,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE5B,YAAY,CAAe;IAC3B,WAAW,CAAc;IAE5C,YAAsB,YAA0B,EAAE,WAAwB;QACxE,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;IACjC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAkC;QACpD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QACvC,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,MAAM,CAAC,IAAI,CAAC;QAE5C,MAAM,IAAI,GAAS,EAAE,GAAG,MAAM,CAAC,IAAI,EAAE,CAAC;QAEtC,+DAA+D;QAC/D,OAAO,IAAI,CAAC,SAAS,CAAC;QACtB,OAAO,IAAI,CAAC,QAAQ,CAAC;QAErB,iEAAiE;QACjE,mFAAmF;QACnF,uFAAuF;QACvF,MAAM,QAAQ,GAAG,MAAM,CAAC,QAAQ,IAAI,IAAI,+CAAsB,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;QAC7E,IAAI,CAAC,aAAa,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;QAChE,QAAQ,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;QAEjE,uFAAuF;QACvF,qFAAqF;QACrF,MAAM,SAAS,GAAG,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,yBAAU,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE,KAAK,CAAC;QAC5E,IAAI,SAAS,EAAE,CAAC;YACd,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,wBAAwB,SAAS,SAAS,IAAI,CAAC,MAAgB,EAAE,CAAC,CAAC;YACrF,MAAM,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QAC3C,CAAC;QAED,8BAA8B;QAC9B,MAAM,IAAI,CAAC,qBAAqB,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;QAEtD,2EAA2E;QAC3E,kEAAkE;QAClE,IAAI,KAAK,CAAC,eAAe,EAAE,CAAC;YAC1B,gGAAgG;YAChG,IAAI,CAAC,QAAQ,GAAG,MAAM,IAAA,mCAAiB,EAAC,KAAK,CAAC,eAAe,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;QAC3E,CAAC;QAED,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC;IAC5B,CAAC;IAED;;;;;OAKG;IACO,KAAK,CAAC,qBAAqB,CAAC,SAAiB,EAAE,QAAkB;QACzE,IAAI,OAAO,QAAQ,KAAK,SAAS,EAAE,CAAC;YAClC,uEAAuE;YACvE,MAAM,IAAI,CAAC,YAAY,CAAC,aAAa,CAAC,SAAS,EAAE,8CAA+B,EAAE,QAAQ,CAAC,CAAC;YAC5F,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,wCAAwC,QAAQ,EAAE,CAAC,CAAC;QACxE,CAAC;IACH,CAAC;CAQF;AAtED,kDAsEC","sourcesContent":["import { RepresentationMetadata } from '../../../http/representation/RepresentationMetadata';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { Json } from '../../../util/Json';\nimport { SOLID_HTTP } from '../../../util/Vocabularies';\nimport { ACCOUNT_SETTINGS_REMEMBER_LOGIN } from '../account/util/AccountStore';\nimport type { AccountStore } from '../account/util/AccountStore';\nimport type { CookieStore } from '../account/util/CookieStore';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { finishInteraction } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\n\n/**\n * Output type that is expected of handlers logging an account in.\n */\nexport type LoginOutputType = {\n  /**\n   * The ID of the account that logged in.\n   */\n  accountId: string;\n  /**\n   * If this account should be remembered or not.\n   * Setting this to `undefined` will keep the setting as it currently is.\n   */\n  remember?: boolean;\n};\n\n/**\n * A handler that takes care of all the necessary steps when logging a user in,\n * such as generating a cookie and setting the necessary OIDC information.\n * Classes that resolve login methods should extend this class and implement the `login` method.\n */\nexport abstract class ResolveLoginHandler extends JsonInteractionHandler {\n  protected readonly logger = getLoggerFor(this);\n\n  protected readonly accountStore: AccountStore;\n  protected readonly cookieStore: CookieStore;\n\n  protected constructor(accountStore: AccountStore, cookieStore: CookieStore) {\n    super();\n    this.accountStore = accountStore;\n    this.cookieStore = cookieStore;\n  }\n\n  public async handle(input: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    const result = await this.login(input);\n    const { accountId, remember } = result.json;\n\n    const json: Json = { ...result.json };\n\n    // There is no need to output these fields in the response JSON\n    delete json.accountId;\n    delete json.remember;\n\n    // The cookie that is used to identify that a user has logged in.\n    // Putting it in the metadata, so it can be converted into an HTTP response header.\n    // Putting it in the response JSON so users can also use it in an Authorization header.\n    const metadata = result.metadata ?? new RepresentationMetadata(input.target);\n    json.authorization = await this.cookieStore.generate(accountId);\n    metadata.add(SOLID_HTTP.terms.accountCookie, json.authorization);\n\n    // Delete the old cookie if there was one, to prevent unused cookies from being stored.\n    // We are not reusing this cookie as it could be associated with a different account.\n    const oldCookie = input.metadata.get(SOLID_HTTP.terms.accountCookie)?.value;\n    if (oldCookie) {\n      this.logger.debug(`Replacing old cookie ${oldCookie} with ${json.cookie as string}`);\n      await this.cookieStore.delete(oldCookie);\n    }\n\n    // Update the account settings\n    await this.updateRememberSetting(accountId, remember);\n\n    // Not throwing redirect error otherwise the cookie metadata would be lost.\n    // See {@link LocationInteractionHandler} why this field is added.\n    if (input.oidcInteraction) {\n      // Finish the interaction so the policies are checked again, where they will find the new cookie\n      json.location = await finishInteraction(input.oidcInteraction, {}, true);\n    }\n\n    return { json, metadata };\n  }\n\n  /**\n   * Updates the account setting that determines whether the login status needs to be remembered.\n   *\n   * @param accountId - ID of the account.\n   * @param remember - If the account should be remembered or not. The setting will not be updated if this is undefined.\n   */\n  protected async updateRememberSetting(accountId: string, remember?: boolean): Promise<void> {\n    if (typeof remember === 'boolean') {\n      // Store the setting indicating if the user wants the cookie to persist\n      await this.accountStore.updateSetting(accountId, ACCOUNT_SETTINGS_REMEMBER_LOGIN, remember);\n      this.logger.debug(`Updating account remember setting to ${remember}`);\n    }\n  }\n\n  /**\n   * Takes the necessary steps to log a user in.\n   *\n   * @param input - Same input that was passed to the handle function.\n   */\n  public abstract login(input: JsonInteractionHandlerInput): Promise<JsonRepresentation<LoginOutputType>>;\n}\n"]}