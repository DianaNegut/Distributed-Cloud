{"version":3,"file":"ClientInfoHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/oidc/ClientInfoHandler.ts"],"names":[],"mappings":";;;AAIA,wDAA2D;AAE3D,sEAAmE;AAEnE,8DAA8D;AAC9D,2DAA2D;AAC3D,MAAM,WAAW,GAAG;IAClB,WAAW;IACX,YAAY;IACZ,UAAU;IACV,YAAY;IACZ,aAAa;IACb,UAAU;IACV,aAAa;IACb,OAAO;CACC,CAAC;AAYX;;GAEG;AACH,MAAa,iBAAkB,SAAQ,+CAA+B;IACnD,eAAe,CAAkB;IAElD,YAAmB,eAAgC;QACjD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,eAAe,GAAG,eAAe,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,eAAe,EAA+B;QAClE,IAAA,uCAAqB,EAAC,eAAe,CAAC,CAAC;QACvC,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,CAAC;QAC1D,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,SAAmB,CAAC,CAAC;QACtF,MAAM,QAAQ,GAAsB,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC;QAE7D,MAAM,MAAM,GAAG,MAAM,CAAC,WAAW,CAC/B,WAAW,CAAC,MAAM,CAAC,CAAC,GAAG,EAAW,EAAE,CAAC,GAAG,IAAI,QAAQ,CAAC;aAClD,GAAG,CAAC,CAAC,GAAG,EAAwB,EAAE,CAAC,CAAE,GAAG,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAE,CAAC,CAEkC,CAAC;QAClG,MAAM,CAAC,UAAU,CAAC,GAAG,iDAAiD,CAAC;QAEvE,mFAAmF;QACnF,MAAM,KAAK,GAAG,eAAe,EAAE,OAAO,EAAE,SAAS,CAAC;QAElD,OAAO,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,EAAC,CAAC;IAC5C,CAAC;CACF;AA1BD,8CA0BC","sourcesContent":["import type { AllClientMetadata } from '../../../../templates/types/oidc-provider';\nimport type { ArrayElement } from '../../../util/map/MapUtil';\nimport type { ProviderFactory } from '../../configuration/ProviderFactory';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { assertOidcInteraction } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\n\n// Only extract specific fields to prevent leaking information\n// Based on https://www.w3.org/ns/solid/oidc-context.jsonld\nconst CLIENT_KEYS = [\n  'client_id',\n  'client_uri',\n  'logo_uri',\n  'policy_uri',\n  'client_name',\n  'contacts',\n  'grant_types',\n  'scope',\n] as const;\n\n// Possible keys in client metadata\ntype KeyType = ArrayElement<typeof CLIENT_KEYS>;\n// Possible values for client metadata\ntype ValType = AllClientMetadata[KeyType];\n// Simplified to keep Components.js happy\ntype OutType = {\n  client: Record<string, string | string[] | undefined>;\n  webId?: string;\n};\n\n/**\n * Returns a JSON representation with metadata of the client that is requesting the OIDC interaction.\n */\nexport class ClientInfoHandler extends JsonInteractionHandler<OutType> {\n  private readonly providerFactory: ProviderFactory;\n\n  public constructor(providerFactory: ProviderFactory) {\n    super();\n    this.providerFactory = providerFactory;\n  }\n\n  public async handle({ oidcInteraction }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    assertOidcInteraction(oidcInteraction);\n    const provider = await this.providerFactory.getProvider();\n    const client = await provider.Client.find(oidcInteraction.params.client_id as string);\n    const metadata: AllClientMetadata = client?.metadata() ?? {};\n\n    const jsonLd = Object.fromEntries(\n      CLIENT_KEYS.filter((key): boolean => key in metadata)\n        .map((key): [ KeyType, ValType ] => [ key, metadata[key] ]),\n      // eslint-disable-next-line ts/naming-convention\n    ) as Record<KeyType, ValType> & { '@context': 'https://www.w3.org/ns/solid/oidc-context.jsonld' };\n    jsonLd['@context'] = 'https://www.w3.org/ns/solid/oidc-context.jsonld';\n\n    // Note: this is the `accountId` from the OIDC library, in which we store the WebID\n    const webId = oidcInteraction?.session?.accountId;\n\n    return { json: { client: jsonLd, webId }};\n  }\n}\n"]}