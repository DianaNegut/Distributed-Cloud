{"version":3,"file":"ConsentHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/oidc/ConsentHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { boolean, object } from 'yup';\nimport type { InteractionResults, KoaContextWithOIDC, UnknownObject } from '../../../../templates/types/oidc-provider';\nimport { FoundHttpError } from '../../../util/errors/FoundHttpError';\nimport { NotImplementedHttpError } from '../../../util/errors/NotImplementedHttpError';\nimport type { ProviderFactory } from '../../configuration/ProviderFactory';\nimport type { Interaction } from '../InteractionHandler';\nimport { assertOidcInteraction, finishInteraction } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport { validateWithError } from '../YupUtil';\n\ntype Grant = NonNullable<KoaContextWithOIDC['oidc']['entities']['Grant']>;\n\nconst inSchema = object({\n  remember: boolean().default(false),\n});\n\n/**\n * Handles the OIDC consent prompts where the user confirms they want to log in for the given client.\n */\nexport class ConsentHandler extends JsonInteractionHandler<never> {\n  private readonly providerFactory: ProviderFactory;\n\n  public constructor(providerFactory: ProviderFactory) {\n    super();\n    this.providerFactory = providerFactory;\n  }\n\n  public async handle({ oidcInteraction, json }: JsonInteractionHandlerInput): Promise<never> {\n    assertOidcInteraction(oidcInteraction);\n\n    const { remember } = await validateWithError(inSchema, json);\n\n    const grant = await this.getGrant(oidcInteraction);\n    this.updateGrant(grant, oidcInteraction.prompt.details, remember);\n\n    const location = await this.updateInteraction(oidcInteraction, grant);\n\n    throw new FoundHttpError(location);\n  }\n\n  /**\n   * Either returns the grant associated with the given interaction or creates a new one if it does not exist yet.\n   */\n  private async getGrant(oidcInteraction: Interaction): Promise<Grant> {\n    if (!oidcInteraction.session) {\n      throw new NotImplementedHttpError('Only interactions with a valid session are supported.');\n    }\n\n    const { params, session: { accountId }, grantId } = oidcInteraction;\n    const provider = await this.providerFactory.getProvider();\n\n    let grant: Grant;\n    if (grantId) {\n      grant = (await provider.Grant.find(grantId))!;\n    } else {\n      grant = new provider.Grant({\n        accountId,\n        clientId: params.client_id as string,\n      });\n    }\n    return grant;\n  }\n\n  /**\n   * Updates the grant with all the missing scopes and claims requested by the interaction.\n   *\n   * Will reject the `offline_access` scope if `remember` is false.\n   */\n  private updateGrant(grant: Grant, details: UnknownObject, remember: boolean): void {\n    // Reject the offline_access scope if the user does not want to be remembered\n    if (!remember) {\n      grant.rejectOIDCScope('offline_access');\n    }\n\n    // Grant all the requested scopes and claims\n    if (details.missingOIDCScope) {\n      grant.addOIDCScope((details.missingOIDCScope as string[]).join(' '));\n    }\n    if (details.missingOIDCClaims) {\n      grant.addOIDCClaims(details.missingOIDCClaims as string[]);\n    }\n    if (details.missingResourceScopes) {\n      for (const [ indicator, scopes ] of Object.entries(details.missingResourceScopes as Record<string, string[]>)) {\n        grant.addResourceScope(indicator, scopes.join(' '));\n      }\n    }\n  }\n\n  /**\n   * Updates the interaction with the new grant and returns the resulting redirect URL.\n   */\n  private async updateInteraction(oidcInteraction: Interaction, grant: Grant): Promise<string> {\n    const grantId = await grant.save();\n\n    const consent: InteractionResults['consent'] = {};\n    // Only need to update the grantId if it is new\n    if (!oidcInteraction.grantId) {\n      consent.grantId = grantId;\n    }\n\n    return finishInteraction(oidcInteraction, { consent }, true);\n  }\n}\n"]}