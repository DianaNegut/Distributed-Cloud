{"version":3,"file":"CreatePasswordHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/password/CreatePasswordHandler.ts"],"names":[],"mappings":";;;AAAA,6BAAqC;AACrC,sDAAwD;AACxD,6DAA8D;AAE9D,sEAAmE;AAGnE,wCAA4D;AAM5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,KAAK,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,KAAK,EAAE,CAAC,QAAQ,EAAE;IACzC,QAAQ,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;CAC5C,CAAC,CAAC;AAEH;;GAEG;AACH,MAAa,qBAAsB,SAAQ,+CAA+B;IACrD,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,aAAa,CAAgB;IAC7B,aAAa,CAAkB;IAEhD,YAAmB,aAA4B,EAAE,aAA8B;QAC7E,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;QACnC,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;IACrC,CAAC;IAEM,KAAK,CAAC,OAAO,CAAC,EAAE,SAAS,EAA+B;QAC7D,IAAA,6BAAe,EAAC,SAAS,CAAC,CAAC;QAC3B,MAAM,cAAc,GAA2B,EAAE,CAAC;QAClD,KAAK,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,IAAI,MAAM,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,SAAS,CAAC,EAAE,CAAC;YAC9E,cAAc,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,UAAU,EAAE,EAAE,EAAE,CAAC,CAAC;QACpF,CAAC;QACD,OAAO,EAAE,IAAI,EAAE,EAAE,GAAG,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,cAAc,EAAE,EAAC,CAAC;IAC/D,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,IAAI,EAA+B;QAClE,6BAA6B;QAC7B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACpE,IAAA,6BAAe,EAAC,SAAS,CAAC,CAAC;QAE3B,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;QAC/E,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,UAAU,EAAE,CAAC,CAAC;QAEvE,qFAAqF;QACrF,MAAM,IAAI,CAAC,aAAa,CAAC,mBAAmB,CAAC,UAAU,CAAC,CAAC;QAEzD,OAAO,EAAE,IAAI,EAAE,EAAE,QAAQ,EAAE,EAAC,CAAC;IAC/B,CAAC;CACF;AAlCD,sDAkCC","sourcesContent":["import { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { assertAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { PasswordIdRoute } from './util/PasswordIdRoute';\nimport type { PasswordStore } from './util/PasswordStore';\n\ntype OutType = { resource: string };\n\nconst inSchema = object({\n  email: string().trim().email().required(),\n  password: string().trim().min(1).required(),\n});\n\n/**\n * Handles the creation of email/password login combinations for an account.\n */\nexport class CreatePasswordHandler extends JsonInteractionHandler<OutType> implements JsonView {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly passwordStore: PasswordStore;\n  private readonly passwordRoute: PasswordIdRoute;\n\n  public constructor(passwordStore: PasswordStore, passwordRoute: PasswordIdRoute) {\n    super();\n    this.passwordStore = passwordStore;\n    this.passwordRoute = passwordRoute;\n  }\n\n  public async getView({ accountId }: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    assertAccountId(accountId);\n    const passwordLogins: Record<string, string> = {};\n    for (const { id, email } of await this.passwordStore.findByAccount(accountId)) {\n      passwordLogins[email] = this.passwordRoute.getPath({ accountId, passwordId: id });\n    }\n    return { json: { ...parseSchema(inSchema), passwordLogins }};\n  }\n\n  public async handle({ accountId, json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    // Email will be in lowercase\n    const { email, password } = await validateWithError(inSchema, json);\n    assertAccountId(accountId);\n\n    const passwordId = await this.passwordStore.create(email, accountId, password);\n    const resource = this.passwordRoute.getPath({ accountId, passwordId });\n\n    // If we ever want to add email verification this would have to be checked separately\n    await this.passwordStore.confirmVerification(passwordId);\n\n    return { json: { resource }};\n  }\n}\n"]}