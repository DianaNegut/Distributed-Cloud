{"version":3,"file":"ForgotPasswordHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/password/ForgotPasswordHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { createErrorMessage } from '../../../util/errors/ErrorUtil';\nimport type { TemplateEngine } from '../../../util/templates/TemplateEngine';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport type { InteractionRoute } from '../routing/InteractionRoute';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { EmailSender } from './util/EmailSender';\nimport type { ForgotPasswordStore } from './util/ForgotPasswordStore';\nimport type { PasswordStore } from './util/PasswordStore';\n\nconst inSchema = object({\n  email: string().trim().email().required(),\n});\n\nexport interface ForgotPasswordHandlerArgs {\n  /**\n   * Store containing the password login information.\n   */\n  passwordStore: PasswordStore;\n  /**\n   * Store containing the forgot password records.\n   */\n  forgotPasswordStore: ForgotPasswordStore;\n  /**\n   * Template engine that will be used to generate the email body.\n   */\n  templateEngine: TemplateEngine<{ resetLink: string }>;\n  /**\n   * Sender to send the actual email.\n   */\n  emailSender: EmailSender;\n  /**\n   * Route used to generate the reset link for the user.\n   */\n  resetRoute: InteractionRoute;\n}\n\ntype OutType = { email: string };\n\n/**\n * Responsible for the case where a user forgot their password and asks for a reset.\n * Will send out the necessary mail if the email address is known.\n * The JSON response will always be the same to prevent leaking which email addresses are stored.\n */\nexport class ForgotPasswordHandler extends JsonInteractionHandler<OutType> implements JsonView {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly passwordStore: PasswordStore;\n  private readonly forgotPasswordStore: ForgotPasswordStore;\n  private readonly templateEngine: TemplateEngine<{ resetLink: string }>;\n  private readonly emailSender: EmailSender;\n  private readonly resetRoute: InteractionRoute;\n\n  public constructor(args: ForgotPasswordHandlerArgs) {\n    super();\n    this.passwordStore = args.passwordStore;\n    this.forgotPasswordStore = args.forgotPasswordStore;\n    this.templateEngine = args.templateEngine;\n    this.emailSender = args.emailSender;\n    this.resetRoute = args.resetRoute;\n  }\n\n  public async getView(): Promise<JsonRepresentation> {\n    return { json: parseSchema(inSchema) };\n  }\n\n  /**\n   * Generates a record to reset the password for the given email address and then mails it.\n   * In case there is no account, no error wil be thrown for privacy reasons.\n   * Nothing will happen instead.\n   */\n  public async handle({ json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    const { email } = await validateWithError(inSchema, json);\n\n    const payload = await this.passwordStore.findByEmail(email);\n\n    if (payload?.id) {\n      try {\n        const recordId = await this.forgotPasswordStore.generate(payload.id);\n        await this.sendResetMail(recordId, email);\n      } catch (error: unknown) {\n        // This error can not be thrown for privacy reasons.\n        // If there always is an error, because there is a problem with the mail server for example,\n        // errors would only be thrown for registered accounts.\n        // Although we do also leak this information when an account tries to register an email address,\n        // so this might be removed in the future.\n        this.logger.error(`Problem sending a recovery mail: ${createErrorMessage(error)}`);\n      }\n    } else {\n      // Don't emit an error for privacy reasons\n      this.logger.warn(`Password reset request for unknown email ${email}`);\n    }\n\n    return { json: { email }};\n  }\n\n  /**\n   * Generates the link necessary for resetting the password and mails it to the given email address.\n   */\n  private async sendResetMail(recordId: string, email: string): Promise<void> {\n    this.logger.info(`Sending password reset to ${email}`);\n    const resetLink = `${this.resetRoute.getPath()}?rid=${encodeURIComponent(recordId)}`;\n    const renderedEmail = await this.templateEngine.handleSafe({ contents: { resetLink }});\n    await this.emailSender.handleSafe({\n      recipient: email,\n      subject: 'Reset your password',\n      text: `To reset your password, go to this link: ${resetLink}`,\n      html: renderedEmail,\n    });\n  }\n}\n"]}