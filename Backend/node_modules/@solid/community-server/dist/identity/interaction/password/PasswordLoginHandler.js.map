{"version":3,"file":"PasswordLoginHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/password/PasswordLoginHandler.ts"],"names":[],"mappings":";;;AAAA,6BAA8C;AAC9C,sDAAwD;AAOxD,sEAAmE;AACnE,wCAA4D;AAG5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,KAAK,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,KAAK,EAAE,CAAC,QAAQ,EAAE;IACzC,QAAQ,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;IACpC,QAAQ,EAAE,IAAA,aAAO,GAAE,CAAC,OAAO,CAAC,KAAK,CAAC;CACnC,CAAC,CAAC;AAQH;;GAEG;AACH,MAAa,oBAAqB,SAAQ,yCAAmB;IACxC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,aAAa,CAAgB;IAE9C,YAAmB,IAA8B;QAC/C,KAAK,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;QAC3C,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;IAC1C,CAAC;IAEM,KAAK,CAAC,OAAO;QAClB,OAAO,EAAE,IAAI,EAAE,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,KAAK,CAAC,EAAE,IAAI,EAA+B;QACtD,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QAC9E,qEAAqE;QACrE,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QAC7E,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,mBAAmB,KAAK,EAAE,CAAC,CAAC;QAE9C,OAAO,EAAE,IAAI,EAAE,EAAE,SAAS,EAAE,QAAQ,EAAE,EAAC,CAAC;IAC1C,CAAC;CACF;AAtBD,oDAsBC","sourcesContent":["import { boolean, object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { AccountStore } from '../account/util/AccountStore';\nimport type { CookieStore } from '../account/util/CookieStore';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport type { LoginOutputType } from '../login/ResolveLoginHandler';\nimport { ResolveLoginHandler } from '../login/ResolveLoginHandler';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { PasswordStore } from './util/PasswordStore';\n\nconst inSchema = object({\n  email: string().trim().email().required(),\n  password: string().trim().required(),\n  remember: boolean().default(false),\n});\n\nexport interface PasswordLoginHandlerArgs {\n  accountStore: AccountStore;\n  passwordStore: PasswordStore;\n  cookieStore: CookieStore;\n}\n\n/**\n * Handles the submission of the Login Form and logs the user in.\n */\nexport class PasswordLoginHandler extends ResolveLoginHandler implements JsonView {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly passwordStore: PasswordStore;\n\n  public constructor(args: PasswordLoginHandlerArgs) {\n    super(args.accountStore, args.cookieStore);\n    this.passwordStore = args.passwordStore;\n  }\n\n  public async getView(): Promise<JsonRepresentation> {\n    return { json: parseSchema(inSchema) };\n  }\n\n  public async login({ json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<LoginOutputType>> {\n    const { email, password, remember } = await validateWithError(inSchema, json);\n    // Try to log in, will error if email/password combination is invalid\n    const { accountId } = await this.passwordStore.authenticate(email, password);\n    this.logger.debug(`Logging in user ${email}`);\n\n    return { json: { accountId, remember }};\n  }\n}\n"]}