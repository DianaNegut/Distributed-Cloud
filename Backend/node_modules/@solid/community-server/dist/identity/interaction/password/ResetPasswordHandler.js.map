{"version":3,"file":"ResetPasswordHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/password/ResetPasswordHandler.ts"],"names":[],"mappings":";;;AAAA,6BAAqC;AACrC,sDAAwD;AACxD,kFAA+E;AAI/E,sEAAmE;AAEnE,wCAA4D;AAI5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,QAAQ,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAC3C,QAAQ,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;CACrC,CAAC,CAAC;AAEH;;;GAGG;AACH,MAAa,oBAAqB,SAAQ,+CAAmC;IACxD,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,aAAa,CAAgB;IAC7B,mBAAmB,CAAsB;IAE1D,YAAmB,aAA4B,EAAE,mBAAwC;QACvF,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;QACnC,IAAI,CAAC,mBAAmB,GAAG,mBAAmB,CAAC;IACjD,CAAC;IAEM,KAAK,CAAC,OAAO;QAClB,OAAO,EAAE,IAAI,EAAE,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,IAAI,EAA+B;QACvD,sBAAsB;QACtB,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QAEvE,MAAM,IAAI,CAAC,aAAa,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;QAC7C,OAAO,EAAE,IAAI,EAAE,EAAE,EAAC,CAAC;IACrB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,aAAa,CAAC,QAAgB,EAAE,WAAmB;QAC/D,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAExD,IAAI,CAAC,EAAE,EAAE,CAAC;YACR,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,kDAAkD,QAAQ,EAAE,CAAC,CAAC;YAC/E,MAAM,IAAI,yCAAmB,CAAC,8CAA8C,CAAC,CAAC;QAChF,CAAC;QAED,MAAM,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,EAAE,EAAE,WAAW,CAAC,CAAC;QACjD,MAAM,IAAI,CAAC,mBAAmB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAEhD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,gCAAgC,EAAE,EAAE,CAAC,CAAC;IAC1D,CAAC;CACF;AAxCD,oDAwCC","sourcesContent":["import { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../../util/errors/BadRequestHttpError';\nimport type { EmptyObject } from '../../../util/map/MapUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { ForgotPasswordStore } from './util/ForgotPasswordStore';\nimport type { PasswordStore } from './util/PasswordStore';\n\nconst inSchema = object({\n  recordId: string().trim().min(1).required(),\n  password: string().trim().required(),\n});\n\n/**\n * Resets a password if a valid `recordId` is provided,\n * which should have been generated by a different handler.\n */\nexport class ResetPasswordHandler extends JsonInteractionHandler<EmptyObject> implements JsonView {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly passwordStore: PasswordStore;\n  private readonly forgotPasswordStore: ForgotPasswordStore;\n\n  public constructor(passwordStore: PasswordStore, forgotPasswordStore: ForgotPasswordStore) {\n    super();\n    this.passwordStore = passwordStore;\n    this.forgotPasswordStore = forgotPasswordStore;\n  }\n\n  public async getView(): Promise<JsonRepresentation> {\n    return { json: parseSchema(inSchema) };\n  }\n\n  public async handle({ json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<EmptyObject>> {\n    // Validate input data\n    const { password, recordId } = await validateWithError(inSchema, json);\n\n    await this.resetPassword(recordId, password);\n    return { json: {}};\n  }\n\n  /**\n   * Resets the password for the account associated with the given recordId.\n   */\n  private async resetPassword(recordId: string, newPassword: string): Promise<void> {\n    const id = await this.forgotPasswordStore.get(recordId);\n\n    if (!id) {\n      this.logger.warn(`Trying to use invalid reset URL with record ID ${recordId}`);\n      throw new BadRequestHttpError('This reset password link is no longer valid.');\n    }\n\n    await this.passwordStore.update(id, newPassword);\n    await this.forgotPasswordStore.delete(recordId);\n\n    this.logger.debug(`Resetting password for login ${id}`);\n  }\n}\n"]}