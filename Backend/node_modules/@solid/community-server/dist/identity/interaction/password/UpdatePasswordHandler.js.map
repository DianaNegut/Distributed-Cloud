{"version":3,"file":"UpdatePasswordHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/password/UpdatePasswordHandler.ts"],"names":[],"mappings":";;;AAAA,6BAAqC;AACrC,sDAAwD;AACxD,kFAA+E;AAE/E,6DAAyE;AAGzE,sEAAmE;AAEnE,wCAA4D;AAI5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,WAAW,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAC9C,WAAW,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;CAC/C,CAAC,CAAC;AAEH;;GAEG;AACH,MAAa,qBAAsB,SAAQ,+CAAmC;IAC3D,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE5B,aAAa,CAAgB;IAC7B,aAAa,CAAkB;IAEhD,YAAmB,aAA4B,EAAE,aAA8B;QAC7E,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;QACnC,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;IACrC,CAAC;IAEM,KAAK,CAAC,OAAO;QAClB,OAAO,EAAE,IAAI,EAAE,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAkC;QACpD,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC;QAE1C,MAAM,EAAE,WAAW,EAAE,WAAW,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QAC7E,MAAM,KAAK,GAAG,IAAA,uBAAS,EAAC,IAAI,CAAC,aAAa,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;QAEzD,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAC7D,IAAA,6BAAe,EAAC,SAAS,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;QAE7C,wCAAwC;QACxC,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,KAAK,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;QAClE,CAAC;QAAC,MAAM,CAAC;YACP,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,mDAAmD,KAAK,CAAC,KAAK,EAAE,CAAC,CAAC;YACnF,MAAM,IAAI,yCAAmB,CAAC,0BAA0B,CAAC,CAAC;QAC5D,CAAC;QAED,MAAM,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC;QAE/D,OAAO,EAAE,IAAI,EAAE,EAAE,EAAC,CAAC;IACrB,CAAC;CACF;AArCD,sDAqCC","sourcesContent":["import { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../../util/errors/BadRequestHttpError';\nimport type { EmptyObject } from '../../../util/map/MapUtil';\nimport { parsePath, verifyAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { PasswordIdRoute } from './util/PasswordIdRoute';\nimport type { PasswordStore } from './util/PasswordStore';\n\nconst inSchema = object({\n  oldPassword: string().trim().min(1).required(),\n  newPassword: string().trim().min(1).required(),\n});\n\n/**\n * Allows the password of a login to be updated.\n */\nexport class UpdatePasswordHandler extends JsonInteractionHandler<EmptyObject> implements JsonView {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly passwordStore: PasswordStore;\n  private readonly passwordRoute: PasswordIdRoute;\n\n  public constructor(passwordStore: PasswordStore, passwordRoute: PasswordIdRoute) {\n    super();\n    this.passwordStore = passwordStore;\n    this.passwordRoute = passwordRoute;\n  }\n\n  public async getView(): Promise<JsonRepresentation> {\n    return { json: parseSchema(inSchema) };\n  }\n\n  public async handle(input: JsonInteractionHandlerInput): Promise<JsonRepresentation<EmptyObject>> {\n    const { target, accountId, json } = input;\n\n    const { oldPassword, newPassword } = await validateWithError(inSchema, json);\n    const match = parsePath(this.passwordRoute, target.path);\n\n    const login = await this.passwordStore.get(match.passwordId);\n    verifyAccountId(accountId, login?.accountId);\n\n    // Make sure the old password is correct\n    try {\n      await this.passwordStore.authenticate(login.email, oldPassword);\n    } catch {\n      this.logger.warn(`Invalid password when trying to reset for email ${login.email}`);\n      throw new BadRequestHttpError('Old password is invalid.');\n    }\n\n    await this.passwordStore.update(match.passwordId, newPassword);\n\n    return { json: {}};\n  }\n}\n"]}