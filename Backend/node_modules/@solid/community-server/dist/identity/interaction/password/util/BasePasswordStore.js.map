{"version":3,"file":"BasePasswordStore.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/password/util/BasePasswordStore.ts"],"names":[],"mappings":"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","sourcesContent":["import { compare, hash } from 'bcryptjs';\nimport { Initializer } from '../../../../init/Initializer';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../../../util/errors/BadRequestHttpError';\nimport { createErrorMessage } from '../../../../util/errors/ErrorUtil';\nimport { ForbiddenHttpError } from '../../../../util/errors/ForbiddenHttpError';\nimport { InternalServerError } from '../../../../util/errors/InternalServerError';\nimport { ACCOUNT_TYPE } from '../../account/util/LoginStorage';\nimport type { AccountLoginStorage } from '../../account/util/LoginStorage';\nimport type { PasswordStore } from './PasswordStore';\n\nexport const PASSWORD_STORAGE_TYPE = 'password';\nexport const PASSWORD_STORAGE_DESCRIPTION = {\n  email: 'string',\n  password: 'string',\n  verified: 'boolean',\n  accountId: `id:${ACCOUNT_TYPE}`,\n} as const;\n\n/**\n * A {@link PasswordStore} that uses a {@link KeyValueStorage} to store the entries.\n * Passwords are hashed and salted.\n * Default `saltRounds` is 10.\n */\nexport class BasePasswordStore extends Initializer implements PasswordStore {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly storage: AccountLoginStorage<{ [PASSWORD_STORAGE_TYPE]: typeof PASSWORD_STORAGE_DESCRIPTION }>;\n  private readonly saltRounds: number;\n  private initialized = false;\n\n  // Wrong typings to prevent Components.js typing issues\n  public constructor(storage: AccountLoginStorage<Record<string, never>>, saltRounds = 10) {\n    super();\n    this.storage = storage as unknown as typeof this.storage;\n    this.saltRounds = saltRounds;\n  }\n\n  // Initialize the type definitions\n  public async handle(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n    try {\n      await this.storage.defineType(PASSWORD_STORAGE_TYPE, PASSWORD_STORAGE_DESCRIPTION, true);\n      await this.storage.createIndex(PASSWORD_STORAGE_TYPE, 'accountId');\n      await this.storage.createIndex(PASSWORD_STORAGE_TYPE, 'email');\n      this.initialized = true;\n    } catch (cause: unknown) {\n      throw new InternalServerError(\n        `Error defining email/password in storage: ${createErrorMessage(cause)}`,\n        { cause },\n      );\n    }\n  }\n\n  public async create(email: string, accountId: string, password: string): Promise<string> {\n    if (await this.findByEmail(email)) {\n      this.logger.warn(`Trying to create duplicate login for email ${email}`);\n      throw new BadRequestHttpError('There already is a login for this e-mail address.');\n    }\n    const payload = await this.storage.create(PASSWORD_STORAGE_TYPE, {\n      accountId,\n      email: email.toLowerCase(),\n      password: await hash(password, this.saltRounds),\n      verified: false,\n    });\n    return payload.id;\n  }\n\n  public async get(id: string): Promise<{ email: string; accountId: string } | undefined> {\n    const result = await this.storage.get(PASSWORD_STORAGE_TYPE, id);\n    if (!result) {\n      return;\n    }\n    return { email: result.email, accountId: result.accountId };\n  }\n\n  public async findByEmail(email: string): Promise<{ accountId: string; id: string } | undefined> {\n    const payload = await this.storage.find(PASSWORD_STORAGE_TYPE, { email: email.toLowerCase() });\n    if (payload.length === 0) {\n      return;\n    }\n    return { accountId: payload[0].accountId, id: payload[0].id };\n  }\n\n  public async findByAccount(accountId: string): Promise<{ id: string; email: string }[]> {\n    return (await this.storage.find(PASSWORD_STORAGE_TYPE, { accountId }))\n      .map(({ id, email }): { id: string; email: string } => ({ id, email }));\n  }\n\n  public async confirmVerification(id: string): Promise<void> {\n    if (!await this.storage.has(PASSWORD_STORAGE_TYPE, id)) {\n      this.logger.warn(`Trying to verify unknown password login ${id}`);\n      throw new ForbiddenHttpError('Login does not exist.');\n    }\n\n    await this.storage.setField(PASSWORD_STORAGE_TYPE, id, 'verified', true);\n  }\n\n  public async authenticate(email: string, password: string): Promise<{ accountId: string; id: string }> {\n    const payload = await this.storage.find(PASSWORD_STORAGE_TYPE, { email: email.toLowerCase() });\n    if (payload.length === 0) {\n      this.logger.warn(`Trying to get account info for unknown email ${email}`);\n      throw new ForbiddenHttpError('Invalid email/password combination.');\n    }\n    if (!await compare(password, payload[0].password)) {\n      this.logger.warn(`Incorrect password for email ${email}`);\n      throw new ForbiddenHttpError('Invalid email/password combination.');\n    }\n    const { verified, accountId, id } = payload[0];\n    if (!verified) {\n      this.logger.warn(`Trying to get account info for unverified email ${email}`);\n      throw new ForbiddenHttpError('Login still needs to be verified.');\n    }\n    return { accountId, id };\n  }\n\n  public async update(id: string, password: string): Promise<void> {\n    if (!await this.storage.has(PASSWORD_STORAGE_TYPE, id)) {\n      this.logger.warn(`Trying to update unknown password login ${id}`);\n      throw new ForbiddenHttpError('Login does not exist.');\n    }\n    await this.storage.setField(PASSWORD_STORAGE_TYPE, id, 'password', await hash(password, this.saltRounds));\n  }\n\n  public async delete(id: string): Promise<void> {\n    return this.storage.delete(PASSWORD_STORAGE_TYPE, id);\n  }\n}\n"]}