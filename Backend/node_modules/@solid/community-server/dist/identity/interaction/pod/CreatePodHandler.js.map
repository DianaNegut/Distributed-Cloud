{"version":3,"file":"CreatePodHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/pod/CreatePodHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { StringSchema } from 'yup';\nimport { object, string } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport { assertAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport type { WebIdLinkRoute } from '../webid/WebIdLinkRoute';\nimport { parseSchema, URL_SCHEMA, validateWithError } from '../YupUtil';\nimport type { PodIdRoute } from './PodIdRoute';\nimport type { PodCreator } from './util/PodCreator';\nimport type { PodStore } from './util/PodStore';\n\nconst inSchema = object({\n  name: string().trim().min(1).optional(),\n  settings: object({\n    webId: URL_SCHEMA,\n  }).optional(),\n});\n\ntype OutType = {\n  pod: string;\n  podResource: string;\n  webId: string;\n  webIdResource?: string;\n};\n\n/**\n * Handles the creation of pods.\n * Will call the stored {@link PodCreator} with the settings found in the input JSON.\n */\nexport class CreatePodHandler extends JsonInteractionHandler<OutType> implements JsonView {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly podStore: PodStore;\n  private readonly podCreator: PodCreator;\n  private readonly webIdLinkRoute: WebIdLinkRoute;\n  private readonly podIdRoute: PodIdRoute;\n\n  private readonly inSchema: typeof inSchema;\n\n  public constructor(\n    podStore: PodStore,\n    podCreator: PodCreator,\n    webIdLinkRoute: WebIdLinkRoute,\n    podIdRoute: PodIdRoute,\n    allowRoot = false,\n  ) {\n    super();\n    this.podStore = podStore;\n    this.podCreator = podCreator;\n    this.webIdLinkRoute = webIdLinkRoute;\n    this.podIdRoute = podIdRoute;\n\n    this.inSchema = inSchema.clone();\n\n    if (!allowRoot) {\n      // Casting is necessary to prevent errors\n      this.inSchema.fields.name = (this.inSchema.fields.name as StringSchema).required();\n    }\n  }\n\n  public async getView({ accountId }: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    assertAccountId(accountId);\n    const pods: Record<string, string> = {};\n    for (const { id, baseUrl } of await this.podStore.findPods(accountId)) {\n      pods[baseUrl] = this.podIdRoute.getPath({ accountId, podId: id });\n    }\n    return { json: { ...parseSchema(this.inSchema), pods }};\n  }\n\n  public async handle({ json, accountId }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    // In case the class was not initialized with allowRoot: false, missing name values will result in an error\n    const { name, settings } = await validateWithError(inSchema, json);\n    assertAccountId(accountId);\n\n    const result = await this.podCreator.handleSafe({\n      accountId,\n      webId: settings?.webId,\n      name,\n      settings,\n    });\n\n    const webIdResource = result.webIdLink && this.webIdLinkRoute.getPath({ accountId, webIdLink: result.webIdLink });\n    const podResource = this.podIdRoute.getPath({ accountId, podId: result.podId });\n\n    return { json: { pod: result.podUrl, webId: result.webId, podResource, webIdResource }};\n  }\n}\n"]}