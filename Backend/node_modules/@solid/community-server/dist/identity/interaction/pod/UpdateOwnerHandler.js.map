{"version":3,"file":"UpdateOwnerHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/pod/UpdateOwnerHandler.ts"],"names":[],"mappings":";;;AAAA,6BAA8C;AAG9C,6DAAyE;AAGzE,sEAAmE;AAEnE,wCAA4D;AAI5D,MAAM,QAAQ,GAAG,IAAA,YAAM,EAAC;IACtB,KAAK,EAAE,IAAA,YAAM,GAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;IACjC,OAAO,EAAE,IAAA,aAAO,GAAE,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC;IAC5C,qCAAqC;IACrC,MAAM,EAAE,IAAA,aAAO,GAAE,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC;CAC5C,CAAC,CAAC;AAEH;;GAEG;AACH,MAAa,kBAAmB,SAAQ,+CAAsB;IAC3C,QAAQ,CAAW;IACnB,QAAQ,CAAa;IAEtC,YAAmB,QAAkB,EAAE,QAAoB;QACzD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;IAC3B,CAAC;IAEM,KAAK,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,MAAM,EAA+B;QACrE,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;QAC1D,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAErD,OAAO,EAAE,IAAI,EAAE,EAAE,GAAG,IAAA,qBAAW,EAAC,QAAQ,CAAC,EAAE,OAAO,EAAE,GAAG,EAAE,OAAO,EAAE,MAAM,EAAE,EAAC,CAAC;IAC9E,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAkC;QACpD,MAAM,EAAE,SAAS,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC;QAE1C,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,2BAAiB,EAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QAC3E,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;QAE1D,IAAI,MAAM,EAAE,CAAC;YACX,MAAM,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;QACjD,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;QAC1D,CAAC;QAED,OAAO,EAAE,IAAI,EAAE,EAAE,EAAC,CAAC;IACrB,CAAC;IAED;;;OAGG;IACO,KAAK,CAAC,eAAe,CAAC,MAA0B,EAAE,SAAkB;QAE5E,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,uBAAS,EAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;QACxD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC3C,IAAA,6BAAe,EAAC,SAAS,EAAE,GAAG,EAAE,SAAS,CAAC,CAAC;QAC3C,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,GAAG,GAAG,EAAE,CAAC;IAC/B,CAAC;CACF;AA3CD,gDA2CC","sourcesContent":["import { boolean, object, string } from 'yup';\nimport type { ResourceIdentifier } from '../../../http/representation/ResourceIdentifier';\nimport type { EmptyObject } from '../../../util/map/MapUtil';\nimport { parsePath, verifyAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport { parseSchema, validateWithError } from '../YupUtil';\nimport type { PodIdRoute } from './PodIdRoute';\nimport type { PodStore } from './util/PodStore';\n\nconst inSchema = object({\n  webId: string().trim().required(),\n  visible: boolean().optional().default(false),\n  // If true: remove the WebID as owner\n  remove: boolean().optional().default(false),\n});\n\n/**\n * Responsible for adding/updating/deleting owners in pods.\n */\nexport class UpdateOwnerHandler extends JsonInteractionHandler implements JsonView {\n  private readonly podStore: PodStore;\n  private readonly podRoute: PodIdRoute;\n\n  public constructor(podStore: PodStore, podRoute: PodIdRoute) {\n    super();\n    this.podStore = podStore;\n    this.podRoute = podRoute;\n  }\n\n  public async getView({ accountId, target }: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    const pod = await this.findVerifiedPod(target, accountId);\n    const owners = await this.podStore.getOwners(pod.id);\n\n    return { json: { ...parseSchema(inSchema), baseUrl: pod?.baseUrl, owners }};\n  }\n\n  public async handle(input: JsonInteractionHandlerInput): Promise<JsonRepresentation<EmptyObject>> {\n    const { accountId, target, json } = input;\n\n    const { webId, visible, remove } = await validateWithError(inSchema, json);\n    const pod = await this.findVerifiedPod(target, accountId);\n\n    if (remove) {\n      await this.podStore.removeOwner(pod.id, webId);\n    } else {\n      await this.podStore.updateOwner(pod.id, webId, visible);\n    }\n\n    return { json: {}};\n  }\n\n  /**\n   * Extract the pod ID from the path and find the associated pod.\n   * Asserts that the given account ID is the creator of this pod.\n   */\n  protected async findVerifiedPod(target: ResourceIdentifier, accountId?: string):\n  Promise<{ id: string; baseUrl: string; accountId: string }> {\n    const { podId } = parsePath(this.podRoute, target.path);\n    const pod = await this.podStore.get(podId);\n    verifyAccountId(accountId, pod?.accountId);\n    return { id: podId, ...pod };\n  }\n}\n"]}