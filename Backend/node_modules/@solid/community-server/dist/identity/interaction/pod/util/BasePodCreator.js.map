{"version":3,"file":"BasePodCreator.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/pod/util/BasePodCreator.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ResourceIdentifier } from '../../../../http/representation/ResourceIdentifier';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport type { IdentifierGenerator } from '../../../../pods/generate/IdentifierGenerator';\nimport type { PodSettings } from '../../../../pods/settings/PodSettings';\nimport { BadRequestHttpError } from '../../../../util/errors/BadRequestHttpError';\nimport { joinUrl } from '../../../../util/PathUtil';\nimport type { WebIdStore } from '../../webid/util/WebIdStore';\nimport { PodCreator } from './PodCreator';\nimport type { PodCreatorInput, PodCreatorOutput } from './PodCreator';\nimport type { PodStore } from './PodStore';\n\nexport interface BasePodCreatorArgs {\n  /**\n   * Base URL of the server.\n   * Used to potentially set the `solid:oidcIssuer` triple\n   * and/or the pod URL if it is a root pod.\n   */\n  baseUrl: string;\n  /**\n   * Generates the base URL of the pod based on the input `name`.\n   */\n  identifierGenerator: IdentifierGenerator;\n  /**\n   * The path of where the WebID will be generated by the template, relative to the pod URL.\n   */\n  relativeWebIdPath: string;\n  /**\n   * WebID data store.\n   */\n  webIdStore: WebIdStore;\n  /**\n   * Pod data store.\n   */\n  podStore: PodStore;\n}\n\n/**\n * Handles the creation of pods.\n * Will call the stored {@link PodStore} with the provided settings.\n */\nexport class BasePodCreator extends PodCreator {\n  protected readonly logger = getLoggerFor(this);\n\n  protected readonly baseUrl: string;\n  protected readonly identifierGenerator: IdentifierGenerator;\n  protected readonly relativeWebIdPath: string;\n  protected readonly webIdStore: WebIdStore;\n  protected readonly podStore: PodStore;\n\n  public constructor(args: BasePodCreatorArgs) {\n    super();\n    this.baseUrl = args.baseUrl;\n    this.identifierGenerator = args.identifierGenerator;\n    this.relativeWebIdPath = args.relativeWebIdPath;\n    this.webIdStore = args.webIdStore;\n    this.podStore = args.podStore;\n  }\n\n  public async handle(input: PodCreatorInput): Promise<PodCreatorOutput> {\n    const baseIdentifier = this.generateBaseIdentifier(input.name);\n    // Either the input WebID or the one generated in the pod\n    const webId = input.webId ?? joinUrl(baseIdentifier.path, this.relativeWebIdPath);\n\n    const podSettings: PodSettings = {\n      ...input.settings,\n      base: baseIdentifier,\n      webId,\n    };\n\n    // Link the WebID to the account immediately if no WebID was provided as this is expected behaviour.\n    // We do this first as we can't undo creating the pod if this would fail.\n    // If an external WebID is the owner we do not want to link it to the account automatically\n    const webIdLink = await this.handleWebId(!input.webId, webId, input.accountId, podSettings);\n\n    // Create the pod\n    const podId = await this.createPod(input.accountId, podSettings, !input.name, webIdLink);\n\n    return {\n      podUrl: baseIdentifier.path,\n      webId,\n      podId,\n      webIdLink,\n    };\n  }\n\n  protected generateBaseIdentifier(name?: string): ResourceIdentifier {\n    if (name) {\n      return this.identifierGenerator.generate(name);\n    }\n    return { path: this.baseUrl };\n  }\n\n  /**\n   * Links the WebID to the account if `linkWebId` is true.\n   * Also updates the `oidcIssuer` value in the settings object in that case.\n   */\n  protected async handleWebId(linkWebId: boolean, webId: string, accountId: string, settings: PodSettings):\n  Promise<string | undefined> {\n    if (linkWebId) {\n      // It is important that this check happens here.\n      // Otherwise, if the account already has this WebID link,\n      // this link would be deleted if pod creation fails,\n      // since we clean up the WebID link again afterwards.\n      // Current implementation of the {@link WebIdStore} also has this check but better safe than sorry.\n      if (await this.webIdStore.isLinked(webId, accountId)) {\n        this.logger.warn('Trying to create pod which would generate a WebID that is already linked to this account');\n        throw new BadRequestHttpError(`${webId} is already registered to this account.`);\n      }\n      // Need to have the necessary `solid:oidcIssuer` triple if the WebID is linked\n      settings.oidcIssuer = this.baseUrl;\n\n      return this.webIdStore.create(webId, accountId);\n    }\n  }\n\n  /**\n   * Creates a pod with the given settings.\n   * In case pod creation fails, the given WebID link will be removed, if there is one, before throwing an error.\n   */\n  protected async createPod(accountId: string, settings: PodSettings, overwrite: boolean, webIdLink?: string):\n  Promise<string> {\n    try {\n      return await this.podStore.create(accountId, settings, overwrite);\n    } catch (error: unknown) {\n      // Undo the WebID linking if pod creation fails\n      if (webIdLink) {\n        await this.webIdStore.delete(webIdLink);\n      }\n      throw error;\n    }\n  }\n}\n"]}