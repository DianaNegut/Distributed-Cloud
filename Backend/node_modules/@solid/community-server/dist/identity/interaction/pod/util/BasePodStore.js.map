{"version":3,"file":"BasePodStore.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/pod/util/BasePodStore.ts"],"names":[],"mappings":"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","sourcesContent":["import { Initializer } from '../../../../init/Initializer';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport type { PodManager } from '../../../../pods/PodManager';\nimport type { PodSettings } from '../../../../pods/settings/PodSettings';\nimport { BadRequestHttpError } from '../../../../util/errors/BadRequestHttpError';\nimport { createErrorMessage } from '../../../../util/errors/ErrorUtil';\nimport { InternalServerError } from '../../../../util/errors/InternalServerError';\nimport { ACCOUNT_TYPE } from '../../account/util/LoginStorage';\nimport type { AccountLoginStorage } from '../../account/util/LoginStorage';\nimport type { PodStore } from './PodStore';\n\nexport const POD_STORAGE_TYPE = 'pod';\nexport const POD_STORAGE_DESCRIPTION = {\n  baseUrl: 'string',\n  accountId: `id:${ACCOUNT_TYPE}`,\n} as const;\n\nexport const OWNER_STORAGE_TYPE = 'owner';\nexport const OWNER_STORAGE_DESCRIPTION = {\n  webId: 'string',\n  visible: 'boolean',\n  podId: `id:${POD_STORAGE_TYPE}`,\n} as const;\n\n/**\n * A {@link PodStore} implementation using a {@link PodManager} to create pods\n * and a {@link AccountLoginStorage} to store the data.\n * Needs to be initialized before it can be used.\n *\n * Adds the initial WebID as the owner of the pod.\n * By default, this owner is not exposed through a link header.\n * This can be changed by setting the constructor `visible` parameter to `true`.\n */\nexport class BasePodStore extends Initializer implements PodStore {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly storage: AccountLoginStorage<{\n    [POD_STORAGE_TYPE]: typeof POD_STORAGE_DESCRIPTION;\n    [OWNER_STORAGE_TYPE]: typeof OWNER_STORAGE_DESCRIPTION;\n  }>;\n\n  private readonly manager: PodManager;\n  private readonly visible: boolean;\n\n  private initialized = false;\n\n  // Wrong typings to prevent Components.js typing issues\n  public constructor(storage: AccountLoginStorage<Record<string, never>>, manager: PodManager, visible = false) {\n    super();\n    this.storage = storage as unknown as typeof this.storage;\n    this.visible = visible;\n    this.manager = manager;\n  }\n\n  // Initialize the type definitions\n  public async handle(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n    try {\n      await this.storage.defineType(POD_STORAGE_TYPE, POD_STORAGE_DESCRIPTION, false);\n      await this.storage.createIndex(POD_STORAGE_TYPE, 'accountId');\n      await this.storage.createIndex(POD_STORAGE_TYPE, 'baseUrl');\n      await this.storage.defineType(OWNER_STORAGE_TYPE, OWNER_STORAGE_DESCRIPTION, false);\n      await this.storage.createIndex(OWNER_STORAGE_TYPE, 'podId');\n      this.initialized = true;\n    } catch (cause: unknown) {\n      throw new InternalServerError(`Error defining pods in storage: ${createErrorMessage(cause)}`, { cause });\n    }\n  }\n\n  public async create(accountId: string, settings: PodSettings, overwrite: boolean): Promise<string> {\n    // Adding pod to storage first as we cannot undo creating the pod below.\n    // This call might also fail because there is no login method yet on the account.\n    const pod = await this.storage.create(POD_STORAGE_TYPE, { baseUrl: settings.base.path, accountId });\n    await this.storage.create(OWNER_STORAGE_TYPE, { podId: pod.id, webId: settings.webId, visible: this.visible });\n\n    try {\n      await this.manager.createPod(settings, overwrite);\n    } catch (error: unknown) {\n      this.logger.warn(`Pod creation failed for account ${accountId}: ${createErrorMessage(error)}`);\n      await this.storage.delete(POD_STORAGE_TYPE, pod.id);\n      throw new BadRequestHttpError(`Pod creation failed: ${createErrorMessage(error)}`, { cause: error });\n    }\n    this.logger.debug(`Created pod ${settings.name} for account ${accountId}`);\n\n    return pod.id;\n  }\n\n  public async get(id: string): Promise<{ baseUrl: string; accountId: string } | undefined> {\n    const pod = await this.storage.get(POD_STORAGE_TYPE, id);\n    if (!pod) {\n      return;\n    }\n    return { baseUrl: pod.baseUrl, accountId: pod.accountId };\n  }\n\n  public async findByBaseUrl(baseUrl: string): Promise<{ id: string; accountId: string } | undefined> {\n    const result = await this.storage.find(POD_STORAGE_TYPE, { baseUrl });\n    if (result.length === 0) {\n      return;\n    }\n    return { id: result[0].id, accountId: result[0].accountId };\n  }\n\n  public async findPods(accountId: string): Promise<{ id: string; baseUrl: string }[]> {\n    return (await this.storage.find(POD_STORAGE_TYPE, { accountId }))\n      .map(({ id, baseUrl }): { id: string; baseUrl: string } => ({ id, baseUrl }));\n  }\n\n  public async getOwners(id: string): Promise<{ webId: string; visible: boolean }[] | undefined> {\n    const results = await this.storage.find(OWNER_STORAGE_TYPE, { podId: id });\n    if (results.length === 0) {\n      return;\n    }\n    return results.map((result): { webId: string; visible: boolean } =>\n      ({ webId: result.webId, visible: result.visible }));\n  }\n\n  public async updateOwner(id: string, webId: string, visible: boolean): Promise<void> {\n    // Need to first check if there already is an owner with the given WebID\n    // so we know if we need to create or update.\n    const matches = await this.storage.find(OWNER_STORAGE_TYPE, { webId, podId: id });\n    if (matches.length === 0) {\n      await this.storage.create(OWNER_STORAGE_TYPE, { webId, visible, podId: id });\n    } else {\n      await this.storage.setField(OWNER_STORAGE_TYPE, matches[0].id, 'visible', visible);\n    }\n  }\n\n  public async removeOwner(id: string, webId: string): Promise<void> {\n    const owners = await this.storage.find(OWNER_STORAGE_TYPE, { podId: id });\n    const match = owners.find((owner): boolean => owner.webId === webId);\n    if (!match) {\n      return;\n    }\n    if (owners.length === 1) {\n      throw new BadRequestHttpError('Unable to remove the last owner of a pod.');\n    }\n    await this.storage.delete(OWNER_STORAGE_TYPE, match.id);\n  }\n}\n"]}