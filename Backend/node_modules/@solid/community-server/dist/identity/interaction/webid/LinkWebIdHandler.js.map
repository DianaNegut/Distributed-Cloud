{"version":3,"file":"LinkWebIdHandler.js","sourceRoot":"","sources":["../../../../src/identity/interaction/webid/LinkWebIdHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { object } from 'yup';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { StorageLocationStrategy } from '../../../server/description/StorageLocationStrategy';\nimport { BadRequestHttpError } from '../../../util/errors/BadRequestHttpError';\nimport type { OwnershipValidator } from '../../ownership/OwnershipValidator';\nimport { assertAccountId } from '../account/util/AccountUtil';\nimport type { JsonRepresentation } from '../InteractionUtil';\nimport { JsonInteractionHandler } from '../JsonInteractionHandler';\nimport type { JsonInteractionHandlerInput } from '../JsonInteractionHandler';\nimport type { JsonView } from '../JsonView';\nimport type { PodStore } from '../pod/util/PodStore';\nimport { parseSchema, URL_SCHEMA, validateWithError } from '../YupUtil';\nimport type { WebIdStore } from './util/WebIdStore';\nimport type { WebIdLinkRoute } from './WebIdLinkRoute';\n\nconst inSchema = object({\n  webId: URL_SCHEMA.required(),\n});\n\ntype OutType = {\n  resource: string;\n  webId: string;\n  oidcIssuer: string;\n};\n\nexport interface LinkWebIdHandlerArgs {\n  /**\n   * Base URL of the server.\n   * Used to indicate in the response what the object of the `solid:oidcIssuer` triple should be.\n   */\n  baseUrl: string;\n  /**\n   * Validates whether the user trying to link the WebID is the actual owner of that WebID.\n   */\n  ownershipValidator: OwnershipValidator;\n  /**\n   * Pod store to find out if the account created the pod containing the WebID.\n   */\n  podStore: PodStore;\n  /**\n   * WebID store to store WebID links.\n   */\n  webIdStore: WebIdStore;\n  /**\n   * Route used to generate the WebID link resource URL.\n   */\n  webIdRoute: WebIdLinkRoute;\n  /**\n   * Before calling the {@link OwnershipValidator}, we first check if the target WebID is in a pod owned by the user.\n   */\n  storageStrategy: StorageLocationStrategy;\n}\n\n/**\n * Handles the linking of WebIDs to account,\n * thereby registering them to the server IDP.\n */\nexport class LinkWebIdHandler extends JsonInteractionHandler<OutType> implements JsonView {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly baseUrl: string;\n  private readonly ownershipValidator: OwnershipValidator;\n  private readonly podStore: PodStore;\n  private readonly webIdStore: WebIdStore;\n  private readonly webIdRoute: WebIdLinkRoute;\n  private readonly storageStrategy: StorageLocationStrategy;\n\n  public constructor(args: LinkWebIdHandlerArgs) {\n    super();\n    this.baseUrl = args.baseUrl;\n    this.ownershipValidator = args.ownershipValidator;\n    this.podStore = args.podStore;\n    this.webIdStore = args.webIdStore;\n    this.webIdRoute = args.webIdRoute;\n    this.storageStrategy = args.storageStrategy;\n  }\n\n  public async getView({ accountId }: JsonInteractionHandlerInput): Promise<JsonRepresentation> {\n    assertAccountId(accountId);\n    const webIdLinks: Record<string, string> = {};\n    for (const { id, webId } of await this.webIdStore.findLinks(accountId)) {\n      webIdLinks[webId] = this.webIdRoute.getPath({ accountId, webIdLink: id });\n    }\n    return { json: { ...parseSchema(inSchema), webIdLinks }};\n  }\n\n  public async handle({ accountId, json }: JsonInteractionHandlerInput): Promise<JsonRepresentation<OutType>> {\n    assertAccountId(accountId);\n\n    const { webId } = await validateWithError(inSchema, json);\n\n    if (await this.webIdStore.isLinked(webId, accountId)) {\n      this.logger.warn(`Trying to link WebID ${webId} to account ${accountId} which already has this link`);\n      throw new BadRequestHttpError(`${webId} is already registered to this account.`);\n    }\n\n    // Only need to check ownership if the account did not create the pod\n    let isCreator = false;\n    try {\n      const baseUrl = await this.storageStrategy.getStorageIdentifier({ path: webId });\n      const pod = await this.podStore.findByBaseUrl(baseUrl.path);\n      isCreator = accountId === pod?.accountId;\n    } catch {\n      // Probably a WebID not hosted on the server\n    }\n\n    if (!isCreator) {\n      await this.ownershipValidator.handleSafe({ webId });\n    }\n\n    const webIdLink = await this.webIdStore.create(webId, accountId);\n    const resource = this.webIdRoute.getPath({ accountId, webIdLink });\n\n    return { json: { resource, webId, oidcIssuer: this.baseUrl }};\n  }\n}\n"]}