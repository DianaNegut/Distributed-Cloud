{"version":3,"file":"BaseWebIdStore.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/webid/util/BaseWebIdStore.ts"],"names":[],"mappings":"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","sourcesContent":["import { Initializer } from '../../../../init/Initializer';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport { BadRequestHttpError } from '../../../../util/errors/BadRequestHttpError';\nimport { createErrorMessage } from '../../../../util/errors/ErrorUtil';\nimport { InternalServerError } from '../../../../util/errors/InternalServerError';\nimport { ACCOUNT_TYPE } from '../../account/util/LoginStorage';\nimport type { AccountLoginStorage } from '../../account/util/LoginStorage';\nimport type { WebIdStore } from './WebIdStore';\n\nexport const WEBID_STORAGE_TYPE = 'webIdLink';\nexport const WEBID_STORAGE_DESCRIPTION = {\n  webId: 'string',\n  accountId: `id:${ACCOUNT_TYPE}`,\n} as const;\n\n/**\n * A {@link WebIdStore} using a {@link AccountLoginStorage} to store the links.\n * Needs to be initialized before it can be used.\n */\nexport class BaseWebIdStore extends Initializer implements WebIdStore {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly storage: AccountLoginStorage<{ [WEBID_STORAGE_TYPE]: typeof WEBID_STORAGE_DESCRIPTION }>;\n  private initialized = false;\n\n  // Wrong typings to prevent Components.js typing issues\n  public constructor(storage: AccountLoginStorage<Record<string, never>>) {\n    super();\n    this.storage = storage as unknown as typeof this.storage;\n  }\n\n  // Initialize the type definitions\n  public async handle(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n    try {\n      await this.storage.defineType(WEBID_STORAGE_TYPE, WEBID_STORAGE_DESCRIPTION, false);\n      await this.storage.createIndex(WEBID_STORAGE_TYPE, 'accountId');\n      await this.storage.createIndex(WEBID_STORAGE_TYPE, 'webId');\n      this.initialized = true;\n    } catch (cause: unknown) {\n      throw new InternalServerError(\n        `Error defining WebID links in storage: ${createErrorMessage(cause)}`,\n        { cause },\n      );\n    }\n  }\n\n  public async get(id: string): Promise<{ accountId: string; webId: string } | undefined> {\n    return this.storage.get(WEBID_STORAGE_TYPE, id);\n  }\n\n  public async isLinked(webId: string, accountId: string): Promise<boolean> {\n    const result = await this.storage.find(WEBID_STORAGE_TYPE, { webId, accountId });\n    return result.length > 0;\n  }\n\n  public async findLinks(accountId: string): Promise<{ id: string; webId: string }[]> {\n    return (await this.storage.find(WEBID_STORAGE_TYPE, { accountId }))\n      .map(({ id, webId }): { id: string; webId: string } => ({ id, webId }));\n  }\n\n  public async create(webId: string, accountId: string): Promise<string> {\n    if (await this.isLinked(webId, accountId)) {\n      this.logger.warn(`Trying to link WebID ${webId} which is already linked to this account ${accountId}`);\n      throw new BadRequestHttpError(`${webId} is already registered to this account.`);\n    }\n\n    const result = await this.storage.create(WEBID_STORAGE_TYPE, { webId, accountId });\n\n    this.logger.debug(`Linked WebID ${webId} to account ${accountId}`);\n\n    return result.id;\n  }\n\n  public async delete(linkId: string): Promise<void> {\n    this.logger.debug(`Deleting WebID link with ID ${linkId}`);\n    return this.storage.delete(WEBID_STORAGE_TYPE, linkId);\n  }\n}\n"]}