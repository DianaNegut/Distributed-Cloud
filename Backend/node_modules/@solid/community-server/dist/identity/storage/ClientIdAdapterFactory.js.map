{"version":3,"file":"ClientIdAdapterFactory.js","sourceRoot":"","sources":["../../../src/identity/storage/ClientIdAdapterFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Response } from 'cross-fetch';\nimport { fetch } from 'cross-fetch';\nimport type { Quad } from 'n3';\nimport type { Adapter, AdapterPayload } from '../../../templates/types/oidc-provider';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport type { RepresentationConverter } from '../../storage/conversion/RepresentationConverter';\nimport { createErrorMessage } from '../../util/errors/ErrorUtil';\nimport { responseToDataset } from '../../util/FetchUtil';\nimport { hasScheme } from '../../util/HeaderUtil';\nimport { OIDC } from '../../util/Vocabularies';\nimport type { AdapterFactory } from './AdapterFactory';\nimport { PassthroughAdapter, PassthroughAdapterFactory } from './PassthroughAdapterFactory';\n\n/**\n * This {@link Adapter} redirects the `find` call to its source adapter.\n * In case no client data was found in the source for the given Client ID,\n * this class will do an HTTP GET request to that Client ID.\n * If the result is a valid Client ID document, that will be returned instead.\n *\n * See https://solidproject.org/TR/2022/oidc-20220328#clientids-document.\n */\nexport class ClientIdAdapter extends PassthroughAdapter {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly converter: RepresentationConverter;\n\n  public constructor(name: string, source: Adapter, converter: RepresentationConverter) {\n    super(name, source);\n    this.converter = converter;\n  }\n\n  public async find(id: string): Promise<AdapterPayload | void> {\n    let payload = await this.source.find(id);\n\n    // No payload is stored for the given Client ID.\n    // Try to see if valid client metadata is found at the given Client ID.\n    // The oidc-provider library will check if the redirect_uri matches an entry in the list of redirect_uris,\n    // so no extra checks are needed from our side.\n    if (!payload && this.name === 'Client' && hasScheme(id, 'http', 'https')) {\n      this.logger.debug(`Looking for payload data at ${id}`);\n      if (!/^https:|^http:\\/\\/localhost(?::\\d+)?(?:\\/|$)/u.test(id)) {\n        throw new Error(`SSL is required for client_id authentication unless working locally.`);\n      }\n      const response = await fetch(id);\n      if (response.status !== 200) {\n        throw new Error(`Unable to access data at ${id}: ${await response.text()}`);\n      }\n      const data = await response.text();\n      let json: Record<string, unknown> | undefined;\n      try {\n        json = JSON.parse(data) as Record<string, unknown>;\n        const contexts = Array.isArray(json['@context']) ? json['@context'] : [ json['@context'] ];\n        // We can only parse as simple JSON if the @context is correct\n        if (!contexts.includes('https://www.w3.org/ns/solid/oidc-context.jsonld')) {\n          throw new Error('Missing context https://www.w3.org/ns/solid/oidc-context.jsonld');\n        }\n      } catch (error: unknown) {\n        json = undefined;\n        this.logger.debug(`Found unexpected client ID for ${id}: ${createErrorMessage(error)}`);\n      }\n\n      if (json) {\n        // Need to make sure the document is about the id\n        if (json.client_id !== id) {\n          throw new Error('The client registration `client_id` field must match the client ID');\n        }\n        payload = json;\n      } else {\n        // Since the client ID does not match the default JSON-LD we try to interpret it as RDF\n        payload = await this.parseRdfClientId(data, id, response);\n      }\n\n      // `token_endpoint_auth_method: 'none'` prevents oidc-provider from requiring a client_secret\n      // eslint-disable-next-line ts/naming-convention\n      payload = { ...payload, token_endpoint_auth_method: 'none' };\n    }\n\n    // Will also be returned if no valid client data was found above\n    return payload;\n  }\n\n  /**\n   * Parses RDF data found at a Client ID.\n   *\n   * @param data - Raw data from the Client ID.\n   * @param id - The actual Client ID.\n   * @param response - Response object from the request.\n   */\n  private async parseRdfClientId(data: string, id: string, response: Response): Promise<AdapterPayload> {\n    const representation = await responseToDataset(response, this.converter, data);\n\n    // Find the valid redirect URIs\n    const redirectUris: string[] = [];\n    for await (const entry of representation.data) {\n      const triple = entry as Quad;\n      if (triple.predicate.equals(OIDC.terms.redirect_uris)) {\n        redirectUris.push(triple.object.value);\n      }\n    }\n\n    /* eslint-disable ts/naming-convention */\n    return {\n      client_id: id,\n      redirect_uris: redirectUris,\n    };\n    /* eslint-enable ts/naming-convention */\n  }\n}\n\nexport class ClientIdAdapterFactory extends PassthroughAdapterFactory {\n  private readonly converter: RepresentationConverter;\n\n  public constructor(source: AdapterFactory, converter: RepresentationConverter) {\n    super(source);\n    this.converter = converter;\n  }\n\n  public createStorageAdapter(name: string): Adapter {\n    return new ClientIdAdapter(name, this.source.createStorageAdapter(name), this.converter);\n  }\n}\n"]}