{"version":3,"file":"AppRunner.js","sourceRoot":"","sources":["../../src/init/AppRunner.ts"],"names":[],"mappings":"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","sourcesContent":["import { existsSync } from 'node:fs';\nimport type { WriteStream } from 'node:tty';\nimport type { IComponentsManagerBuilderOptions } from 'componentsjs';\nimport { ComponentsManager } from 'componentsjs';\nimport { readJSON } from 'fs-extra';\nimport yargs from 'yargs';\nimport { LOG_LEVELS } from '../logging/LogLevel';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { createErrorMessage, isError } from '../util/errors/ErrorUtil';\nimport { InternalServerError } from '../util/errors/InternalServerError';\nimport { joinFilePath, resolveAssetPath, resolveModulePath } from '../util/PathUtil';\nimport type { App } from './App';\nimport type { CliExtractor } from './cli/CliExtractor';\nimport type { CliResolver } from './CliResolver';\nimport { listSingleThreadedComponents } from './cluster/SingleThreaded';\nimport type { ShorthandResolver } from './variables/ShorthandResolver';\nimport type { CliArgv, Shorthand, VariableBindings } from './variables/Types';\n\nconst DEFAULT_CONFIG = resolveModulePath('config/default.json');\n\nconst DEFAULT_CLI_RESOLVER = 'urn:solid-server-app-setup:default:CliResolver';\nconst DEFAULT_APP = 'urn:solid-server:default:App';\n\nconst CORE_CLI_PARAMETERS = {\n  config: { type: 'array', alias: 'c', default: [ DEFAULT_CONFIG ], requiresArg: true },\n  loggingLevel: { type: 'string', alias: 'l', default: 'info', requiresArg: true, choices: LOG_LEVELS },\n  mainModulePath: { type: 'string', alias: 'm', requiresArg: true },\n} as const;\n\nconst ENV_VAR_PREFIX = 'CSS';\n\n/**\n * Parameters that can be used to instantiate the server through code.\n */\nexport interface AppRunnerInput {\n  /**\n   * Properties that will be used when building the Components.js manager.\n   * Default values:\n   *  - `typeChecking`: `false`, as the server components would otherwise error.\n   *  - `mainModulePath`: `@css:`, which resolves to the directory of the CSS package.\n   *                      This is useful for packages that depend on the CSS\n   *                      but do not create any new modules themselves.\n   */\n  loaderProperties?: Partial<IComponentsManagerBuilderOptions<App>>;\n  /**\n   * Path to the server config file(s). Defaults to `@css:config/default.json`.\n   */\n  config?: string | string[];\n  /**\n   * Values to apply to the Components.js variables.\n   * These are the variables CLI values will be converted to.\n   * The keys should be the variable URIs.\n   * E.g.: `{ 'urn:solid-server:default:variable:rootFilePath': '.data' }`.\n   */\n  variableBindings?: VariableBindings;\n  /**\n   * CLI argument names and their corresponding values.\n   * E.g.: `{ rootFilePath: '.data' }`.\n   * Abbreviated parameter names can not be used, so `{ f: '.data' }` would not work.\n   *\n   * In case both `shorthand` and `variableBindings` have entries that would result in a value for the same variable,\n   * `variableBindings` has priority.\n   */\n  shorthand?: Shorthand;\n  /**\n   * An array containing CLI arguments passed to start the process.\n   * Entries here have the lowest priority for assigning values to variables.\n   */\n  argv?: string[];\n}\n\n/**\n * A class that can be used to instantiate and start a server based on a Component.js configuration.\n */\nexport class AppRunner {\n  private readonly logger = getLoggerFor(this);\n\n  /**\n   * Starts the server with a given config.\n   *\n   * @param input - All values necessary to configure the server.\n   */\n  public async run(input: AppRunnerInput): Promise<void> {\n    const app = await this.create(input);\n    await app.start();\n  }\n\n  /**\n   * Returns an App object, created with the given config, that can start and stop the Solid server.\n   *\n   * @param input - All values necessary to configure the server.\n   */\n  public async create(input: AppRunnerInput = {}): Promise<App> {\n    const loaderProperties = {\n      typeChecking: false,\n      mainModulePath: '@css:',\n      dumpErrorState: false,\n      ...input.loaderProperties,\n    };\n    // Expand mainModulePath as needed\n    loaderProperties.mainModulePath = resolveAssetPath(loaderProperties.mainModulePath);\n\n    // Potentially expand config paths as needed\n    let configs = input.config ?? [ '@css:config/default.json' ];\n    configs = (Array.isArray(configs) ? configs : [ configs ]).map(resolveAssetPath);\n\n    let componentsManager: ComponentsManager<App | CliResolver>;\n    try {\n      componentsManager = await this.createComponentsManager<App>(loaderProperties, configs);\n    } catch (error: unknown) {\n      this.resolveError(`Could not build the config files from ${configs.join(',')}`, error);\n    }\n\n    const cliResolver = await this.createCliResolver(componentsManager as ComponentsManager<CliResolver>);\n    let extracted: Shorthand = {};\n    if (input.argv) {\n      extracted = await this.extractShorthand(cliResolver.cliExtractor, input.argv);\n    }\n    const parsedVariables = await this.resolveShorthand(cliResolver.shorthandResolver, {\n      ...extracted,\n      ...input.shorthand,\n    });\n\n    // Create the application using the translated variable values.\n    // `variableBindings` override those resolved from the `shorthand` input.\n    return this.createApp(\n      componentsManager as ComponentsManager<App>,\n      { ...parsedVariables, ...input.variableBindings },\n    );\n  }\n\n  /**\n   * Starts the server as a command-line application.\n   * Will exit the process on failure.\n   *\n   * Made non-async to lower the risk of unhandled promise rejections.\n   * This is only relevant when this is used to start as a Node.js application on its own,\n   * if you use this as part of your code you probably want to use the async version.\n   *\n   * @param argv - Input parameters.\n   * @param argv.argv - Command line arguments.\n   * @param argv.stderr - Stream that should be used to output errors before the logger is enabled.\n   */\n  public runCliSync({ argv, stderr = process.stderr }: { argv?: CliArgv; stderr?: WriteStream }): void {\n    this.runCli(argv).catch((error): never => {\n      stderr.write(createErrorMessage(error));\n      // eslint-disable-next-line unicorn/no-process-exit\n      process.exit(1);\n    });\n  }\n\n  /**\n   * Starts the server as a command-line application.\n   *\n   * @param argv - Command line arguments.\n   */\n  public async runCli(argv?: CliArgv): Promise<void> {\n    const app = await this.createCli(argv);\n    try {\n      await app.start();\n    } catch (error: unknown) {\n      this.logger.error(`Could not start the server: ${createErrorMessage(error)}`);\n      this.resolveError('Could not start the server', error);\n    }\n  }\n\n  /**\n   * Returns an App object, created by parsing the Command line arguments, that can start and stop the Solid server.\n   * Will exit the process on failure.\n   *\n   * @param argv - Command line arguments.\n   */\n  public async createCli(argv: CliArgv = process.argv): Promise<App> {\n    // Parse only the core CLI arguments needed to load the configuration\n    let yargv = yargs(argv.slice(2))\n      .usage('node ./bin/server.js [args]')\n      .options(CORE_CLI_PARAMETERS)\n      // We disable help here as it would only show the core parameters\n      .help(false)\n      // We also read from environment variables\n      .env(ENV_VAR_PREFIX);\n\n    const settings = await this.getPackageSettings();\n    if (typeof settings !== 'undefined') {\n      yargv = yargv.default<object>(settings);\n    }\n\n    const params = await yargv.parse();\n\n    const loaderProperties: AppRunnerInput['loaderProperties'] = {\n      mainModulePath: params.mainModulePath,\n      logLevel: params.loggingLevel,\n    };\n\n    return this.create({\n      loaderProperties,\n      config: params.config as string[],\n      argv,\n      shorthand: settings,\n    });\n  }\n\n  /**\n   * Retrieves settings from package.json or configuration file when\n   * part of an npm project.\n   *\n   * @returns The settings defined in the configuration file\n   */\n  public async getPackageSettings(): Promise<undefined | Record<string, unknown>> {\n    // Only try and retrieve config file settings if there is a package.json in the\n    // scope of the current directory\n    const packageJsonPath = joinFilePath(process.cwd(), 'package.json');\n    if (!existsSync(packageJsonPath)) {\n      return;\n    }\n\n    // First see if there is a dedicated .json configuration file\n    const cssConfigPath = joinFilePath(process.cwd(), '.community-solid-server.config.json');\n    if (existsSync(cssConfigPath)) {\n      return readJSON(cssConfigPath) as Promise<Record<string, unknown>>;\n    }\n\n    // Next see if there is a dedicated .js file\n    const cssConfigPathJs = joinFilePath(process.cwd(), '.community-solid-server.config.js');\n    if (existsSync(cssConfigPathJs)) {\n      return import(cssConfigPathJs) as Promise<Record<string, unknown>>;\n    }\n\n    // Finally try to read from the config.community-solid-server\n    // field in the root package.json\n    const pkg = await readJSON(packageJsonPath) as { config?: Record<string, unknown> };\n    if (typeof pkg.config?.['community-solid-server'] === 'object') {\n      return pkg.config['community-solid-server'] as Record<string, unknown>;\n    }\n  }\n\n  /**\n   * Creates the Components Manager that will be used for instantiating.\n   */\n  public async createComponentsManager<T>(\n    loaderProperties: IComponentsManagerBuilderOptions<T>,\n    configs: string[],\n  ): Promise<ComponentsManager<T>> {\n    const componentsManager = await ComponentsManager.build(loaderProperties);\n    for (const config of configs) {\n      await componentsManager.configRegistry.register(config);\n    }\n    return componentsManager;\n  }\n\n  /**\n   * Instantiates the {@link CliResolver}.\n   */\n  private async createCliResolver(componentsManager: ComponentsManager<CliResolver>): Promise<CliResolver> {\n    try {\n      // Create a CliResolver, which combines a CliExtractor and a VariableResolver\n      return await componentsManager.instantiate(DEFAULT_CLI_RESOLVER, {});\n    } catch (error: unknown) {\n      this.resolveError(`Could not create the CLI resolver`, error);\n    }\n  }\n\n  /**\n   * Uses the {@link CliExtractor} to convert the CLI args to a {@link Shorthand} object.\n   */\n  private async extractShorthand(cliExtractor: CliExtractor, argv: CliArgv): Promise<Shorthand> {\n    try {\n      // Convert CLI args to CLI bindings\n      return await cliExtractor.handleSafe(argv);\n    } catch (error: unknown) {\n      this.resolveError(`Could not parse the CLI parameters`, error);\n    }\n  }\n\n  /**\n   * Uses the {@link ShorthandResolver} to convert {@link Shorthand} to {@link VariableBindings} .\n   */\n  private async resolveShorthand(shorthandResolver: ShorthandResolver, shorthand: Shorthand):\n  Promise<VariableBindings> {\n    try {\n      // Convert CLI bindings into variable bindings\n      return await shorthandResolver.handleSafe(shorthand);\n    } catch (error: unknown) {\n      this.resolveError(`Could not resolve the shorthand values`, error);\n    }\n  }\n\n  /**\n   * The second Components.js instantiation,\n   * where the App is created and started using the variable mappings.\n   */\n  private async createApp(componentsManager: ComponentsManager<App>, variables: Record<string, unknown>): Promise<App> {\n    let app: App;\n    // Create the app\n    try {\n      app = await componentsManager.instantiate(DEFAULT_APP, { variables });\n    } catch (error: unknown) {\n      this.resolveError(`Could not create the server`, error);\n    }\n\n    // Ensure thread safety\n    if (!app.clusterManager.isSingleThreaded()) {\n      const violatingClasses = await listSingleThreadedComponents(componentsManager);\n      if (violatingClasses.length > 0) {\n        const verb = violatingClasses.length > 1 ? 'are' : 'is';\n        const detailedError = new InternalServerError(\n          `[${violatingClasses.join(', ')}] ${verb} not threadsafe and should not be run in multithreaded setups!`,\n        );\n        this.resolveError('Cannot run a singlethreaded-only component in a multithreaded setup!', detailedError);\n      }\n    }\n    return app;\n  }\n\n  /**\n   * Throws a new error that provides additional information through the extra message.\n   * Also appends the stack trace to the message.\n   * This is needed for errors that are thrown before the logger is created as we can't log those the standard way.\n   */\n  private resolveError(message: string, error: unknown): never {\n    const errorMessage = `${message}\\n${isError(error) ? error.stack : createErrorMessage(error)}\\n`;\n    throw new Error(errorMessage);\n  }\n}\n"]}