{"version":3,"file":"SeededAccountInitializer.js","sourceRoot":"","sources":["../../src/init/SeededAccountInitializer.ts"],"names":[],"mappings":"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","sourcesContent":["import { readJson } from 'fs-extra';\nimport { array, object, string } from 'yup';\nimport type { AccountStore } from '../identity/interaction/account/util/AccountStore';\nimport type { PasswordStore } from '../identity/interaction/password/util/PasswordStore';\nimport type { PodCreator } from '../identity/interaction/pod/util/PodCreator';\nimport { URL_SCHEMA } from '../identity/interaction/YupUtil';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { createErrorMessage } from '../util/errors/ErrorUtil';\nimport { Initializer } from './Initializer';\n\nconst inSchema = array().of(object({\n  email: string().trim().email().lowercase()\n    .required(),\n  password: string().trim().min(1).required(),\n  pods: array().of(object({\n    name: string().trim().min(1).required(),\n    settings: object({\n      webId: URL_SCHEMA,\n    }).optional(),\n  })).optional(),\n})).required();\n\nexport interface SeededAccountInitializerArgs {\n  /**\n   * Creates the accounts.\n   */\n  accountStore: AccountStore;\n  /**\n   * Adds the login methods.\n   */\n  passwordStore: PasswordStore;\n  /**\n   * Creates the pods.\n   */\n  podCreator: PodCreator;\n  /**\n   * File path of the JSON describing the accounts to seed.\n   */\n  configFilePath?: string;\n}\n\n/**\n * Initializes a set of accounts based on the input data.\n * These accounts have exactly 1 email/password login method, and 0 or more pods.\n * The pod settings that can be defined are identical to those of the {@link CreatePodHandler}.\n */\nexport class SeededAccountInitializer extends Initializer {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly accountStore: AccountStore;\n  private readonly passwordStore: PasswordStore;\n  private readonly podCreator: PodCreator;\n  private readonly configFilePath?: string;\n\n  public constructor(args: SeededAccountInitializerArgs) {\n    super();\n    this.accountStore = args.accountStore;\n    this.passwordStore = args.passwordStore;\n    this.podCreator = args.podCreator;\n    this.configFilePath = args.configFilePath;\n  }\n\n  public async handle(): Promise<void> {\n    // This value being undefined means that the variable linking to the seed config is not defined\n    // and this class should just do nothing.\n    if (!this.configFilePath) {\n      return;\n    }\n\n    let configuration: typeof inSchema.__outputType;\n    try {\n      configuration = await inSchema.validate(await readJson(this.configFilePath, 'utf8'));\n    } catch (error: unknown) {\n      const msg = `Invalid account seed file: ${createErrorMessage(error)}`;\n      this.logger.error(msg);\n      throw new Error(msg);\n    }\n\n    let accountCount = 0;\n    let podCount = 0;\n    for await (const { email, password, pods } of configuration) {\n      try {\n        this.logger.info(`Creating account for ${email}`);\n        const accountId = await this.accountStore.create();\n        const id = await this.passwordStore.create(email, accountId, password);\n        await this.passwordStore.confirmVerification(id);\n        accountCount += 1;\n\n        for (const { name, settings } of pods ?? []) {\n          this.logger.info(`Creating pod with name ${name}`);\n          await this.podCreator.handleSafe({ accountId, name, webId: settings?.webId, settings });\n          podCount += 1;\n        }\n      } catch (error: unknown) {\n        this.logger.warn(`Error while initializing seeded account: ${createErrorMessage(error)}`);\n      }\n    }\n    this.logger.info(`Initialized ${accountCount} accounts and ${podCount} pods.`);\n  }\n}\n"]}