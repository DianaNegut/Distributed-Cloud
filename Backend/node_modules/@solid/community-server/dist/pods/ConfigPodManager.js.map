{"version":3,"file":"ConfigPodManager.js","sourceRoot":"","sources":["../../src/pods/ConfigPodManager.ts"],"names":[],"mappings":";;;AAAA,gDAAkD;AAGlD,0DAAgE;AAMhE;;;;;;;;;;GAUG;AACH,MAAa,gBAAgB;IACR,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAC9B,YAAY,CAAe;IAC3B,cAAc,CAAyC;IACvD,kBAAkB,CAAqB;IACvC,KAAK,CAAgB;IAEtC;;;;;OAKG;IACH,YACE,YAA0B,EAC1B,kBAAsC,EACtC,cAAsD,EACtD,KAAoB;QAEpB,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;QACrC,IAAI,CAAC,kBAAkB,GAAG,kBAAkB,CAAC;QAC7C,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACrB,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,QAAqB;QAC1C,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,gBAAgB,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;QAEvD,uEAAuE;QACvE,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAEzD,MAAM,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACzD,MAAM,KAAK,GAAG,MAAM,IAAA,oCAAqB,EAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAEzF,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,KAAK,iBAAiB,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;IACxE,CAAC;CACF;AApCD,4CAoCC","sourcesContent":["import { getLoggerFor } from '../logging/LogUtil';\nimport type { KeyValueStorage } from '../storage/keyvalue/KeyValueStorage';\nimport type { ResourceStore } from '../storage/ResourceStore';\nimport { addGeneratedResources } from './generate/GenerateUtil';\nimport type { PodGenerator } from './generate/PodGenerator';\nimport type { ResourcesGenerator } from './generate/ResourcesGenerator';\nimport type { PodManager } from './PodManager';\nimport type { PodSettings } from './settings/PodSettings';\n\n/**\n * Pod manager that creates a store for the pod with a {@link PodGenerator}\n * and fills it with resources from a {@link ResourcesGenerator}.\n *\n * Part of the dynamic pod creation.\n *  1. Calls a PodGenerator to instantiate a new resource store for the pod.\n *  2. Generates the pod resources based on the templates as usual.\n *  3. Adds the created pod to the routing storage, which is used for linking pod identifiers to their resource stores.\n *\n * @see {@link TemplatedPodGenerator}, {@link ConfigPodInitializer}, {@link BaseUrlRouterRule}\n */\nexport class ConfigPodManager implements PodManager {\n  protected readonly logger = getLoggerFor(this);\n  private readonly podGenerator: PodGenerator;\n  private readonly routingStorage: KeyValueStorage<string, ResourceStore>;\n  private readonly resourcesGenerator: ResourcesGenerator;\n  private readonly store: ResourceStore;\n\n  /**\n   * @param podGenerator - Generator for the pod stores.\n   * @param resourcesGenerator - Generator for the pod resources.\n   * @param routingStorage - Where to store the generated pods so they can be routed to.\n   * @param store - The default ResourceStore\n   */\n  public constructor(\n    podGenerator: PodGenerator,\n    resourcesGenerator: ResourcesGenerator,\n    routingStorage: KeyValueStorage<string, ResourceStore>,\n    store: ResourceStore,\n  ) {\n    this.podGenerator = podGenerator;\n    this.routingStorage = routingStorage;\n    this.resourcesGenerator = resourcesGenerator;\n    this.store = store;\n  }\n\n  public async createPod(settings: PodSettings): Promise<void> {\n    this.logger.info(`Creating pod ${settings.base.path}`);\n\n    // Will error in case there already is a store for the given identifier\n    const store = await this.podGenerator.generate(settings);\n\n    await this.routingStorage.set(settings.base.path, store);\n    const count = await addGeneratedResources(settings, this.resourcesGenerator, this.store);\n\n    this.logger.info(`Added ${count} resources to ${settings.base.path}`);\n  }\n}\n"]}