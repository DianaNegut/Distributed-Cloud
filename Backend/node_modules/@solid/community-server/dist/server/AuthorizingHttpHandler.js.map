{"version":3,"file":"AuthorizingHttpHandler.js","sourceRoot":"","sources":["../../src/server/AuthorizingHttpHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { DataFactory } from 'n3';\nimport type { Credentials } from '../authentication/Credentials';\nimport type { CredentialsExtractor } from '../authentication/CredentialsExtractor';\nimport type { Authorizer } from '../authorization/Authorizer';\nimport type { PermissionReader } from '../authorization/PermissionReader';\nimport type { ModesExtractor } from '../authorization/permissions/ModesExtractor';\nimport type { AccessMap } from '../authorization/permissions/Permissions';\nimport type { ResponseDescription } from '../http/output/response/ResponseDescription';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { createErrorMessage } from '../util/errors/ErrorUtil';\nimport { HttpError } from '../util/errors/HttpError';\nimport { SOLID_META } from '../util/Vocabularies';\nimport type { OperationHttpHandlerInput } from './OperationHttpHandler';\nimport { OperationHttpHandler } from './OperationHttpHandler';\n\nconst { blankNode, namedNode, literal } = DataFactory;\n\nexport interface AuthorizingHttpHandlerArgs {\n  /**\n   * Extracts the credentials from the incoming request.\n   */\n  credentialsExtractor: CredentialsExtractor;\n  /**\n   * Extracts the required modes from the generated Operation.\n   */\n  modesExtractor: ModesExtractor;\n  /**\n   * Reads the permissions available for the Operation.\n   */\n  permissionReader: PermissionReader;\n  /**\n   * Verifies if the requested operation is allowed.\n   */\n  authorizer: Authorizer;\n  /**\n   * Handler to call if the operation is authorized.\n   */\n  operationHandler: OperationHttpHandler;\n}\n\n/**\n * Handles all the necessary steps for an authorization.\n * Errors if authorization fails, otherwise passes the parameter to the operationHandler handler.\n * The following steps are executed:\n *  - Extracting credentials from the request.\n *  - Extracting the required permissions.\n *  - Reading the allowed permissions for the credentials.\n *  - Validating if this operation is allowed.\n */\nexport class AuthorizingHttpHandler extends OperationHttpHandler {\n  private readonly logger = getLoggerFor(this);\n\n  private readonly credentialsExtractor: CredentialsExtractor;\n  private readonly modesExtractor: ModesExtractor;\n  private readonly permissionReader: PermissionReader;\n  private readonly authorizer: Authorizer;\n  private readonly operationHandler: OperationHttpHandler;\n\n  public constructor(args: AuthorizingHttpHandlerArgs) {\n    super();\n    this.credentialsExtractor = args.credentialsExtractor;\n    this.modesExtractor = args.modesExtractor;\n    this.permissionReader = args.permissionReader;\n    this.authorizer = args.authorizer;\n    this.operationHandler = args.operationHandler;\n  }\n\n  public async handle(input: OperationHttpHandlerInput): Promise<ResponseDescription> {\n    const { request, operation } = input;\n    const credentials: Credentials = await this.credentialsExtractor.handleSafe(request);\n    this.logger.verbose(`Extracted credentials: ${JSON.stringify(credentials)}`);\n\n    const requestedModes = await this.modesExtractor.handleSafe(operation);\n    this.logger.verbose(`Retrieved required modes: ${\n      [ ...requestedModes.entrySets() ]\n        .map(([ id, set ]): string => `{ ${id.path}: ${[ ...set ].join(',')} }`).join(',')\n    }`);\n\n    const availablePermissions = await this.permissionReader.handleSafe({ credentials, requestedModes });\n    this.logger.verbose(`Available permissions are ${\n      [ ...availablePermissions.entries() ]\n        .map(([ id, map ]): string => `{ ${id.path}: ${JSON.stringify(map)} }`).join(',')\n    }`);\n\n    try {\n      await this.authorizer.handleSafe({ credentials, requestedModes, availablePermissions });\n    } catch (error: unknown) {\n      this.logger.verbose(`Authorization failed: ${createErrorMessage(error)}`);\n      if (HttpError.isInstance(error)) {\n        this.addAccessModesToError(error, requestedModes);\n      }\n      throw error;\n    }\n\n    this.logger.verbose(`Authorization succeeded, calling source handler`);\n\n    return this.operationHandler.handleSafe(input);\n  }\n\n  private addAccessModesToError(error: HttpError, requestedModes: AccessMap): void {\n    for (const [ identifier, modes ] of requestedModes.entrySets()) {\n      const bnode = blankNode();\n      error.metadata.add(SOLID_META.terms.requestedAccess, bnode);\n      error.metadata.addQuad(bnode, SOLID_META.terms.accessTarget, namedNode(identifier.path));\n      for (const mode of modes.values()) {\n        error.metadata.addQuad(bnode, SOLID_META.terms.accessMode, literal(mode));\n      }\n    }\n  }\n}\n"]}