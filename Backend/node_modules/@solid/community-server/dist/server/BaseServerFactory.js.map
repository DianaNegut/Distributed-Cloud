{"version":3,"file":"BaseServerFactory.js","sourceRoot":"","sources":["../../src/server/BaseServerFactory.ts"],"names":[],"mappings":";;;AAAA,qCAAuC;AAEvC,yCAA6D;AAE7D,2CAA+D;AAC/D,gDAAkD;AAuBlD;;;;;GAKG;AACH,MAAa,iBAAiB;IACT,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,YAAY,CAAqB;IACjC,OAAO,CAA2B;IAEnD,YAAmB,YAAgC,EAAE,OAAkC;QACrF,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,OAAO,GAAG,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,OAAO,EAAE,CAAC;IAC9C,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,YAAY;QACvB,MAAM,OAAO,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAE3C,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,IAAA,yBAAiB,EAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAA,wBAAgB,EAAC,OAAO,CAAC,CAAC;QAE3F,MAAM,IAAI,CAAC,YAAY,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QAE3C,OAAO,MAAM,CAAC;IAChB,CAAC;IAEO,mBAAmB;QACzB,MAAM,OAAO,GAAG,EAAE,GAAG,IAAI,CAAC,OAAO,EAAE,CAAC;QACpC,KAAK,MAAM,EAAE,IAAI,CAAE,KAAK,EAAE,MAAM,EAAE,KAAK,CAAW,EAAE,CAAC;YACnD,MAAM,GAAG,GAAG,OAAO,CAAC,EAAE,CAAC,CAAC;YACxB,IAAI,GAAG,EAAE,CAAC;gBACR,OAAO,CAAC,EAAE,CAAC,GAAG,IAAA,sBAAY,EAAC,GAAG,EAAE,MAAM,CAAC,CAAC;YAC1C,CAAC;QACH,CAAC;QACD,OAAO,OAAO,CAAC;IACjB,CAAC;CACF;AAlCD,8CAkCC","sourcesContent":["import { readFileSync } from 'node:fs';\nimport type { Server } from 'node:http';\nimport { createServer as createHttpServer } from 'node:http';\nimport type { ServerOptions } from 'node:https';\nimport { createServer as createHttpsServer } from 'node:https';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport type { HttpServerFactory } from './HttpServerFactory';\nimport type { ServerConfigurator } from './ServerConfigurator';\n\n/**\n * Options to be used when creating the server.\n * Due to Components.js not supporting external types, this has been simplified (for now?).\n * The common https keys here (key/cert/pfx) will be interpreted as file paths that need to be read\n * before passing the options to the `createServer` function.\n */\nexport interface BaseServerFactoryOptions {\n  /**\n   * If the server should start as an HTTP or HTTPS server.\n   */\n  https?: boolean;\n\n  key?: string;\n  cert?: string;\n\n  pfx?: string;\n  passphrase?: string;\n}\n\n/**\n * Creates an HTTP(S) server native Node.js `http`/`https` modules.\n *\n * Will apply a {@link ServerConfigurator} to the server,\n * which should be used to attach listeners.\n */\nexport class BaseServerFactory implements HttpServerFactory {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly configurator: ServerConfigurator;\n  private readonly options: BaseServerFactoryOptions;\n\n  public constructor(configurator: ServerConfigurator, options?: BaseServerFactoryOptions) {\n    this.configurator = configurator;\n    this.options = { https: false, ...options };\n  }\n\n  /**\n   * Creates an HTTP(S) server.\n   */\n  public async createServer(): Promise<Server> {\n    const options = this.createServerOptions();\n\n    const server = this.options.https ? createHttpsServer(options) : createHttpServer(options);\n\n    await this.configurator.handleSafe(server);\n\n    return server;\n  }\n\n  private createServerOptions(): ServerOptions {\n    const options = { ...this.options };\n    for (const id of [ 'key', 'cert', 'pfx' ] as const) {\n      const val = options[id];\n      if (val) {\n        options[id] = readFileSync(val, 'utf8');\n      }\n    }\n    return options;\n  }\n}\n"]}