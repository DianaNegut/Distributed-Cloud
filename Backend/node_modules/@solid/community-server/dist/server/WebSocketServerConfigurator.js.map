{"version":3,"file":"WebSocketServerConfigurator.js","sourceRoot":"","sources":["../../src/server/WebSocketServerConfigurator.ts"],"names":[],"mappings":";;;AAGA,2BAAqC;AACrC,gDAAkD;AAClD,wDAA8D;AAC9D,yDAAoD;AACpD,6DAA0D;AAG1D;;;;GAIG;AACH,MAAa,2BAA4B,SAAQ,uCAAkB;IAC9C,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,OAAO,CAAmB;IAE3C,YAAmB,OAAyB;QAC1C,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACzB,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,MAAc;QAChC,0BAA0B;QAC1B,MAAM,eAAe,GAAG,IAAI,oBAAe,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,cAA+B,EAAE,MAAc,EAAE,IAAY,EAAQ,EAAE;YAC3F,kDAAkD;YAClD,eAAe,CAAC,aAAa,CAAC,cAAc,EAAE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAC,SAAoB,EAAiB,EAAE;gBACvG,IAAI,CAAC;oBACH,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,cAAc,EAAE,IAAA,2BAAW,EAAC,cAAc,CAAC,EAAE,SAAS,EAAE,CAAC,CAAC;gBAC5F,CAAC;gBAAC,OAAO,KAAc,EAAE,CAAC;oBACxB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,yDAAyD,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,CAAC,CAAC;oBACxG,SAAS,CAAC,IAAI,CAAC,8CAA8C,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,CAAC,CAAC;oBAC1F,SAAS,CAAC,KAAK,EAAE,CAAC;gBACpB,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;CACF;AA1BD,kEA0BC","sourcesContent":["import type { IncomingMessage, Server } from 'node:http';\nimport type { Socket } from 'node:net';\nimport type { WebSocket } from 'ws';\nimport { WebSocketServer } from 'ws';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { createErrorMessage } from '../util/errors/ErrorUtil';\nimport { guardStream } from '../util/GuardedStream';\nimport { ServerConfigurator } from './ServerConfigurator';\nimport type { WebSocketHandler } from './WebSocketHandler';\n\n/**\n * {@link ServerConfigurator} that adds WebSocket functionality to an existing {@link Server}.\n *\n * Listens for WebSocket requests and sends them to its handler.\n */\nexport class WebSocketServerConfigurator extends ServerConfigurator {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly handler: WebSocketHandler;\n\n  public constructor(handler: WebSocketHandler) {\n    super();\n    this.handler = handler;\n  }\n\n  public async handle(server: Server): Promise<void> {\n    // Create WebSocket server\n    const webSocketServer = new WebSocketServer({ noServer: true });\n    server.on('upgrade', (upgradeRequest: IncomingMessage, socket: Socket, head: Buffer): void => {\n      // eslint-disable-next-line ts/no-misused-promises\n      webSocketServer.handleUpgrade(upgradeRequest, socket, head, async(webSocket: WebSocket): Promise<void> => {\n        try {\n          await this.handler.handleSafe({ upgradeRequest: guardStream(upgradeRequest), webSocket });\n        } catch (error: unknown) {\n          this.logger.error(`Something went wrong handling a WebSocket connection: ${createErrorMessage(error)}`);\n          webSocket.send(`There was an error opening this WebSocket: ${createErrorMessage(error)}`);\n          webSocket.close();\n        }\n      });\n    });\n  }\n}\n"]}