{"version":3,"file":"StorageDescriptionHandler.js","sourceRoot":"","sources":["../../../src/server/description/StorageDescriptionHandler.ts"],"names":[],"mappings":";;;AAAA,4FAAyF;AAEzF,uFAAoF;AAGpF,0DAAyD;AACzD,2FAAwF;AACxF,uFAAoF;AACpF,kDAA0D;AAC1D,0DAAmD;AAEnD,kEAA+D;AAG/D;;;;GAIG;AACH,MAAa,yBAA0B,SAAQ,2CAAoB;IAChD,KAAK,CAAgB;IACrB,IAAI,CAAS;IACb,SAAS,CAAmB;IAE7C,YAAmB,KAAoB,EAAE,IAAY,EAAE,SAA2B;QAChF,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;QACjB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC7B,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,EAAE,SAAS,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,EAA4B;QAChF,IAAI,MAAM,KAAK,KAAK,EAAE,CAAC;YACrB,MAAM,IAAI,qDAAyB,CAAC,CAAE,MAAM,CAAE,EAAE,uDAAuD,CAAC,CAAC;QAC3G,CAAC;QACD,MAAM,SAAS,GAAG,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC;QACpD,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QACzE,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;QAC9B,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,GAAG,CAAC,kBAAG,CAAC,KAAK,CAAC,IAAI,EAAE,kBAAG,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC;YACpE,MAAM,IAAI,iDAAuB,CAAC,mDAAmD,CAAC,CAAC;QACzF,CAAC;QAED,MAAM,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,EAAE,MAAM,EAAE,EAA4B;QACrE,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC;QAE7E,MAAM,cAAc,GAAG,IAAI,yCAAmB,CAAC,KAAK,EAAE,6BAAc,CAAC,CAAC;QAEtE,OAAO,IAAI,6CAAqB,CAAC,cAAc,CAAC,QAAQ,EAAE,cAAc,CAAC,IAAI,CAAC,CAAC;IACjF,CAAC;IAED;;OAEG;IACO,oBAAoB,CAAC,qBAAyC;QACtE,OAAO,EAAE,IAAI,EAAE,IAAA,8BAAmB,EAAC,qBAAqB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC;IAC/F,CAAC;CACF;AAxCD,8DAwCC","sourcesContent":["import { OkResponseDescription } from '../../http/output/response/OkResponseDescription';\nimport type { ResponseDescription } from '../../http/output/response/ResponseDescription';\nimport { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { ResourceIdentifier } from '../../http/representation/ResourceIdentifier';\nimport type { ResourceStore } from '../../storage/ResourceStore';\nimport { INTERNAL_QUADS } from '../../util/ContentTypes';\nimport { MethodNotAllowedHttpError } from '../../util/errors/MethodNotAllowedHttpError';\nimport { NotImplementedHttpError } from '../../util/errors/NotImplementedHttpError';\nimport { ensureTrailingSlash } from '../../util/PathUtil';\nimport { PIM, RDF } from '../../util/Vocabularies';\nimport type { OperationHttpHandlerInput } from '../OperationHttpHandler';\nimport { OperationHttpHandler } from '../OperationHttpHandler';\nimport type { StorageDescriber } from './StorageDescriber';\n\n/**\n * Generates the response for GET requests targeting a storage description resource.\n * The input path needs to match the relative path used to generate storage description resources\n * and will be used to verify if the container it is linked to is an actual storage.\n */\nexport class StorageDescriptionHandler extends OperationHttpHandler {\n  private readonly store: ResourceStore;\n  private readonly path: string;\n  private readonly describer: StorageDescriber;\n\n  public constructor(store: ResourceStore, path: string, describer: StorageDescriber) {\n    super();\n    this.store = store;\n    this.path = path;\n    this.describer = describer;\n  }\n\n  public async canHandle({ operation: { target, method }}: OperationHttpHandlerInput): Promise<void> {\n    if (method !== 'GET') {\n      throw new MethodNotAllowedHttpError([ method ], `Only GET requests can target the storage description.`);\n    }\n    const container = this.getStorageIdentifier(target);\n    const representation = await this.store.getRepresentation(container, {});\n    representation.data.destroy();\n    if (!representation.metadata.has(RDF.terms.type, PIM.terms.Storage)) {\n      throw new NotImplementedHttpError(`Only supports descriptions of storage containers.`);\n    }\n\n    await this.describer.canHandle(target);\n  }\n\n  public async handle({ operation: { target }}: OperationHttpHandlerInput): Promise<ResponseDescription> {\n    const quads = await this.describer.handle(this.getStorageIdentifier(target));\n\n    const representation = new BasicRepresentation(quads, INTERNAL_QUADS);\n\n    return new OkResponseDescription(representation.metadata, representation.data);\n  }\n\n  /**\n   * Determine the identifier of the root storage based on the identifier of the root storage description resource.\n   */\n  protected getStorageIdentifier(descriptionIdentifier: ResourceIdentifier): ResourceIdentifier {\n    return { path: ensureTrailingSlash(descriptionIdentifier.path.slice(0, -this.path.length)) };\n  }\n}\n"]}