{"version":3,"file":"BaseChannelType.js","sourceRoot":"","sources":["../../../src/server/notifications/BaseChannelType.ts"],"names":[],"mappings":"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","sourcesContent":["import { Readable } from 'node:stream';\nimport { KeysRdfParseJsonLd } from '@comunica/context-entries';\nimport { parse, toSeconds } from 'iso8601-duration';\nimport { DataFactory } from 'n3';\nimport type { Store } from 'n3';\nimport type { NamedNode, Term } from '@rdfjs/types';\nimport rdfParser from 'rdf-parse';\nimport SHACLValidator from 'rdf-validate-shacl';\nimport { v4 } from 'uuid';\nimport type { Credentials } from '../../authentication/Credentials';\nimport type { AccessMap } from '../../authorization/permissions/Permissions';\nimport { AccessMode } from '../../authorization/permissions/Permissions';\nimport type { InteractionRoute } from '../../identity/interaction/routing/InteractionRoute';\nimport { ContextDocumentLoader } from '../../storage/conversion/ConversionUtil';\nimport { UnprocessableEntityHttpError } from '../../util/errors/UnprocessableEntityHttpError';\nimport { IdentifierSetMultiMap } from '../../util/map/IdentifierMap';\nimport { joinUrl } from '../../util/PathUtil';\nimport { readableToQuads } from '../../util/StreamUtil';\nimport { msToDuration } from '../../util/StringUtil';\nimport { NOTIFY, RDF, XSD } from '../../util/Vocabularies';\nimport { CONTEXT_NOTIFICATION } from './Notification';\nimport type { NotificationChannel } from './NotificationChannel';\nimport type { NotificationChannelType, SubscriptionService } from './NotificationChannelType';\nimport namedNode = DataFactory.namedNode;\n\n/**\n * Helper type used to store information about the default features.\n */\ntype Feature = {\n  predicate: NamedNode;\n  key: keyof NotificationChannel;\n  dataType: string;\n};\n\n/**\n * All the necessary fields of the default features that are possible for all Notification Channels.\n */\nconst featureDefinitions: Feature[] = [\n  { predicate: NOTIFY.terms.accept, key: 'accept', dataType: XSD.string },\n  { predicate: NOTIFY.terms.endAt, key: 'endAt', dataType: XSD.dateTime },\n  { predicate: NOTIFY.terms.rate, key: 'rate', dataType: XSD.duration },\n  { predicate: NOTIFY.terms.startAt, key: 'startAt', dataType: XSD.dateTime },\n  { predicate: NOTIFY.terms.state, key: 'state', dataType: XSD.string },\n];\n\n/**\n * The default notification features that are available on all channel types.\n */\nexport const DEFAULT_NOTIFICATION_FEATURES = featureDefinitions.map((feat): string => feat.predicate.value);\n\n// This context is slightly outdated but seems to be the only \"official\" source for a SHACL context.\nconst CONTEXT_SHACL = 'https://w3c.github.io/shacl/shacl-jsonld-context/shacl.context.ld.json';\n/**\n * The SHACL shape for the minimum requirements on a notification channel subscription request.\n */\nexport const DEFAULT_SUBSCRIPTION_SHACL = {\n  // eslint-disable-next-line ts/naming-convention\n  '@context': [ CONTEXT_SHACL ],\n  // eslint-disable-next-line ts/naming-convention\n  '@type': 'sh:NodeShape',\n  // Use the topic predicate to find the focus node\n  targetSubjectsOf: NOTIFY.topic,\n  closed: true,\n  property: [\n    { path: RDF.type, minCount: 1, maxCount: 1, nodeKind: 'sh:IRI' },\n    { path: NOTIFY.topic, minCount: 1, maxCount: 1, nodeKind: 'sh:IRI' },\n    ...featureDefinitions.map((feat): unknown =>\n      ({ path: feat.predicate.value, maxCount: 1, datatype: feat.dataType })),\n  ],\n} as const;\n\n/**\n * A {@link NotificationChannelType} that handles the base case of parsing and serializing a notification channel.\n * Note that the `extractModes` call always requires Read permissions on the target resource.\n *\n * Uses SHACL to validate the incoming data in `initChannel`.\n * Classes extending this can pass extra SHACL properties in the constructor to extend the validation check.\n *\n * The `completeChannel` implementation is an empty function.\n */\nexport abstract class BaseChannelType implements NotificationChannelType {\n  protected readonly type: NamedNode;\n  protected readonly path: string;\n  protected readonly shacl: unknown;\n  protected shaclQuads?: Store;\n  protected readonly features: NamedNode[];\n\n  /**\n   * @param type - The URI of the notification channel type.\n   *               This will be added to the SHACL shape to validate incoming subscription data.\n   * @param route - The route corresponding to the URL of the subscription service of this channel type.\n   *                Channel identifiers will be generated by appending a value to this URL.\n   * @param features - The features that should be enabled for this channel type.\n   *                   Values are expected to be full URIs, but the `notify:` prefix can also be used.\n   * @param additionalShaclProperties - Any additional properties that need to be added to the default SHACL shape.\n   */\n  protected constructor(\n    type: NamedNode,\n    route: InteractionRoute,\n    features: string[] = DEFAULT_NOTIFICATION_FEATURES,\n    additionalShaclProperties: unknown[] = [],\n  ) {\n    this.type = type;\n    this.path = route.getPath();\n    this.features = features.map((feature): NamedNode => {\n      if (feature.startsWith('notify:')) {\n        feature = `${NOTIFY.namespace}${feature.slice('notify:'.length)}`;\n      }\n      return namedNode(feature);\n    });\n\n    // Inject requested properties into default SHACL shape\n    this.shacl = {\n      ...DEFAULT_SUBSCRIPTION_SHACL,\n      property: [\n        ...DEFAULT_SUBSCRIPTION_SHACL.property,\n        // Add type check\n        // eslint-disable-next-line ts/naming-convention\n        { path: RDF.type, hasValue: { '@id': type.value }},\n        ...additionalShaclProperties,\n      ],\n    };\n  }\n\n  public getDescription(): SubscriptionService {\n    return {\n      // eslint-disable-next-line ts/naming-convention\n      '@context': [ CONTEXT_NOTIFICATION ],\n      id: this.path,\n      // At the time of writing, there is no base value for URIs in the notification context,\n      // so we use the full URI instead.\n      channelType: this.type.value,\n      // Shorten known features to make the resulting JSON more readable\n      feature: this.features.map((node): string => {\n        if (DEFAULT_NOTIFICATION_FEATURES.includes(node.value)) {\n          return node.value.slice(NOTIFY.namespace.length);\n        }\n        if (node.value.startsWith(NOTIFY.namespace)) {\n          return `notify:${node.value.slice(NOTIFY.namespace.length)}`;\n        }\n        return node.value;\n      }),\n    };\n  }\n\n  /**\n   * Initiates the channel by first calling {@link validateSubscription} followed by {@link quadsToChannel}.\n   * Subclasses can override either function safely to impact the result of the function.\n   */\n  // eslint-disable-next-line unused-imports/no-unused-vars\n  public async initChannel(data: Store, credentials: Credentials): Promise<NotificationChannel> {\n    const subject = await this.validateSubscription(data);\n    return this.quadsToChannel(data, subject);\n  }\n\n  /**\n   * Returns an N3.js {@link Store} containing quads corresponding to the stored SHACL representation.\n   * Caches this result so the conversion from JSON-LD to quads only has to happen once.\n   */\n  protected async getShaclQuads(): Promise<Store> {\n    if (!this.shaclQuads) {\n      const shaclStream = rdfParser.parse(\n        Readable.from(JSON.stringify(this.shacl)),\n        {\n          contentType: 'application/ld+json',\n          // Make sure our internal version of the context gets used\n          [KeysRdfParseJsonLd.documentLoader.name]: new ContextDocumentLoader({\n            [CONTEXT_SHACL]: '@css:templates/contexts/shacl.jsonld',\n          }),\n        },\n      );\n      // Typing issue with rdf-parse library\n      this.shaclQuads = await readableToQuads(shaclStream as unknown as Readable);\n    }\n    return this.shaclQuads;\n  }\n\n  /**\n   * Validates whether the given data conforms to the stored SHACL shape.\n   * Will throw an {@link UnprocessableEntityHttpError} if validation fails.\n   * Along with the SHACL check, this also makes sure there is only one matching entry in the dataset.\n   *\n   * @param data - The data to validate.\n   *\n   * @returns The focus node that corresponds to the subject of the found notification channel description.\n   */\n  protected async validateSubscription(data: Store): Promise<Term> {\n    // Need to make sure there is exactly one matching entry, which can't be done with SHACL.\n    // The predicate used here must be the same as is used for `targetSubjectsOf` in the SHACL shape.\n    const focusNodes = data.getSubjects(NOTIFY.terms.topic, null, null);\n    if (focusNodes.length === 0) {\n      throw new UnprocessableEntityHttpError('Missing topic value.');\n    }\n    if (focusNodes.length > 1) {\n      throw new UnprocessableEntityHttpError('Only one subscription can be done at the same time.');\n    }\n\n    const validator = new SHACLValidator(await this.getShaclQuads());\n    const report = validator.validate(data);\n\n    if (!report.conforms) {\n      // Use the first error to generate error message\n      const result = report.results[0];\n      const message = result.message[0];\n      throw new UnprocessableEntityHttpError(`${message.value} - ${result.path?.value}`);\n    }\n\n    // From this point on, we can assume the subject corresponds to a valid subscription request\n    return focusNodes[0] as NamedNode;\n  }\n\n  /**\n   * Converts a set of quads to a {@link NotificationChannel}.\n   * Assumes the data is valid, so this should be called after {@link validateSubscription}.\n   *\n   * The generated identifier will be a URL made by combining the base URL of the channel type with a unique identifier.\n   *\n   * The values of the default features will be added to the resulting channel,\n   * subclasses with additional features that need to be added are responsible for parsing those quads.\n   *\n   * @param data - Data to convert.\n   * @param subject - The identifier of the notification channel description in the dataset.\n   *\n   * @returns The generated {@link NotificationChannel}.\n   */\n  protected async quadsToChannel(data: Store, subject: Term): Promise<NotificationChannel> {\n    const topic = data.getObjects(subject, NOTIFY.terms.topic, null)[0] as NamedNode;\n    const type = data.getObjects(subject, RDF.terms.type, null)[0] as NamedNode;\n\n    const channel: NotificationChannel = {\n      id: joinUrl(this.path, v4()),\n      type: type.value,\n      topic: topic.value,\n    };\n\n    // Apply the values for all present features that are enabled\n    for (const feature of DEFAULT_NOTIFICATION_FEATURES) {\n      const featNode = this.features.find((node): boolean => node.value === feature);\n      if (featNode) {\n        const objects = data.getObjects(subject, feature, null);\n        if (objects.length === 1) {\n          // Will always succeed since we are iterating over a list which was built using `featureDefinitions`\n          const { dataType, key } = featureDefinitions.find((feat): boolean => feat.predicate.value === feature)!;\n          let val: string | number = objects[0].value;\n          if (dataType === XSD.dateTime) {\n            val = Date.parse(val);\n          } else if (dataType === XSD.duration) {\n            val = toSeconds(parse(val)) * 1000;\n          }\n          // Need to convince TS that we can assign `string | number` to this key\n          (channel as Record<typeof key, string | number>)[key] = val;\n        }\n      }\n    }\n\n    return channel;\n  }\n\n  /**\n   * Converts the given channel to a JSON-LD description.\n   * All fields found in the channel, except `lastEmit`, will be part of the result subject,\n   * so subclasses should remove any fields that should not be exposed.\n   */\n  public async toJsonLd(channel: NotificationChannel): Promise<Record<string, unknown>> {\n    const result: Record<string, unknown> = {\n      // eslint-disable-next-line ts/naming-convention\n      '@context': [\n        CONTEXT_NOTIFICATION,\n      ],\n      ...channel,\n    };\n    // No need to expose this field\n    delete result.lastEmit;\n\n    // Convert all the epoch values back to the expected date/rate format\n    for (const { key, dataType } of featureDefinitions) {\n      const value = channel[key];\n      if (value) {\n        if (dataType === XSD.dateTime) {\n          result[key] = new Date(value).toISOString();\n        } else if (dataType === XSD.duration) {\n          result[key] = msToDuration(value as number);\n        }\n      }\n    }\n\n    return result;\n  }\n\n  public async extractModes(channel: NotificationChannel): Promise<AccessMap> {\n    return new IdentifierSetMultiMap<AccessMode>([[{ path: channel.topic }, AccessMode.read ]]);\n  }\n\n  // eslint-disable-next-line unused-imports/no-unused-vars\n  public async completeChannel(channel: NotificationChannel): Promise<void> {\n    // Do nothing\n  }\n}\n"]}