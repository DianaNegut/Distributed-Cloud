{"version":3,"file":"BaseStateHandler.js","sourceRoot":"","sources":["../../../src/server/notifications/BaseStateHandler.ts"],"names":[],"mappings":";;;AAAA,mDAAqD;AACrD,2DAAiE;AAIjE,iDAA8C;AAE9C;;;;;GAKG;AACH,MAAa,gBAAiB,SAAQ,2BAAY;IAC7B,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,OAAO,CAAsB;IAC7B,OAAO,CAA6B;IAErD,YAAmB,OAA4B,EAAE,OAAmC;QAClF,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACzB,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,OAAO,EAAoC;QAC/D,IAAI,OAAO,CAAC,KAAK,EAAE,CAAC;YAClB,MAAM,KAAK,GAAG,EAAE,IAAI,EAAE,OAAO,CAAC,KAAK,EAAE,CAAC;YACtC,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;gBAClD,gEAAgE;gBAChE,OAAO,OAAO,CAAC,KAAK,CAAC;gBACrB,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;YACrC,CAAC;YAAC,OAAO,KAAc,EAAE,CAAC;gBACxB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,wCAAwC,IAAA,8BAAkB,EAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YACzF,CAAC;QACH,CAAC;IACH,CAAC;CACF;AAzBD,4CAyBC","sourcesContent":["import { getLoggerFor } from '../../logging/LogUtil';\nimport { createErrorMessage } from '../../util/errors/ErrorUtil';\nimport type { NotificationChannel } from './NotificationChannel';\nimport type { NotificationChannelStorage } from './NotificationChannelStorage';\nimport type { NotificationHandler } from './NotificationHandler';\nimport { StateHandler } from './StateHandler';\n\n/**\n * Handles the `state` feature by calling a {@link NotificationHandler}\n * in case the {@link NotificationChannel} has a `state` value.\n *\n * Deletes the `state` parameter from the channel afterwards.\n */\nexport class BaseStateHandler extends StateHandler {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly handler: NotificationHandler;\n  private readonly storage: NotificationChannelStorage;\n\n  public constructor(handler: NotificationHandler, storage: NotificationChannelStorage) {\n    super();\n    this.handler = handler;\n    this.storage = storage;\n  }\n\n  public async handle({ channel }: { channel: NotificationChannel }): Promise<void> {\n    if (channel.state) {\n      const topic = { path: channel.topic };\n      try {\n        await this.handler.handleSafe({ channel, topic });\n        // Remove the state once the relevant notification has been sent\n        delete channel.state;\n        await this.storage.update(channel);\n      } catch (error: unknown) {\n        this.logger.error(`Problem emitting state notification: ${createErrorMessage(error)}`);\n      }\n    }\n  }\n}\n"]}