{"version":3,"file":"KeyValueChannelStorage.js","sourceRoot":"","sources":["../../../src/server/notifications/KeyValueChannelStorage.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ResourceIdentifier } from '../../http/representation/ResourceIdentifier';\nimport { getLoggerFor } from '../../logging/LogUtil';\nimport type { KeyValueStorage } from '../../storage/keyvalue/KeyValueStorage';\nimport { InternalServerError } from '../../util/errors/InternalServerError';\nimport type { ReadWriteLocker } from '../../util/locking/ReadWriteLocker';\nimport type { NotificationChannel } from './NotificationChannel';\nimport type { NotificationChannelStorage } from './NotificationChannelStorage';\n\ntype StorageValue = string | string[] | NotificationChannel;\n\n/**\n * Stores all the {@link NotificationChannel} in a {@link KeyValueStorage}.\n * Encodes IDs/topics before storing them in the KeyValueStorage.\n *\n * Uses a {@link ReadWriteLocker} to prevent internal race conditions.\n */\nexport class KeyValueChannelStorage implements NotificationChannelStorage {\n  protected logger = getLoggerFor(this);\n\n  private readonly storage: KeyValueStorage<string, StorageValue>;\n  private readonly locker: ReadWriteLocker;\n\n  public constructor(storage: KeyValueStorage<string, StorageValue>, locker: ReadWriteLocker) {\n    this.storage = storage;\n    this.locker = locker;\n  }\n\n  public async get(id: string): Promise<NotificationChannel | undefined> {\n    const channel = await this.storage.get(encodeURIComponent(id));\n    if (channel && this.isChannel(channel)) {\n      if (typeof channel.endAt === 'number' && channel.endAt < Date.now()) {\n        this.logger.info(`Notification channel ${id} has expired.`);\n        await this.locker.withWriteLock(this.getLockKey(id), async(): Promise<void> => {\n          await this.deleteChannel(channel);\n        });\n        return;\n      }\n\n      return channel;\n    }\n  }\n\n  public async getAll(topic: ResourceIdentifier): Promise<string[]> {\n    const channels = await this.storage.get(encodeURIComponent(topic.path));\n    if (Array.isArray(channels)) {\n      return channels;\n    }\n    return [];\n  }\n\n  public async add(channel: NotificationChannel): Promise<void> {\n    const target = { path: channel.topic };\n    return this.locker.withWriteLock(this.getLockKey(target), async(): Promise<void> => {\n      const channels = await this.getAll(target);\n      await this.storage.set(encodeURIComponent(channel.id), channel);\n      channels.push(channel.id);\n      await this.storage.set(encodeURIComponent(channel.topic), channels);\n    });\n  }\n\n  public async update(channel: NotificationChannel): Promise<void> {\n    return this.locker.withWriteLock(this.getLockKey(channel.id), async(): Promise<void> => {\n      const oldChannel = await this.storage.get(encodeURIComponent(channel.id));\n\n      if (oldChannel) {\n        if (!this.isChannel(oldChannel)) {\n          throw new InternalServerError(`Trying to update ${channel.id} which is not a NotificationChannel.`);\n        }\n        if (channel.topic !== oldChannel.topic) {\n          throw new InternalServerError(`Trying to change the topic of a notification channel ${channel.id}`);\n        }\n      }\n\n      await this.storage.set(encodeURIComponent(channel.id), channel);\n    });\n  }\n\n  public async delete(id: string): Promise<boolean> {\n    return this.locker.withWriteLock(this.getLockKey(id), async(): Promise<boolean> => {\n      const channel = await this.get(id);\n      if (!channel) {\n        return false;\n      }\n      await this.deleteChannel(channel);\n      return true;\n    });\n  }\n\n  /**\n   * Utility function for deleting a specific {@link NotificationChannel} object.\n   * Does not create a lock on the channel ID so should be wrapped in such a lock.\n   */\n  private async deleteChannel(channel: NotificationChannel): Promise<void> {\n    await this.locker.withWriteLock(this.getLockKey(channel.topic), async(): Promise<void> => {\n      const channels = await this.getAll({ path: channel.topic });\n      const idx = channels.indexOf(channel.id);\n      // If idx < 0 we have an inconsistency\n      if (idx < 0) {\n        this.logger.error(`Channel ${channel.id} was not found in the list of channels targeting ${channel.topic}.`);\n        this.logger.error('This should not happen and indicates a data consistency issue.');\n      } else {\n        channels.splice(idx, 1);\n        if (channels.length > 0) {\n          await this.storage.set(encodeURIComponent(channel.topic), channels);\n        } else {\n          await this.storage.delete(encodeURIComponent(channel.topic));\n        }\n      }\n      await this.storage.delete(encodeURIComponent(channel.id));\n    });\n  }\n\n  private isChannel(value: StorageValue): value is NotificationChannel {\n    return Boolean((value as NotificationChannel).id);\n  }\n\n  private getLockKey(identifier: ResourceIdentifier | string): ResourceIdentifier {\n    return { path: `${typeof identifier === 'string' ? identifier : identifier.path}.notification-storage` };\n  }\n}\n"]}