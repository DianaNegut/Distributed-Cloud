{"version":3,"file":"NotificationDescriber.js","sourceRoot":"","sources":["../../../src/server/notifications/NotificationDescriber.ts"],"names":[],"mappings":";;;;;;AACA,sEAA6C;AAC7C,2BAAiC;AACjC,uFAAoF;AAGpF,0DAA8E;AAC9E,0DAAiD;AACjD,sEAAmE;AAGnE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,gBAAW,CAAC;AAExC;;;;;;;GAOG;AACH,MAAa,qBAAsB,SAAQ,mCAAgB;IACxC,SAAS,CAA0B;IACnC,aAAa,CAA4B;IAE1D,YAAmB,SAAkC,EAAE,aAAwC;QAC7F,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;IACrC,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,UAA8B;QAChD,MAAM,OAAO,GAAG,SAAS,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAE3C,MAAM,iBAAiB,GAAW,EAAE,CAAC;QACrC,MAAM,WAAW,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC,6BAAc,CAAC,EAAE,CAAC,EAAE,EAAC,CAAC;QACrD,MAAM,iBAAiB,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,EAAC,GAAG,EAAmB,EAAE;YAC/F,MAAM,MAAM,GAAG,GAAG,CAAC,cAAc,EAAE,CAAC;YACpC,MAAM,cAAc,GAAG,IAAI,yCAAmB,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,EAAE,IAAI,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,kCAAmB,CAAC,CAAC;YACjH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,EAAE,CAAC,CAAC;YAC/F,MAAM,GAAG,GAAG,MAAM,IAAA,yBAAc,EAAO,SAAS,CAAC,IAAI,CAAC,CAAC;YACvD,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,qBAAM,CAAC,KAAK,CAAC,YAAY,EAAE,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YACvF,OAAO,GAAG,CAAC;QACb,CAAC,CAAC,CAAC,CAAC;QAEJ,OAAO;YACL,GAAG,iBAAiB;YACpB,GAAG,iBAAiB,CAAC,IAAI,EAAE;SAC5B,CAAC;IACJ,CAAC;CACF;AA7BD,sDA6BC","sourcesContent":["import type { Quad } from '@rdfjs/types';\nimport arrayifyStream from 'arrayify-stream';\nimport { DataFactory } from 'n3';\nimport { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { ResourceIdentifier } from '../../http/representation/ResourceIdentifier';\nimport type { RepresentationConverter } from '../../storage/conversion/RepresentationConverter';\nimport { APPLICATION_LD_JSON, INTERNAL_QUADS } from '../../util/ContentTypes';\nimport { NOTIFY } from '../../util/Vocabularies';\nimport { StorageDescriber } from '../description/StorageDescriber';\nimport type { NotificationChannelType } from './NotificationChannelType';\n\nconst { namedNode, quad } = DataFactory;\n\n/**\n * Outputs quads describing all the subscription services of the server,\n * as described in https://solidproject.org/TR/2022/notifications-protocol-20221231#discovery and\n * https://solidproject.org/TR/2022/notifications-protocol-20221231#description-resource-data-model.\n *\n * In the future, if there is ever a need to add notification channels to the description resource as described above,\n * this functionality should probably be added here as well.\n */\nexport class NotificationDescriber extends StorageDescriber {\n  private readonly converter: RepresentationConverter;\n  private readonly subscriptions: NotificationChannelType[];\n\n  public constructor(converter: RepresentationConverter, subscriptions: NotificationChannelType[]) {\n    super();\n    this.converter = converter;\n    this.subscriptions = subscriptions;\n  }\n\n  public async handle(identifier: ResourceIdentifier): Promise<Quad[]> {\n    const subject = namedNode(identifier.path);\n\n    const subscriptionLinks: Quad[] = [];\n    const preferences = { type: { [INTERNAL_QUADS]: 1 }};\n    const subscriptionQuads = await Promise.all(this.subscriptions.map(async(sub): Promise<Quad[]> => {\n      const jsonld = sub.getDescription();\n      const representation = new BasicRepresentation(JSON.stringify(jsonld), { path: jsonld.id }, APPLICATION_LD_JSON);\n      const converted = await this.converter.handleSafe({ identifier, representation, preferences });\n      const arr = await arrayifyStream<Quad>(converted.data);\n      subscriptionLinks.push(quad(subject, NOTIFY.terms.subscription, namedNode(jsonld.id)));\n      return arr;\n    }));\n\n    return [\n      ...subscriptionLinks,\n      ...subscriptionQuads.flat(),\n    ];\n  }\n}\n"]}