{"version":3,"file":"WebSocket2023Emitter.js","sourceRoot":"","sources":["../../../../src/server/notifications/WebSocketChannel2023/WebSocket2023Emitter.ts"],"names":[],"mappings":";;;AACA,sDAAwD;AAExD,yDAA4D;AAC5D,gEAA6D;AAG7D;;;;GAIG;AACH,MAAa,oBAAqB,SAAQ,yCAAmB;IACxC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,SAAS,CAAiC;IAE3D,YAAmB,SAAyC;QAC1D,KAAK,EAAE,CAAC;QAER,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC7B,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,OAAO,EAAE,cAAc,EAA4B;QACvE,yDAAyD;QACzD,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAClD,IAAI,UAAU,EAAE,CAAC;YACf,MAAM,IAAI,GAAG,MAAM,IAAA,6BAAgB,EAAC,cAAc,CAAC,IAAI,CAAC,CAAC;YACzD,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE,CAAC;gBACnC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACvB,CAAC;QACH,CAAC;aAAM,CAAC;YACN,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;QAChC,CAAC;IACH,CAAC;CACF;AAvBD,oDAuBC","sourcesContent":["import type { WebSocket } from 'ws';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { SetMultiMap } from '../../../util/map/SetMultiMap';\nimport { readableToString } from '../../../util/StreamUtil';\nimport { NotificationEmitter } from '../NotificationEmitter';\nimport type { NotificationEmitterInput } from '../NotificationEmitter';\n\n/**\n * Emits notifications on WebSocketChannel2023 subscription.\n * Uses the WebSockets found in the provided map.\n * The key should be the identifier of the matching channel.\n */\nexport class WebSocket2023Emitter extends NotificationEmitter {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly socketMap: SetMultiMap<string, WebSocket>;\n\n  public constructor(socketMap: SetMultiMap<string, WebSocket>) {\n    super();\n\n    this.socketMap = socketMap;\n  }\n\n  public async handle({ channel, representation }: NotificationEmitterInput): Promise<void> {\n    // Called as a NotificationEmitter: emit the notification\n    const webSockets = this.socketMap.get(channel.id);\n    if (webSockets) {\n      const data = await readableToString(representation.data);\n      for (const webSocket of webSockets) {\n        webSocket.send(data);\n      }\n    } else {\n      representation.data.destroy();\n    }\n  }\n}\n"]}