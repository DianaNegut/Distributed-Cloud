{"version":3,"file":"WebSocket2023Listener.js","sourceRoot":"","sources":["../../../../src/server/notifications/WebSocketChannel2023/WebSocket2023Listener.ts"],"names":[],"mappings":";;;AAAA,sDAAwD;AACxD,0FAAuF;AAEvF,6DAA0D;AAG1D,2DAA4D;AAE5D;;;GAGG;AACH,MAAa,qBAAsB,SAAQ,mCAAgB;IACtC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,OAAO,CAA6B;IACpC,OAAO,CAAuB;IAC9B,OAAO,CAAS;IAEjC,YAAmB,OAAmC,EAAE,OAA6B,EAAE,OAAe;QACpG,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACzB,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,EAAE,cAAc,EAAyB;QAC9D,MAAM,EAAE,GAAG,IAAA,yCAAqB,EAAC,IAAI,CAAC,OAAO,EAAE,cAAc,CAAC,CAAC;QAC/D,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAE3C,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,iDAAuB,CAAC,wCAAwC,EAAE,EAAE,CAAC,CAAC;QAClF,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,cAAc,EAAyB;QACtE,MAAM,EAAE,GAAG,IAAA,yCAAqB,EAAC,IAAI,CAAC,OAAO,EAAE,cAAc,CAAC,CAAC;QAC/D,MAAM,OAAO,GAAG,CAAC,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAE,CAAC;QAE9C,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,yDAAyD,OAAO,CAAC,KAAK,EAAE,CAAC,CAAC;QAE3F,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC,CAAC;IACxD,CAAC;CACF;AA/BD,sDA+BC","sourcesContent":["import { getLoggerFor } from '../../../logging/LogUtil';\nimport { NotImplementedHttpError } from '../../../util/errors/NotImplementedHttpError';\nimport type { WebSocketHandlerInput } from '../../WebSocketHandler';\nimport { WebSocketHandler } from '../../WebSocketHandler';\nimport type { NotificationChannelStorage } from '../NotificationChannelStorage';\nimport type { WebSocket2023Handler } from './WebSocket2023Handler';\nimport { parseWebSocketRequest } from './WebSocket2023Util';\n\n/**\n * Listens for WebSocket connections and verifies whether they are valid WebSocketChannel2023 connections,\n * in which case its {@link WebSocket2023Handler} will be alerted.\n */\nexport class WebSocket2023Listener extends WebSocketHandler {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly storage: NotificationChannelStorage;\n  private readonly handler: WebSocket2023Handler;\n  private readonly baseUrl: string;\n\n  public constructor(storage: NotificationChannelStorage, handler: WebSocket2023Handler, baseUrl: string) {\n    super();\n    this.storage = storage;\n    this.handler = handler;\n    this.baseUrl = baseUrl;\n  }\n\n  public async canHandle({ upgradeRequest }: WebSocketHandlerInput): Promise<void> {\n    const id = parseWebSocketRequest(this.baseUrl, upgradeRequest);\n    const channel = await this.storage.get(id);\n\n    if (!channel) {\n      throw new NotImplementedHttpError(`Unknown or expired WebSocket channel ${id}`);\n    }\n  }\n\n  public async handle({ webSocket, upgradeRequest }: WebSocketHandlerInput): Promise<void> {\n    const id = parseWebSocketRequest(this.baseUrl, upgradeRequest);\n    const channel = (await this.storage.get(id))!;\n\n    this.logger.info(`Accepted WebSocket connection listening to changes on ${channel.topic}`);\n\n    await this.handler.handleSafe({ channel, webSocket });\n  }\n}\n"]}