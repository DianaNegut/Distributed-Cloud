{"version":3,"file":"WebSocket2023Storer.js","sourceRoot":"","sources":["../../../../src/server/notifications/WebSocketChannel2023/WebSocket2023Storer.ts"],"names":[],"mappings":";;;AACA,sDAAwD;AAExD,uDAA0D;AAG1D,iEAA8D;AAE9D;;;;;;;;GAQG;AACH,MAAa,mBAAoB,SAAQ,2CAAoB;IACxC,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,OAAO,CAA6B;IACpC,SAAS,CAAiC;IAE3D,YACE,OAAmC,EACnC,SAAyC,EACzC,YAAY,GAAG,EAAE;QAEjB,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QAEvB,MAAM,KAAK,GAAG,IAAA,2BAAe,EAC3B,IAAI,CAAC,MAAM,EACX,oCAAoC,EACpC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAC,EACnC,YAAY,GAAG,EAAE,GAAG,IAAI,CACzB,CAAC;QACF,KAAK,CAAC,KAAK,EAAE,CAAC;IAChB,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,OAAO,EAA6B;QACnE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC;QAC1C,SAAS,CAAC,EAAE,CAAC,OAAO,EAAE,GAAY,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC;QACxF,SAAS,CAAC,EAAE,CAAC,OAAO,EAAE,GAAY,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC;IAC1F,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,mBAAmB;QAC/B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,CAAC;QAChD,KAAK,MAAM,CAAE,EAAE,EAAE,OAAO,CAAE,IAAI,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,EAAE,CAAC;YACzD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC1C,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;oBAC7B,iFAAiF;oBACjF,MAAM,CAAC,IAAI,CAAC,kCAAkC,CAAC,CAAC;oBAChD,MAAM,CAAC,KAAK,EAAE,CAAC;gBACjB,CAAC;YACH,CAAC;QACH,CAAC;QACD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,qCAAqC,CAAC,CAAC;IAC3D,CAAC;CACF;AA/CD,kDA+CC","sourcesContent":["import type { WebSocket } from 'ws';\nimport { getLoggerFor } from '../../../logging/LogUtil';\nimport type { SetMultiMap } from '../../../util/map/SetMultiMap';\nimport { setSafeInterval } from '../../../util/TimerUtil';\nimport type { NotificationChannelStorage } from '../NotificationChannelStorage';\nimport type { WebSocket2023HandlerInput } from './WebSocket2023Handler';\nimport { WebSocket2023Handler } from './WebSocket2023Handler';\n\n/**\n * Keeps track of the WebSockets that were opened for a WebSocketChannel2023 channel.\n * The WebSockets are stored in the map using the identifier of the matching channel.\n *\n * `cleanupTimer` defines in minutes how often the stored WebSockets are closed\n * if their corresponding channel has expired.\n * Defaults to 60 minutes.\n * Open WebSockets will not receive notifications if their channel expired.\n */\nexport class WebSocket2023Storer extends WebSocket2023Handler {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly storage: NotificationChannelStorage;\n  private readonly socketMap: SetMultiMap<string, WebSocket>;\n\n  public constructor(\n    storage: NotificationChannelStorage,\n    socketMap: SetMultiMap<string, WebSocket>,\n    cleanupTimer = 60,\n  ) {\n    super();\n    this.socketMap = socketMap;\n    this.storage = storage;\n\n    const timer = setSafeInterval(\n      this.logger,\n      'Failed to remove closed WebSockets',\n      this.closeExpiredSockets.bind(this),\n      cleanupTimer * 60 * 1000,\n    );\n    timer.unref();\n  }\n\n  public async handle({ webSocket, channel }: WebSocket2023HandlerInput): Promise<void> {\n    this.socketMap.add(channel.id, webSocket);\n    webSocket.on('error', (): boolean => this.socketMap.deleteEntry(channel.id, webSocket));\n    webSocket.on('close', (): boolean => this.socketMap.deleteEntry(channel.id, webSocket));\n  }\n\n  /**\n   * Close all WebSockets that are attached to a channel that no longer exists.\n   */\n  private async closeExpiredSockets(): Promise<void> {\n    this.logger.debug('Closing expired WebSockets');\n    for (const [ id, sockets ] of this.socketMap.entrySets()) {\n      const result = await this.storage.get(id);\n      if (!result) {\n        for (const socket of sockets) {\n          // Due to the attached listener, this also deletes the entries in the `socketMap`\n          socket.send(`Notification channel has expired`);\n          socket.close();\n        }\n      }\n    }\n    this.logger.debug('Finished closing expired WebSockets');\n  }\n}\n"]}