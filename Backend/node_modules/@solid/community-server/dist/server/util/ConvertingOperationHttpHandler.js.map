{"version":3,"file":"ConvertingOperationHttpHandler.js","sourceRoot":"","sources":["../../../src/server/util/ConvertingOperationHttpHandler.ts"],"names":[],"mappings":";;;AACA,uFAAoF;AAEpF,+EAA4E;AAE5E,kEAA+D;AAE/D;;;GAGG;AACH,MAAa,8BAA+B,SAAQ,2CAAoB;IACrD,SAAS,CAA0B;IACnC,gBAAgB,CAAuB;IAExD,YAAmB,SAAkC,EAAE,gBAAsC;QAC3F,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAC3C,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAAgC;QACrD,MAAM,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IAC/C,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAgC;QAClD,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE3D,IAAI,KAAK,CAAC,SAAS,CAAC,WAAW,CAAC,IAAI,IAAI,QAAQ,CAAC,IAAI,EAAE,CAAC;YACtD,IAAI,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC;gBACvB,MAAM,IAAI,yCAAmB,CAAC,qDAAqD,CAAC,CAAC;YACvF,CAAC;YAED,MAAM,cAAc,GAAG,IAAI,yCAAmB,CAAC,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAEjF,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC;gBAChD,UAAU,EAAE,KAAK,CAAC,SAAS,CAAC,MAAM;gBAClC,cAAc;gBACd,WAAW,EAAE,KAAK,CAAC,SAAS,CAAC,WAAW;aACzC,CAAC,CAAC;YAEH,QAAQ,CAAC,QAAQ,GAAG,SAAS,CAAC,QAAQ,CAAC;YACvC,QAAQ,CAAC,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC;QACjC,CAAC;QAED,OAAO,QAAQ,CAAC;IAClB,CAAC;CACF;AApCD,wEAoCC","sourcesContent":["import type { ResponseDescription } from '../../http/output/response/ResponseDescription';\nimport { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { RepresentationConverter } from '../../storage/conversion/RepresentationConverter';\nimport { InternalServerError } from '../../util/errors/InternalServerError';\nimport type { OperationHttpHandlerInput } from '../OperationHttpHandler';\nimport { OperationHttpHandler } from '../OperationHttpHandler';\n\n/**\n * An {@link OperationHttpHandler} that converts the response of its handler based on the {@link Operation} preferences.\n * If there are no preferences, or no data, the response will be returned as-is.\n */\nexport class ConvertingOperationHttpHandler extends OperationHttpHandler {\n  private readonly converter: RepresentationConverter;\n  private readonly operationHandler: OperationHttpHandler;\n\n  public constructor(converter: RepresentationConverter, operationHandler: OperationHttpHandler) {\n    super();\n    this.converter = converter;\n    this.operationHandler = operationHandler;\n  }\n\n  public async canHandle(input: OperationHttpHandlerInput): Promise<void> {\n    await this.operationHandler.canHandle(input);\n  }\n\n  public async handle(input: OperationHttpHandlerInput): Promise<ResponseDescription> {\n    const response = await this.operationHandler.handle(input);\n\n    if (input.operation.preferences.type && response.data) {\n      if (!response.metadata) {\n        throw new InternalServerError('A data stream should always have a metadata object.');\n      }\n\n      const representation = new BasicRepresentation(response.data, response.metadata);\n\n      const converted = await this.converter.handleSafe({\n        identifier: input.operation.target,\n        representation,\n        preferences: input.operation.preferences,\n      });\n\n      response.metadata = converted.metadata;\n      response.data = converted.data;\n    }\n\n    return response;\n  }\n}\n"]}