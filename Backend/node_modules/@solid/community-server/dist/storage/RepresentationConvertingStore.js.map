{"version":3,"file":"RepresentationConvertingStore.js","sourceRoot":"","sources":["../../src/storage/RepresentationConvertingStore.ts"],"names":[],"mappings":";;;AAIA,gDAAkD;AAClD,uDAAsD;AAEtD,4EAAyE;AAEzE,yDAAsD;AAGtD;;GAEG;AACH,MAAa,6BAAuE,SAAQ,mCAAmB;IAC1F,MAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;IAE9B,gBAAgB,CAAoB;IACpC,WAAW,CAA0B;IACrC,YAAY,CAA0B;IACtC,aAAa,CAA4B;IAE1D;;;;;;;;OAQG;IACH,YAAmB,MAAS,EAAE,gBAAmC,EAAE,OAIlE;QACC,KAAK,CAAC,MAAM,CAAC,CAAC;QACd,MAAM,EAAE,WAAW,EAAE,YAAY,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;QAC7D,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;QACzC,IAAI,CAAC,WAAW,GAAG,WAAW,IAAI,IAAI,2CAAoB,EAAE,CAAC;QAC7D,IAAI,CAAC,YAAY,GAAG,YAAY,IAAI,IAAI,2CAAoB,EAAE,CAAC;QAC/D,IAAI,CAAC,aAAa,GAAG,aAAa,IAAI,EAAE,CAAC;IAC3C,CAAC;IAEM,KAAK,CAAC,iBAAiB,CAC5B,UAA8B,EAC9B,WAAsC,EACtC,UAAuB;QAEvB,MAAM,cAAc,GAAG,MAAM,KAAK,CAAC,iBAAiB,CAAC,UAAU,EAAE,WAAW,EAAE,UAAU,CAAC,CAAC;QAC1F,OAAO,IAAI,CAAC,YAAY,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,EAAE,CAAC,CAAC;IACnF,CAAC;IAEM,KAAK,CAAC,WAAW,CACtB,UAA8B,EAC9B,cAA8B,EAC9B,UAAuB;QAEvB,yFAAyF;QACzF,IAAI,cAAc,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;YACxC,4GAA4G;YAC5G,0DAA0D;YAC1D,cAAc,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,CAChD,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,EAAE,IAAI,CAAC,aAAa,EAAE,CAChE,CAAC;QACJ,CAAC;QACD,OAAO,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,UAAU,EAAE,cAAc,EAAE,UAAU,CAAC,CAAC;IACzE,CAAC;IAEM,KAAK,CAAC,iBAAiB,CAC5B,UAA8B,EAC9B,cAA8B,EAC9B,UAAuB;QAEvB,gGAAgG;QAChG,IAAI,IAAI,CAAC,gBAAgB,CAAC,qBAAqB,CAAC,UAAU,CAAC,EAAE,CAAC;YAC5D,cAAc,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,CAChD,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,EAAE,EAAE,IAAI,EAAE,EAAE,CAAC,6BAAc,CAAC,EAAE,CAAC,EAAE,EAAC,EAAC,CAC7E,CAAC;QACJ,CAAC;aAAM,IAAI,cAAc,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;YAC/C,cAAc,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,CAChD,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,EAAE,IAAI,CAAC,aAAa,EAAE,CAChE,CAAC;QACJ,CAAC;QACD,OAAO,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,UAAU,EAAE,cAAc,EAAE,UAAU,CAAC,CAAC;IAC/E,CAAC;CACF;AAxED,sEAwEC","sourcesContent":["import type { AuxiliaryStrategy } from '../http/auxiliary/AuxiliaryStrategy';\nimport type { Representation } from '../http/representation/Representation';\nimport type { RepresentationPreferences } from '../http/representation/RepresentationPreferences';\nimport type { ResourceIdentifier } from '../http/representation/ResourceIdentifier';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { INTERNAL_QUADS } from '../util/ContentTypes';\nimport type { Conditions } from './conditions/Conditions';\nimport { PassthroughConverter } from './conversion/PassthroughConverter';\nimport type { RepresentationConverter } from './conversion/RepresentationConverter';\nimport { PassthroughStore } from './PassthroughStore';\nimport type { ChangeMap, ResourceStore } from './ResourceStore';\n\n/**\n * Store that provides (optional) conversion of incoming and outgoing {@link Representation}s.\n */\nexport class RepresentationConvertingStore<T extends ResourceStore = ResourceStore> extends PassthroughStore<T> {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly metadataStrategy: AuxiliaryStrategy;\n  private readonly inConverter: RepresentationConverter;\n  private readonly outConverter: RepresentationConverter;\n  private readonly inPreferences: RepresentationPreferences;\n\n  /**\n   * @param source - Store we retrieve data from and send data to.\n   * @param metadataStrategy - Used to distinguish regular resources (which may be converted)\n   *                           from metadata resources (which always need conversion).\n   * @param options - Determines when data should be converted.\n   * @param options.outConverter - Converts data after retrieval from the source store.\n   * @param options.inConverter - Converts data before passing to the source store.\n   * @param options.inPreferences - The preferred input format for the source store, as passed to the inConverter.\n   */\n  public constructor(source: T, metadataStrategy: AuxiliaryStrategy, options: {\n    outConverter?: RepresentationConverter;\n    inConverter?: RepresentationConverter;\n    inPreferences?: RepresentationPreferences;\n  }) {\n    super(source);\n    const { inConverter, outConverter, inPreferences } = options;\n    this.metadataStrategy = metadataStrategy;\n    this.inConverter = inConverter ?? new PassthroughConverter();\n    this.outConverter = outConverter ?? new PassthroughConverter();\n    this.inPreferences = inPreferences ?? {};\n  }\n\n  public async getRepresentation(\n    identifier: ResourceIdentifier,\n    preferences: RepresentationPreferences,\n    conditions?: Conditions,\n  ): Promise<Representation> {\n    const representation = await super.getRepresentation(identifier, preferences, conditions);\n    return this.outConverter.handleSafe({ identifier, representation, preferences });\n  }\n\n  public async addResource(\n    identifier: ResourceIdentifier,\n    representation: Representation,\n    conditions?: Conditions,\n  ): Promise<ChangeMap> {\n    // In case of containers, no content-type is required and the representation is not used.\n    if (representation.metadata.contentType) {\n      // We can potentially run into problems here if we convert a turtle document where the base IRI is required,\n      // since we don't know the resource IRI yet at this point.\n      representation = await this.inConverter.handleSafe(\n        { identifier, representation, preferences: this.inPreferences },\n      );\n    }\n    return this.source.addResource(identifier, representation, conditions);\n  }\n\n  public async setRepresentation(\n    identifier: ResourceIdentifier,\n    representation: Representation,\n    conditions?: Conditions,\n  ): Promise<ChangeMap> {\n    // When it is a metadata resource, convert it to Quads as those are expected in the later stores\n    if (this.metadataStrategy.isAuxiliaryIdentifier(identifier)) {\n      representation = await this.inConverter.handleSafe(\n        { identifier, representation, preferences: { type: { [INTERNAL_QUADS]: 1 }}},\n      );\n    } else if (representation.metadata.contentType) {\n      representation = await this.inConverter.handleSafe(\n        { identifier, representation, preferences: this.inPreferences },\n      );\n    }\n    return this.source.setRepresentation(identifier, representation, conditions);\n  }\n}\n"]}