{"version":3,"file":"ErrorToTemplateConverter.js","sourceRoot":"","sources":["../../../src/storage/conversion/ErrorToTemplateConverter.ts"],"names":[],"mappings":";;;;;;AAAA,8DAAiC;AACjC,uFAAoF;AAEpF,0DAAyD;AAEzD,mEAAoE;AACpE,kDAAwD;AACxD,sDAAsD;AACtD,sDAAwD;AAExD,yFAAsF;AAWtF,MAAM,wBAAwB,GAAoB;IAChD,gBAAgB,EAAE,IAAA,4BAAiB,EAAC,6BAA6B,CAAC;IAClE,iBAAiB,EAAE,IAAA,4BAAiB,EAAC,+BAA+B,CAAC;IACrE,SAAS,EAAE,SAAS;IACpB,WAAW,EAAE,eAAe;CAC7B,CAAC;AAEF;;;;;;;;;;GAUG;AACH,MAAa,wBAAyB,SAAQ,mEAAgC;IAC3D,cAAc,CAAiB;IAC/B,gBAAgB,CAAS;IACzB,iBAAiB,CAAS;IAC1B,SAAS,CAAS;IAClB,WAAW,CAAS;IAErC,YAAmB,cAA8B,EAAE,eAAiC;QAClF,KAAK,CAAC,6BAAc,EAAE,eAAe,EAAE,WAAW,IAAI,wBAAwB,CAAC,WAAY,CAAC,CAAC;QAC7F,uFAAuF;QACvF,IAAI,CAAC,eAAe,IAAI,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAClE,eAAe,GAAG,wBAAwB,CAAC;QAC7C,CAAC;QACD,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;QACrC,IAAI,CAAC,gBAAgB,GAAG,eAAe,CAAC,gBAAiB,CAAC;QAC1D,IAAI,CAAC,iBAAiB,GAAG,eAAe,CAAC,iBAAkB,CAAC;QAC5D,IAAI,CAAC,SAAS,GAAG,eAAe,CAAC,SAAU,CAAC;QAC5C,IAAI,CAAC,WAAW,GAAG,eAAe,CAAC,WAAY,CAAC;IAClD,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,cAAc,EAA+B;QACjE,MAAM,KAAK,GAAG,MAAM,IAAA,0BAAa,EAAC,cAAc,CAAC,IAAI,CAAc,CAAC;QAEpE,gEAAgE;QAChE,IAAI,WAA+B,CAAC;QACpC,IAAI,CAAC;YACH,MAAM,YAAY,GAAG,GAAG,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC;YAC3D,IAAA,qBAAM,EAAC,IAAA,4BAAe,EAAC,YAAY,CAAC,EAAE,6BAA6B,CAAC,CAAC;YACrE,qDAAqD;YACrD,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC;gBACjD,QAAQ,EAAE,IAAA,iCAAiB,EAAC,KAAK,CAAC,QAAQ,CAAC;gBAC3C,QAAQ,EAAE,EAAE,YAAY,EAAE,YAAY,EAAE,IAAI,CAAC,iBAAiB,EAAE;aACjE,CAAC,CAAC;QACL,CAAC;QAAC,MAAM,CAAC;YACP,8EAA8E;QAChF,CAAC;QAED,qEAAqE;QACrE,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,KAAK,CAAC;QAC9C,MAAM,QAAQ,GAAG,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,WAAW,EAAE,KAAK,EAAE,CAAC;QAC9D,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,cAAc;aACvC,UAAU,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE,YAAY,EAAE,IAAI,CAAC,gBAAgB,EAAE,EAAC,CAAC,CAAC;QAE9E,OAAO,IAAI,yCAAmB,CAAC,QAAQ,EAAE,cAAc,CAAC,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;IACtF,CAAC;CACF;AA7CD,4DA6CC","sourcesContent":["import assert from 'node:assert';\nimport { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { Representation } from '../../http/representation/Representation';\nimport { INTERNAL_ERROR } from '../../util/ContentTypes';\nimport type { HttpError } from '../../util/errors/HttpError';\nimport { extractErrorTerms } from '../../util/errors/HttpErrorUtil';\nimport { resolveModulePath } from '../../util/PathUtil';\nimport { getSingleItem } from '../../util/StreamUtil';\nimport { isValidFileName } from '../../util/StringUtil';\nimport type { TemplateEngine } from '../../util/templates/TemplateEngine';\nimport { BaseTypedRepresentationConverter } from './BaseTypedRepresentationConverter';\nimport type { RepresentationConverterArgs } from './RepresentationConverter';\n\n// Fields optional due to https://github.com/LinkedSoftwareDependencies/Components.js/issues/20\nexport interface TemplateOptions {\n  mainTemplatePath?: string;\n  codeTemplatesPath?: string;\n  extension?: string;\n  contentType?: string;\n}\n\nconst DEFAULT_TEMPLATE_OPTIONS: TemplateOptions = {\n  mainTemplatePath: resolveModulePath('templates/error/main.md.hbs'),\n  codeTemplatesPath: resolveModulePath('templates/error/descriptions/'),\n  extension: '.md.hbs',\n  contentType: 'text/markdown',\n};\n\n/**\n * Serializes an Error by filling in the provided template.\n * Content-type is based on the constructor parameter.\n *\n * In case the input Error has an `errorCode` value,\n * the converter will look in the `descriptions` for a file\n * with the exact same name as that error code + `extension`.\n * The templating engine will then be applied to that file.\n * That result will be passed as an additional parameter to the main templating call,\n * using the variable `codeMessage`.\n */\nexport class ErrorToTemplateConverter extends BaseTypedRepresentationConverter {\n  private readonly templateEngine: TemplateEngine;\n  private readonly mainTemplatePath: string;\n  private readonly codeTemplatesPath: string;\n  private readonly extension: string;\n  private readonly contentType: string;\n\n  public constructor(templateEngine: TemplateEngine, templateOptions?: TemplateOptions) {\n    super(INTERNAL_ERROR, templateOptions?.contentType ?? DEFAULT_TEMPLATE_OPTIONS.contentType!);\n    // Workaround for https://github.com/LinkedSoftwareDependencies/Components.js/issues/20\n    if (!templateOptions || Object.keys(templateOptions).length === 0) {\n      templateOptions = DEFAULT_TEMPLATE_OPTIONS;\n    }\n    this.templateEngine = templateEngine;\n    this.mainTemplatePath = templateOptions.mainTemplatePath!;\n    this.codeTemplatesPath = templateOptions.codeTemplatesPath!;\n    this.extension = templateOptions.extension!;\n    this.contentType = templateOptions.contentType!;\n  }\n\n  public async handle({ representation }: RepresentationConverterArgs): Promise<Representation> {\n    const error = await getSingleItem(representation.data) as HttpError;\n\n    // Render the error description using an error-specific template\n    let description: string | undefined;\n    try {\n      const templateFile = `${error.errorCode}${this.extension}`;\n      assert(isValidFileName(templateFile), 'Invalid error template name');\n      // Filter out the error terms to pass to the template\n      description = await this.templateEngine.handleSafe({\n        contents: extractErrorTerms(error.metadata),\n        template: { templateFile, templatePath: this.codeTemplatesPath },\n      });\n    } catch {\n      // In case no template is found, or rendering errors, we still want to convert\n    }\n\n    // Render the main template, embedding the rendered error description\n    const { name, message, stack, cause } = error;\n    const contents = { name, message, stack, description, cause };\n    const rendered = await this.templateEngine\n      .handleSafe({ contents, template: { templateFile: this.mainTemplatePath }});\n\n    return new BasicRepresentation(rendered, representation.metadata, this.contentType);\n  }\n}\n"]}