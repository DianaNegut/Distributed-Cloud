{"version":3,"file":"RdfToQuadConverter.js","sourceRoot":"","sources":["../../../src/storage/conversion/RdfToQuadConverter.ts"],"names":[],"mappings":";;;;;;AAAA,6CAA0C;AAC1C,+DAA+D;AAE/D,0DAAkC;AAClC,uFAAoF;AAEpF,6FAA0F;AAC1F,0DAA2E;AAC3E,+EAA4E;AAC5E,sDAAmD;AACnD,0DAA4E;AAC5E,yFAAsF;AACtF,qDAAyD;AAGzD;;;;;;;GAOG;AACH,MAAa,kBAAmB,SAAQ,mEAAgC;IACrD,cAAc,CAAwB;IAEvD,YAAmB,WAAmC,EAAE;QACtD,MAAM,UAAU,GAAG,mBAAS,CAAC,0BAA0B,EAAE;YACvD,6DAA6D;aAC5D,IAAI,CAAC,CAAC,KAAK,EAA0B,EAAE;YACtC,OAAO,KAAK,CAAC,+BAAgB,CAAC,CAAC;YAC/B,OAAO,KAAK,CAAC;QACf,CAAC,CAAC,CAAC;QACL,KAAK,CAAC,UAAU,EAAE,6BAAc,CAAC,CAAC;QAClC,IAAI,CAAC,cAAc,GAAG,IAAI,sCAAqB,CAAC,QAAQ,CAAC,CAAC;IAC5D,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,EAAE,cAAc,EAAE,UAAU,EAA+B;QAC7E,MAAM,WAAW,GAAG,IAAI,+CAAsB,CAAC,cAAc,CAAC,QAAQ,EAAE,6BAAc,CAAC,CAAC;QACxF,MAAM,QAAQ,GAAG,mBAAS,CAAC,KAAK,CAAC,cAAc,CAAC,IAAI,EAAE;YACpD,WAAW,EAAE,cAAc,CAAC,QAAQ,CAAC,WAAY;YACjD,OAAO,EAAE,UAAU,CAAC,IAAI;YACxB,CAAC,oCAAkB,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC,cAAc;SAC9D,CAAC;YACA,gHAAgH;YAChH,+GAA+G;YAC/G,mFAAmF;aAClF,EAAE,CAAC,QAAQ,EAAE,CAAC,MAAc,EAAE,GAAc,EAAQ,EAAE;YACrD,WAAW,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,EAAE,oCAAqB,EAAE,MAAM,EAAE,yBAAU,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;QACnG,CAAC,CAAC,CAAC;QAEL,MAAM,IAAI,GAAG,IAAI,yBAAW,CAAC,EAAE,UAAU,EAAE,IAAI,EAAE,CAAC,CAAC;QACnD,MAAM,IAAI,GAAG,IAAA,uBAAU,EAAC,QAAQ,EAAE,IAAI,EAAE,CAAC,KAAK,EAAS,EAAE,CAAC,IAAI,yCAAmB,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;QAElG,OAAO,IAAI,yCAAmB,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;IACpD,CAAC;CACF;AAjCD,gDAiCC","sourcesContent":["import { PassThrough } from 'node:stream';\nimport { KeysRdfParseJsonLd } from '@comunica/context-entries';\nimport type { NamedNode } from '@rdfjs/types';\nimport rdfParser from 'rdf-parse';\nimport { BasicRepresentation } from '../../http/representation/BasicRepresentation';\nimport type { Representation } from '../../http/representation/Representation';\nimport { RepresentationMetadata } from '../../http/representation/RepresentationMetadata';\nimport { APPLICATION_JSON, INTERNAL_QUADS } from '../../util/ContentTypes';\nimport { BadRequestHttpError } from '../../util/errors/BadRequestHttpError';\nimport { pipeSafely } from '../../util/StreamUtil';\nimport { PREFERRED_PREFIX_TERM, SOLID_META } from '../../util/Vocabularies';\nimport { BaseTypedRepresentationConverter } from './BaseTypedRepresentationConverter';\nimport { ContextDocumentLoader } from './ConversionUtil';\nimport type { RepresentationConverterArgs } from './RepresentationConverter';\n\n/**\n * Converts most major RDF serializations to `internal/quads`.\n *\n * Custom contexts can be defined to be used when parsing JSON-LD.\n * The keys of the object should be the URL of the context,\n * and the values the file path of the contexts to use when the JSON-LD parser would fetch the given context.\n * We use filepaths because embedding them directly into the configurations breaks Components.js.\n */\nexport class RdfToQuadConverter extends BaseTypedRepresentationConverter {\n  private readonly documentLoader: ContextDocumentLoader;\n\n  public constructor(contexts: Record<string, string> = {}) {\n    const inputTypes = rdfParser.getContentTypesPrioritized()\n      // ContentType application/json MAY NOT be converted to Quad.\n      .then((types): Record<string, number> => {\n        delete types[APPLICATION_JSON];\n        return types;\n      });\n    super(inputTypes, INTERNAL_QUADS);\n    this.documentLoader = new ContextDocumentLoader(contexts);\n  }\n\n  public async handle({ representation, identifier }: RepresentationConverterArgs): Promise<Representation> {\n    const newMetadata = new RepresentationMetadata(representation.metadata, INTERNAL_QUADS);\n    const rawQuads = rdfParser.parse(representation.data, {\n      contentType: representation.metadata.contentType!,\n      baseIRI: identifier.path,\n      [KeysRdfParseJsonLd.documentLoader.name]: this.documentLoader,\n    })\n      // This works only for those cases where the data stream has been completely read before accessing the metadata.\n      // Eg. the PATCH operation, which is the main case why we store the prefixes in metadata here if there are any.\n      // See also https://github.com/CommunitySolidServer/CommunitySolidServer/issues/126\n      .on('prefix', (prefix: string, iri: NamedNode): void => {\n        newMetadata.addQuad(iri.value, PREFERRED_PREFIX_TERM, prefix, SOLID_META.terms.ResponseMetadata);\n      });\n\n    const pass = new PassThrough({ objectMode: true });\n    const data = pipeSafely(rawQuads, pass, (error): Error => new BadRequestHttpError(error.message));\n\n    return new BasicRepresentation(data, newMetadata);\n  }\n}\n"]}