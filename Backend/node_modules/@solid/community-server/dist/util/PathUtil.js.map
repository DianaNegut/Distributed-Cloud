{"version":3,"file":"PathUtil.js","sourceRoot":"","sources":["../../src/util/PathUtil.ts"],"names":[],"mappings":";;;;;;AA4BA,8CAEC;AAUD,oCAEC;AAWD,4CASC;AAWD,kDAEC;AASD,kDAEC;AAWD,gDAEC;AASD,gDAEC;AAQD,oCAGC;AAmCD,gDAGC;AA0BD,0DAIC;AAWD,0DAEC;AAOD,0CAIC;AAOD,sDAEC;AAQD,sCAGC;AAUD,wCAWC;AAeD,sDAGC;AAKD,sCAEC;AAYD,gCAEC;AAKD,8CAEC;AAOD,4CAKC;AAKD,0CAEC;AA/TD,yCAAyC;AACzC,uCAAoC;AACpC,wDAA+B;AAI/B,sEAAmE;AACnE,0DAA8D;AAG9D;;;;;;GAMG;AACH,SAAS,kBAAkB,CAAC,IAAY;IACtC,OAAO,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;AACvC,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,iBAAiB,CAAC,IAAY;IAC5C,OAAO,iBAAK,CAAC,SAAS,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC,CAAC;AACnD,CAAC;AAED;;;;;;;GAOG;AACH,SAAgB,YAAY,CAAC,QAAgB,EAAE,GAAG,KAAe;IAC/D,OAAO,iBAAK,CAAC,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,EAAE,GAAG,KAAK,CAAC,CAAC;AAC5D,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,gBAAgB,CAAC,IAAY;IAC3C,IAAI,iBAAK,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;QAC3B,OAAO,IAAI,CAAC;IACd,CAAC;IACD,IAAI,iBAAK,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;QAC3B,OAAO,kBAAkB,CAAC,IAAI,CAAC,CAAC;IAClC,CAAC;IAED,OAAO,YAAY,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;AAC3C,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,mBAAmB,CAAC,IAAY;IAC9C,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;AACpC,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,mBAAmB,CAAC,IAAY;IAC9C,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;AACnC,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,kBAAkB,CAAC,IAAY;IAC7C,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;AACpC,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,kBAAkB,CAAC,IAAY;IAC7C,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;AACnC,CAAC;AAED;;;;;GAKG;AACH,SAAgB,YAAY,CAAC,IAAY;IACvC,MAAM,SAAS,GAAG,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC5C,OAAO,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;AACvC,CAAC;AAED;;;GAGG;AACH,SAAS,uBAAuB,CAAC,IAAY,EAAE,SAAmC;IAChF,MAAM,CAAE,AAAD,EAAG,IAAI,EAAE,WAAW,CAAE,GAAG,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAE,CAAC;IAChE,MAAM,WAAW,GAAG,IAAI;QACtB,0EAA0E;QAC1E,gFAAgF;QAChF,oDAAoD;QACpD,iFAAiF;QACjF,uEAAuE;QACvE,oEAAoE;QACpE,8EAA8E;SAC7E,KAAK,CAAC,6BAA6B,CAAC;QACrC,4DAA4D;QAC5D,yEAAyE;SACxE,GAAG,CAAC,CAAC,IAAI,EAAE,KAAK,EAAU,EAAE,CAC3B,KAAK,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;SACxD,IAAI,CAAC,EAAE,CAAC,CAAC;IACZ,OAAO,WAAW,CAAC,CAAC,CAAC,GAAG,WAAW,GAAG,WAAW,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC;AACpE,CAAC;AAED;;;;;;;;;GASG;AACH,SAAgB,kBAAkB,CAAC,IAAY;IAC7C,OAAO,uBAAuB,CAAC,IAAI,EAAE,CAAC,IAAI,EAAU,EAAE,CACpD,kBAAkB,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClD,CAAC;AAED,yCAAyC;AACzC,gDAAgD;AAChD,MAAM,gBAAgB,GAAG;IACvB,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,GAAG,EAAE,KAAK;IACV,qDAAqD;IACrD,GAAG,EAAE,KAAK;CACF,CAAC;AACX,wCAAwC;AACxC,MAAM,cAAc,GAAG,IAAI,MAAM,CAAC,IAAI,MAAM,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;AACvF;;;;;;;;;GASG;AACH,SAAgB,uBAAuB,CAAC,IAAY;IAClD,OAAO,uBAAuB,CAAC,IAAI,EAAE,CAAC,IAAI,EAAU,EAAE,CAAC,kBAAkB,CAAC,IAAI,CAAC;QAC7E,2FAA2F;SAC1F,OAAO,CAAC,cAAc,EAAE,CAAC,GAAG,EAAU,EAAE,CAAC,gBAAgB,CAAC,GAAoC,CAAC,CAAC,CAAC,CAAC;AACvG,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,uBAAuB,CAAC,IAAY;IAClD,OAAO,uBAAuB,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC;AAC3D,CAAC;AAED;;;;GAIG;AACH,SAAgB,eAAe,CAAC,IAAY;IAC1C,wEAAwE;IACxE,qEAAqE;IACrE,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;AAC5B,CAAC;AAED;;;;GAIG;AACH,SAAgB,qBAAqB,CAAC,UAA8B;IAClE,OAAO,eAAe,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;AAC1C,CAAC;AAED;;;;;GAKG;AACH,SAAgB,aAAa,CAAC,GAAW;IACvC,MAAM,KAAK,GAAG,qBAAqB,CAAC,IAAI,CAAC,GAAG,CAAE,CAAC;IAC/C,OAAO,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;AAC9C,CAAC;AAED;;;;;;;GAOG;AACI,KAAK,UAAU,cAAc,CAAC,OAAe,EAAE,OAAoB,EAAE,eAAgC;IAE1G,OAAO,GAAG,mBAAmB,CAAC,OAAO,CAAC,CAAC;IACvC,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,UAAU,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC;IAC7D,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC;QACrC,MAAM,IAAI,yCAAmB,CAC3B,kBAAkB,MAAM,CAAC,IAAI,8CAA8C,EAC3E,EAAE,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAA,oCAAoB,EAAC,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC,EAAE,CAC9E,CAAC;IACJ,CAAC;IACD,OAAO,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;AAC/C,CAAC;AAED;;;;;;;;;;;;GAYG;AACH,SAAgB,qBAAqB,CAAC,OAAe;IACnD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,aAAa,CAAC,OAAO,CAAC,CAAC;IAChD,OAAO,IAAI,MAAM,CAAC,IAAI,MAAM,kBAAkB,IAAI,EAAE,EAAE,GAAG,CAAC,CAAC;AAC7D,CAAC;AAED;;GAEG;AACH,SAAgB,aAAa;IAC3B,OAAO,YAAY,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;AAC3C,CAAC;AAED;;;GAGG;AACU,QAAA,qBAAqB,GAAG,OAAO,CAAC;AAE7C;;;GAGG;AACH,SAAgB,UAAU,CAAC,YAAY,GAAG,EAAE;IAC1C,OAAO,GAAG,6BAAqB,GAAG,YAAY,EAAE,CAAC;AACnD,CAAC;AAED;;GAEG;AACH,SAAgB,iBAAiB,CAAC,YAAY,GAAG,EAAE;IACjD,OAAO,YAAY,CAAC,aAAa,EAAE,EAAE,YAAY,CAAC,CAAC;AACrD,CAAC;AAED;;;;GAIG;AACH,SAAgB,gBAAgB,CAAC,IAAI,GAAG,6BAAqB;IAC3D,IAAI,IAAI,CAAC,UAAU,CAAC,6BAAqB,CAAC,EAAE,CAAC;QAC3C,OAAO,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,6BAAqB,CAAC,MAAM,CAAC,CAAC,CAAC;IACrE,CAAC;IACD,OAAO,gBAAgB,CAAC,IAAI,CAAC,CAAC;AAChC,CAAC;AAED;;GAEG;AACI,KAAK,UAAU,eAAe;IACnC,OAAO,IAAA,mBAAQ,EAAC,iBAAiB,CAAC,cAAc,CAAC,CAAkC,CAAC;AACtF,CAAC;AAED;;;GAGG;AACU,QAAA,OAAO,GAAG,kBAAO,CAAC","sourcesContent":["import { posix, win32 } from 'node:path';\nimport { readJson } from 'fs-extra';\nimport urljoin from 'url-join';\nimport type { TargetExtractor } from '../http/input/identifier/TargetExtractor';\nimport type { ResourceIdentifier } from '../http/representation/ResourceIdentifier';\nimport type { HttpRequest } from '../server/HttpRequest';\nimport { BadRequestHttpError } from './errors/BadRequestHttpError';\nimport { errorTermsToMetadata } from './errors/HttpErrorUtil';\nimport type { Json } from './Json';\n\n/**\n * Changes a potential Windows path into a POSIX path.\n *\n * @param path - Path to check (POSIX or Windows).\n *\n * @returns The potentially changed path (POSIX).\n */\nfunction windowsToPosixPath(path: string): string {\n  return path.replaceAll(/\\\\+/gu, '/');\n}\n\n/**\n * Resolves relative segments in the path.\n *\n * @param path - Path to check (POSIX or Windows).\n *\n * @returns The potentially changed path (POSIX).\n */\nexport function normalizeFilePath(path: string): string {\n  return posix.normalize(windowsToPosixPath(path));\n}\n\n/**\n * Adds the paths to the base path.\n *\n * @param basePath - The base path (POSIX or Windows).\n * @param paths - Subpaths to attach (POSIX).\n *\n * @returns The potentially changed path (POSIX).\n */\nexport function joinFilePath(basePath: string, ...paths: string[]): string {\n  return posix.join(windowsToPosixPath(basePath), ...paths);\n}\n\n/**\n * Resolves a path to its absolute form.\n * Absolute inputs will not be changed (except changing Windows to POSIX).\n * Relative inputs will be interpreted relative to process.cwd().\n *\n * @param path - Path to check (POSIX or Windows).\n *\n * @returns The potentially changed path (POSIX).\n */\nexport function absoluteFilePath(path: string): string {\n  if (posix.isAbsolute(path)) {\n    return path;\n  }\n  if (win32.isAbsolute(path)) {\n    return windowsToPosixPath(path);\n  }\n\n  return joinFilePath(process.cwd(), path);\n}\n\n/**\n * Makes sure the input path has exactly 1 slash at the end.\n * Multiple slashes will get merged into one.\n * If there is no slash it will be added.\n *\n * @param path - Path to check.\n *\n * @returns The potentially changed path.\n */\nexport function ensureTrailingSlash(path: string): string {\n  return path.replace(/\\/*$/u, '/');\n}\n\n/**\n * Makes sure the input path has no slashes at the end.\n *\n * @param path - Path to check.\n *\n * @returns The potentially changed path.\n */\nexport function trimTrailingSlashes(path: string): string {\n  return path.replace(/\\/+$/u, '');\n}\n\n/**\n * Makes sure the input path has exactly 1 slash at the beginning.\n * Multiple slashes will get merged into one.\n * If there is no slash it will be added.\n *\n * @param path - Path to check.\n *\n * @returns The potentially changed path.\n */\nexport function ensureLeadingSlash(path: string): string {\n  return path.replace(/^\\/*/u, '/');\n}\n\n/**\n * Makes sure the input path has no slashes at the beginning.\n *\n * @param path - Path to check.\n *\n * @returns The potentially changed path.\n */\nexport function trimLeadingSlashes(path: string): string {\n  return path.replace(/^\\/+/u, '');\n}\n\n/**\n * Extracts the extension (without dot) from a path.\n * Custom function since `path.extname` does not work on all cases (e.g. \".acl\")\n *\n * @param path - Input path to parse.\n */\nexport function getExtension(path: string): string {\n  const extension = /\\.([^./]+)$/u.exec(path);\n  return extension ? extension[1] : '';\n}\n\n/**\n * Performs a transformation on the path components of a URI,\n * preserving but normalizing path delimiters and their escaped forms.\n */\nfunction transformPathComponents(path: string, transform: (part: string) => string): string {\n  const [ , base, queryString ] = /^([^?]*)(\\?.*)?$/u.exec(path)!;\n  const transformed = base\n    // We split on actual URI path component delimiters (slash and backslash),\n    // but also on things that could be wrongly interpreted as component delimiters,\n    // such that they cannot be transformed incorrectly.\n    // We thus ensure that encoded slashes (%2F) and backslashes (%5C) are preserved,\n    // since they would become _actual_ delimiters if accidentally decoded.\n    // Additionally, we need to preserve any encoded percent signs (%25)\n    // that precede them, because these might change their interpretation as well.\n    .split(/(\\/|\\\\|%(?:25)*(?:2f|5c))/iu)\n    // Even parts map to components that need to be transformed,\n    // odd parts to (possibly escaped) delimiters that need to be normalized.\n    .map((part, index): string =>\n      index % 2 === 0 ? transform(part) : part.toUpperCase())\n    .join('');\n  return queryString ? `${transformed}${queryString}` : transformed;\n}\n\n/**\n * Converts a URI path to the canonical version by splitting on slashes,\n * decoding any percent-based encodings, and then encoding any special characters.\n * This function is used to clean unwanted characters in the components of\n * the provided path.\n *\n * @param path - The path to convert to its canonical URI path form.\n *\n * @returns The canonical URI path form of the provided path.\n */\nexport function toCanonicalUriPath(path: string): string {\n  return transformPathComponents(path, (part): string =>\n    encodeURIComponent(decodeURIComponent(part)));\n}\n\n/* eslint-disable ts/naming-convention */\n// Characters not allowed in a Windows file path\nconst forbiddenSymbols = {\n  '<': '%3C',\n  '>': '%3E',\n  ':': '%3A',\n  '\"': '%22',\n  '|': '%7C',\n  '?': '%3F',\n  // `*` does not get converted by `encodeUriComponent`\n  '*': '%2A',\n} as const;\n/* eslint-enable ts/naming-convention */\nconst forbiddenRegex = new RegExp(`[${Object.keys(forbiddenSymbols).join('')}]`, 'gu');\n/**\n * This function is used when converting a URI to a file path. Decodes all components of a URI path,\n * with the exception of encoded slash characters, as this would lead to unexpected file locations\n * being targeted (resulting in erroneous behaviour of the file based backend).\n * Characters that would result in an illegal file path remain percent encoded.\n *\n * @param path - The path to decode the URI path components of.\n *\n * @returns A decoded copy of the provided URI path (ignoring encoded slash characters).\n */\nexport function decodeUriPathComponents(path: string): string {\n  return transformPathComponents(path, (part): string => decodeURIComponent(part)\n    // The characters replaced below result in illegal Windows file paths so need to be encoded\n    .replace(forbiddenRegex, (val): string => forbiddenSymbols[val as keyof typeof forbiddenSymbols]));\n}\n\n/**\n * This function is used in the process of converting a file path to a URI. Encodes all (non-slash)\n * special characters in a URI path, with the exception of encoded slash characters, as this would\n * lead to unnecessary double encoding, resulting in a URI that differs from the expected result.\n *\n * @param path - The path to encode the URI path components of.\n *\n * @returns An encoded copy of the provided URI path (ignoring encoded slash characters).\n */\nexport function encodeUriPathComponents(path: string): string {\n  return transformPathComponents(path, encodeURIComponent);\n}\n\n/**\n * Checks whether the path corresponds to a container path (ending in a /).\n *\n * @param path - Path to check.\n */\nexport function isContainerPath(path: string): boolean {\n  // Solid, ยง3.1: \"Paths ending with a slash denote a container resource.\"\n  // https://solid.github.io/specification/protocol#uri-slash-semantics\n  return path.endsWith('/');\n}\n\n/**\n * Checks whether the identifier corresponds to a container identifier.\n *\n * @param identifier - Identifier to check.\n */\nexport function isContainerIdentifier(identifier: ResourceIdentifier): boolean {\n  return isContainerPath(identifier.path);\n}\n\n/**\n * Splits a URL (or similar) string into a part containing its scheme and one containing the rest.\n * E.g., `http://test.com/` results in `{ scheme: 'http://', rest: 'test.com/' }`.\n *\n * @param url - String to parse.\n */\nexport function extractScheme(url: string): { scheme: string; rest: string } {\n  const match = /^([^:]+:\\/\\/)(.*)$/u.exec(url)!;\n  return { scheme: match[1], rest: match[2] };\n}\n\n/**\n * Creates a relative URL by removing the base URL.\n * Will throw an error in case the resulting target is not withing the base URL scope.\n *\n * @param baseUrl - Base URL.\n * @param request - Incoming request of which the target needs to be extracted.\n * @param targetExtractor - Will extract the target from the request.\n */\nexport async function getRelativeUrl(baseUrl: string, request: HttpRequest, targetExtractor: TargetExtractor):\nPromise<string> {\n  baseUrl = ensureTrailingSlash(baseUrl);\n  const target = await targetExtractor.handleSafe({ request });\n  if (!target.path.startsWith(baseUrl)) {\n    throw new BadRequestHttpError(\n      `The identifier ${target.path} is outside the configured identifier space.`,\n      { errorCode: 'E0001', metadata: errorTermsToMetadata({ path: target.path }) },\n    );\n  }\n  return target.path.slice(baseUrl.length - 1);\n}\n\n/**\n * Creates a regular expression that matches URLs containing the given baseUrl, or a subdomain of the given baseUrl.\n * In case there is a subdomain, the first match of the regular expression will be that subdomain.\n *\n * Examples with baseUrl `http://test.com/foo/`:\n * - Will match `http://test.com/foo/`\n * - Will match `http://test.com/foo/bar/baz`\n * - Will match `http://alice.bob.test.com/foo/bar/baz`, first match result will be `alice.bob`\n * - Will not match `http://test.com/`\n * - Will not match `http://alicetest.com/foo/`\n *\n * @param baseUrl - Base URL for the regular expression.\n */\nexport function createSubdomainRegexp(baseUrl: string): RegExp {\n  const { scheme, rest } = extractScheme(baseUrl);\n  return new RegExp(`^${scheme}(?:([^/]+)\\\\.)?${rest}`, 'u');\n}\n\n/**\n * Returns the folder corresponding to the root of the Community Solid Server module\n */\nexport function getModuleRoot(): string {\n  return joinFilePath(__dirname, '../../');\n}\n\n/**\n * A placeholder for the path to the `@solid/community-server` module root.\n * The `resolveAssetPath` function will replace this string with the actual path.\n */\nexport const modulePathPlaceholder = '@css:';\n\n/**\n * Creates a path starting from the `@solid/community-server` module root,\n * to be resolved by the `resolveAssetPath` function.\n */\nexport function modulePath(relativePath = ''): string {\n  return `${modulePathPlaceholder}${relativePath}`;\n}\n\n/**\n * Creates an absolute path starting from the `@solid/community-server` module root.\n */\nexport function resolveModulePath(relativePath = ''): string {\n  return joinFilePath(getModuleRoot(), relativePath);\n}\n\n/**\n * Converts file path inputs into absolute paths.\n * Works similar to `absoluteFilePath` but paths that start with the `modulePathPlaceholder`\n * will be relative to the module directory instead of the cwd.\n */\nexport function resolveAssetPath(path = modulePathPlaceholder): string {\n  if (path.startsWith(modulePathPlaceholder)) {\n    return resolveModulePath(path.slice(modulePathPlaceholder.length));\n  }\n  return absoluteFilePath(path);\n}\n\n/**\n * Reads the project package.json and returns it.\n */\nexport async function readPackageJson(): Promise<Record<string, Json>> {\n  return readJson(resolveModulePath('package.json')) as Promise<Record<string, Json>>;\n}\n\n/**\n * Concatenates all the given strings into a normalized URL.\n * Will place slashes between input strings if necessary.\n */\nexport const joinUrl = urljoin;\n"]}