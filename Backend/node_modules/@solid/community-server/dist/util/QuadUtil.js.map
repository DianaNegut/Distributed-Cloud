{"version":3,"file":"QuadUtil.js","sourceRoot":"","sources":["../../src/util/QuadUtil.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Readable } from 'node:stream';\nimport type { NamedNode, Quad, Term } from '@rdfjs/types';\nimport arrayifyStream from 'arrayify-stream';\nimport type { ParserOptions, Store } from 'n3';\nimport { StreamParser, StreamWriter } from 'n3';\nimport type { Guarded } from './GuardedStream';\nimport { guardedStreamFrom, pipeSafely } from './StreamUtil';\nimport { toNamedTerm } from './TermUtil';\n\n/**\n * Helper function for serializing an array of quads, with as result a Readable object.\n *\n * @param quads - The array of quads.\n * @param contentType - The content-type to serialize to.\n *\n * @returns The Readable object.\n */\nexport function serializeQuads(quads: Quad[], contentType?: string): Guarded<Readable> {\n  return pipeSafely(guardedStreamFrom(quads), new StreamWriter({ format: contentType }));\n}\n\n/**\n * Helper function to convert a Readable into an array of quads.\n *\n * @param readable - The readable object.\n * @param options - Options for the parser.\n *\n * @returns A promise containing the array of quads.\n */\nexport async function parseQuads(readable: Guarded<Readable>, options: ParserOptions = {}): Promise<Quad[]> {\n  return arrayifyStream(pipeSafely(readable, new StreamParser(options)));\n}\n\n/**\n * Filter out duplicate quads from an array.\n *\n * @param quads - Quads to filter.\n *\n * @returns A new array containing the unique quads.\n */\nexport function uniqueQuads(quads: Quad[]): Quad[] {\n  const uniques: Quad[] = [];\n  for (const quad of quads) {\n    if (!uniques.some((item): boolean => quad.equals(item))) {\n      uniques.push(quad);\n    }\n  }\n  return uniques;\n}\n\n/**\n * Converts a term to a number. Returns undefined if the term was undefined.\n *\n * @param term - Term to parse.\n * @param radix - Radix to use when parsing. Default is 10.\n */\nexport function termToInt(term?: Term, radix = 10): number | undefined {\n  if (term) {\n    return Number.parseInt(term.value, radix);\n  }\n}\n\n/**\n * Represents a triple pattern to be used as a filter.\n */\nexport class FilterPattern {\n  public readonly subject: NamedNode | null;\n  public readonly predicate: NamedNode | null;\n  public readonly object: NamedNode | null;\n\n  /**\n   * @param subject - Optionally filter based on a specific subject.\n   * @param predicate - Optionally filter based on a predicate.\n   * @param object - Optionally filter based on a specific object.\n   */\n  public constructor(subject?: string, predicate?: string, object?: string) {\n    this.subject = typeof subject === 'string' ? toNamedTerm(subject) : null;\n    this.predicate = typeof predicate === 'string' ? toNamedTerm(predicate) : null;\n    this.object = typeof object === 'string' ? toNamedTerm(object) : null;\n  }\n}\n\n/**\n * Represents a binding result from a SPARQL query.\n * The keys are the values of the Variable objects,\n * while the values are the terms mapped to those variables in a query result.\n */\nexport type SimpleBinding = Record<string, Term>;\n\n/**\n * Finds the matching bindings in the given data set for the given BGP query.\n *\n * @param bgp - BGP to solve\n * @param data - Dataset to query.\n */\nexport function solveBgp(bgp: Quad[], data: Store): SimpleBinding[] {\n  let result: SimpleBinding[] = [{}];\n  for (const pattern of bgp) {\n    const newResult: SimpleBinding[] = [];\n    for (const binding of result) {\n      newResult.push(...getAppliedBindings(pattern, binding, data));\n    }\n    result = newResult;\n  }\n  return result;\n}\n\n/**\n * Queries a data store with a pattern to find all resulting bindings.\n * Before matching the pattern with the store,\n * the given binding is applied to the pattern first.\n *\n * The resulting binding includes the given binding.\n *\n * @param pattern - Pattern to match with the data store.\n * @param binding - Pattern to first apply to the given pattern.\n * @param data - Data store to query.\n */\nexport function getAppliedBindings(pattern: Quad, binding: SimpleBinding, data: Store): SimpleBinding[] {\n  const result: SimpleBinding[] = [];\n  const matches = data.getQuads(\n    pattern.subject.termType === 'Variable' ? binding[pattern.subject.value] : pattern.subject,\n    pattern.predicate.termType === 'Variable' ? binding[pattern.predicate.value] : pattern.predicate,\n    pattern.object.termType === 'Variable' ? binding[pattern.object.value] : pattern.object,\n    null,\n  );\n  for (const match of matches) {\n    result.push({\n      ...binding,\n      ...matchBinding(pattern, match),\n    });\n  }\n  return result;\n}\n\n/**\n * Finds the binding necessary to match the given pattern to the given quad.\n * This function assumes it has been verified that the pattern can match the quad.\n *\n * @param pattern - Pattern that can match the quad.\n * @param match - A quad that can be matched by the given pattern.\n */\nexport function matchBinding(pattern: Quad, match: Quad): SimpleBinding {\n  const result: SimpleBinding = {};\n  for (const pos of [ 'subject', 'predicate', 'object' ] as const) {\n    if (pattern[pos].termType === 'Variable') {\n      result[pattern[pos].value] = match[pos];\n    }\n  }\n  return result;\n}\n"]}