{"version":3,"file":"StreamUtil.js","sourceRoot":"","sources":["../../src/util/StreamUtil.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DuplexOptions, ReadableOptions, Writable } from 'node:stream';\nimport { Readable, Transform } from 'node:stream';\nimport { promisify } from 'node:util';\nimport arrayifyStream from 'arrayify-stream';\nimport eos from 'end-of-stream';\nimport { Store } from 'n3';\nimport pump from 'pump';\nimport { getLoggerFor } from '../logging/LogUtil';\nimport { isHttpRequest } from '../server/HttpRequest';\nimport { InternalServerError } from './errors/InternalServerError';\nimport type { Guarded } from './GuardedStream';\nimport { guardStream } from './GuardedStream';\nimport type { Json } from './Json';\nimport type { PromiseOrValue } from './PromiseUtil';\n\nexport const endOfStream = promisify(eos);\n\nconst logger = getLoggerFor('StreamUtil');\n\n/**\n * Joins all strings of a stream.\n *\n * @param stream - Stream of strings.\n *\n * @returns The joined string.\n */\nexport async function readableToString(stream: Readable): Promise<string> {\n  return (await arrayifyStream<string>(stream)).join('');\n}\n\n/**\n * Imports quads from a stream into a Store.\n *\n * @param stream - Stream of quads.\n *\n * @returns A Store containing all the quads.\n */\nexport async function readableToQuads(stream: Readable): Promise<Store> {\n  const quads = new Store();\n  quads.import(stream);\n  await endOfStream(stream);\n  return quads;\n}\n\n/**\n * Interprets the stream as JSON and converts it to a Dict.\n *\n * @param stream - Stream of JSON data.\n *\n * @returns The parsed object.\n */\nexport async function readJsonStream(stream: Readable): Promise<Json> {\n  const body = await readableToString(stream);\n  return JSON.parse(body) as Json;\n}\n\n/**\n * Converts the stream to a single object.\n * This assumes the stream is in object mode and only contains a single element,\n * otherwise an error will be thrown.\n *\n * @param stream - Object stream with single entry.\n */\nexport async function getSingleItem(stream: Readable): Promise<unknown> {\n  const items = await arrayifyStream(stream);\n  if (items.length !== 1) {\n    throw new InternalServerError('Expected a stream with a single object.');\n  }\n  return items[0] as unknown;\n}\n\n// These error messages usually indicate expected behaviour so should not give a warning.\n// We compare against the error message instead of the code\n// since the second one is from an external library that does not assign an error code.\n// At the time of writing the first one gets thrown in Node 16 and the second one in Node 14.\nconst safeErrors = new Set([\n  'Cannot call write after a stream was destroyed',\n  'premature close',\n]);\n\n/**\n * Pipes one stream into another and emits errors of the first stream with the second.\n * If the first stream errors, the second one will be destroyed with the given error.\n * This will also make the stream {@link Guarded}.\n *\n * @param readable - Initial readable stream.\n * @param destination - The destination for writing data.\n * @param mapError - Optional function that takes the error and converts it to a new error.\n *\n * @returns The destination stream.\n */\nexport function pipeSafely<T extends Writable>(\n  readable: NodeJS.ReadableStream,\n  destination: T,\n  mapError?: (error: Error) => Error,\n): Guarded<T> {\n  // We never want to closes the incoming HttpRequest if there is an error\n  // since that also closes the outgoing HttpResponse.\n  // Since `pump` sends stream errors both up and down the pipe chain,\n  // in this case we need to make sure the error only goes down the chain.\n  if (isHttpRequest(readable)) {\n    readable.pipe(destination);\n    readable.on('error', (error): void => {\n      logger.warn(`HttpRequest errored with ${error.message}`);\n      // From https://nodejs.org/api/stream.html#stream_readable_pipe_destination_options :\n      // One important caveat is that if the Readable stream emits an error during processing,\n      // the Writable destination is not closed automatically. If an error occurs,\n      // it will be necessary to manually close each stream in order to prevent memory leaks.\n      destination.destroy(mapError ? mapError(error) : error);\n    });\n  } else {\n    // In case the input readable is guarded, it will no longer log errors since `pump` attaches a new error listener\n    pump(readable, destination, (error): void => {\n      if (error) {\n        const msg = `Piped stream errored with ${error.message}`;\n        logger.log(safeErrors.has(error.message) ? 'debug' : 'warn', msg);\n\n        // Make sure the final error can be handled in a normal streaming fashion\n        destination.emit('error', mapError ? mapError(error) : error);\n      }\n    });\n  }\n  // Guarding the stream now means the internal error listeners of pump will be ignored\n  // when checking if there is a valid error listener.\n  return guardStream(destination);\n}\n\nexport interface AsyncTransformOptions<T = unknown> extends DuplexOptions {\n  /**\n   * Transforms data from the source by calling the `push` method\n   */\n  transform?: (this: Transform, data: T, encoding: string) => PromiseOrValue<unknown>;\n\n  /**\n   * Performs any final actions after the source has ended\n   */\n  flush?: (this: Transform) => PromiseOrValue<unknown>;\n}\n\n/**\n * Transforms a stream, ensuring that all errors are forwarded.\n *\n * @param source - The stream to be transformed.\n * @param options - The transformation options.\n * @param options.transform - The transform function to use.\n * @param options.flush - The flush function to use.\n *\n * @returns The transformed stream\n */\nexport function transformSafely<T = unknown>(\n  source: NodeJS.ReadableStream,\n  {\n    transform = function(data): void {\n      this.push(data);\n    },\n    flush = (): null => null,\n    ...options\n  }: AsyncTransformOptions<T> = {},\n):\n  Guarded<Transform> {\n  return pipeSafely(source, new Transform({\n    ...options,\n    async transform(data: T, encoding, callback): Promise<void> {\n      let error: Error | null = null;\n      try {\n        await transform.call(this, data, encoding);\n      } catch (err: unknown) {\n        error = err as Error;\n      }\n      callback(error);\n    },\n    async flush(callback): Promise<void> {\n      let error: Error | null = null;\n      try {\n        await flush.call(this);\n      } catch (err: unknown) {\n        error = err as Error;\n      }\n      callback(error);\n    },\n  }));\n}\n\n/**\n * Converts a string or array to a stream and applies an error guard so that it is {@link Guarded}.\n *\n * @param contents - Data to stream.\n * @param options - Options to pass to the Readable constructor. See {@link Readable.from}.\n */\nexport function guardedStreamFrom(contents: string | Iterable<unknown>, options?: ReadableOptions): Guarded<Readable> {\n  return guardStream(Readable.from(typeof contents === 'string' ? [ contents ] : contents, options));\n}\n"]}