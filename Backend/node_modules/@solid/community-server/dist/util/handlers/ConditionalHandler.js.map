{"version":3,"file":"ConditionalHandler.js","sourceRoot":"","sources":["../../../src/util/handlers/ConditionalHandler.ts"],"names":[],"mappings":";;;AACA,+EAA4E;AAC5E,iDAA8C;AAE9C;;;;;;;;;GASG;AACH,MAAa,kBAA8B,SAAQ,2BAAuB;IACvD,MAAM,CAA0B;IAChC,OAAO,CAAmC;IAC1C,UAAU,CAAS;IACnB,YAAY,CAAU;IACtB,aAAa,CAAU;IAEhC,QAAQ,CAAU;IAE1B,YACE,MAA+B,EAC/B,OAAyC,EACzC,UAAkB,EAClB,YAAqB,EACrB,aAAa,GAAG,KAAK;QAErB,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;QAEnC,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;IACxB,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAAU;QAC/B,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACrC,CAAC;IAEM,KAAK,CAAC,UAAU,CAAC,KAAU;QAChC,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;QACnD,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;YAC3D,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACvB,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAAU;QAC5B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAC/C,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;YAC3D,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACvB,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,cAAc;QAC1B,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,IAAI,CAAC,QAAQ,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,IAAI,CAAC,YAAY,CAAC;QAChF,CAAC;QAED,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAClB,MAAM,IAAI,iDAAuB,CAAC,mCAAmC,CAAC,CAAC;QACzE,CAAC;IACH,CAAC;CACF;AA9DD,gDA8DC","sourcesContent":["import type { KeyValueStorage } from '../../storage/keyvalue/KeyValueStorage';\nimport { NotImplementedHttpError } from '../errors/NotImplementedHttpError';\nimport { AsyncHandler } from './AsyncHandler';\n\n/**\n * This handler will pass all requests to the wrapped handler,\n * until a specific value has been set in the given storage.\n * After that all input will be rejected.\n * Once the value has been matched this behaviour will be cached,\n * so changing the value again afterwards will not enable this handler again.\n *\n * If `handleStorage` is set to `true`,\n * this handler will set the value itself in the given storage after the source handler successfully resolved.\n */\nexport class ConditionalHandler<TIn, TOut> extends AsyncHandler<TIn, TOut> {\n  private readonly source: AsyncHandler<TIn, TOut>;\n  private readonly storage: KeyValueStorage<string, unknown>;\n  private readonly storageKey: string;\n  private readonly storageValue: unknown;\n  private readonly handleStorage: boolean;\n\n  private finished: boolean;\n\n  public constructor(\n    source: AsyncHandler<TIn, TOut>,\n    storage: KeyValueStorage<string, unknown>,\n    storageKey: string,\n    storageValue: unknown,\n    handleStorage = false,\n  ) {\n    super();\n    this.source = source;\n    this.storage = storage;\n    this.storageKey = storageKey;\n    this.storageValue = storageValue;\n    this.handleStorage = handleStorage;\n\n    this.finished = false;\n  }\n\n  public async canHandle(input: TIn): Promise<void> {\n    await this.checkCondition();\n    await this.source.canHandle(input);\n  }\n\n  public async handleSafe(input: TIn): Promise<TOut> {\n    await this.checkCondition();\n    const result = await this.source.handleSafe(input);\n    if (this.handleStorage) {\n      await this.storage.set(this.storageKey, this.storageValue);\n      this.finished = true;\n    }\n    return result;\n  }\n\n  public async handle(input: TIn): Promise<TOut> {\n    const result = await this.source.handle(input);\n    if (this.handleStorage) {\n      await this.storage.set(this.storageKey, this.storageValue);\n      this.finished = true;\n    }\n    return result;\n  }\n\n  /**\n   * Checks if the condition has already been fulfilled.\n   */\n  private async checkCondition(): Promise<void> {\n    if (!this.finished) {\n      this.finished = await this.storage.get(this.storageKey) === this.storageValue;\n    }\n\n    if (this.finished) {\n      throw new NotImplementedHttpError('The condition has been fulfilled.');\n    }\n  }\n}\n"]}