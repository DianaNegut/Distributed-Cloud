{"version":3,"file":"UnionHandler.js","sourceRoot":"","sources":["../../../src/util/handlers/UnionHandler.ts"],"names":[],"mappings":";;;AAAA,gDAA8C;AAE9C,iDAA8C;AAC9C,+CAA4D;AAE5D;;;;GAIG;AACH,MAAsB,YAAuD,SAC3E,2BAAyD;IACtC,QAAQ,CAAM;IAChB,UAAU,CAAU;IACpB,YAAY,CAAU;IAEvC;;;;;;;;;;;;;OAaG;IACH,YAAmB,QAAa,EAAE,UAAU,GAAG,KAAK,EAAE,YAAY,GAAG,CAAC,UAAU;QAC9E,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;IACnC,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,KAA2B;QAChD,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;YACpB,MAAM,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;QACjC,CAAC;aAAM,CAAC;YACN,mDAAmD;YACnD,MAAM,IAAA,yBAAW,EAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;QAC1C,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAM,CAAC,KAA2B;QAC7C,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,MAAM,IAAA,4BAAc,EAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAQ,CAAC;QACvG,MAAM,OAAO,GAAG,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAC,OAAO,EAAkC,EAAE,CAC5E,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,CAAmC,CAAC,CAAC;QAC7D,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,IAAA,0BAAY,EAAC,OAAO,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;IACtE,CAAC;IAED;;;OAGG;IACO,KAAK,CAAC,YAAY,CAAC,KAA2B;QACtD,MAAM,IAAA,0BAAY,EAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAC,OAAO,EAAiB,EAAE,CAAC,OAAO,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IACnG,CAAC;CAMF;AAvDD,oCAuDC","sourcesContent":["import { allFulfilled } from '../PromiseUtil';\nimport type { AsyncHandlerInput, AsyncHandlerOutput } from './AsyncHandler';\nimport { AsyncHandler } from './AsyncHandler';\nimport { filterHandlers, findHandler } from './HandlerUtil';\n\n/**\n * Utility handler that allows combining the results of multiple handlers into one.\n * Will run the handlers and then call the abstract `combine` function with the results,\n * which then generates the handler's output.\n */\nexport abstract class UnionHandler<T extends AsyncHandler<unknown, unknown>> extends\n  AsyncHandler<AsyncHandlerInput<T>, AsyncHandlerOutput<T>> {\n  protected readonly handlers: T[];\n  private readonly requireAll: boolean;\n  private readonly ignoreErrors: boolean;\n\n  /**\n   * Creates a new `UnionHandler`.\n   *\n   * When `requireAll` is false or `ignoreErrors` is true,\n   * the length of the input to `combine` can vary;\n   * otherwise, it is exactly the number of handlers.\n   *\n   * @param handlers - The handlers whose output is to be combined.\n   * @param requireAll - If true, will fail if any of the handlers do not support the input.\n                         If false, only the handlers that support the input will be called;\n   *                     will fail only if none of the handlers can handle the input.\n   * @param ignoreErrors - If true, ignores handlers that fail by omitting their output;\n   *                       if false, fails when any handlers fail.\n   */\n  public constructor(handlers: T[], requireAll = false, ignoreErrors = !requireAll) {\n    super();\n    this.handlers = handlers;\n    this.requireAll = requireAll;\n    this.ignoreErrors = ignoreErrors;\n  }\n\n  public async canHandle(input: AsyncHandlerInput<T>): Promise<void> {\n    if (this.requireAll) {\n      await this.allCanHandle(input);\n    } else {\n      // This will error if no handler supports the input\n      await findHandler(this.handlers, input);\n    }\n  }\n\n  public async handle(input: AsyncHandlerInput<T>): Promise<AsyncHandlerOutput<T>> {\n    const handlers = this.requireAll ? this.handlers : (await filterHandlers(this.handlers, input)) as T[];\n    const results = handlers.map(async(handler): Promise<AsyncHandlerOutput<T>> =>\n      (handler.handle(input)) as Promise<AsyncHandlerOutput<T>>);\n    return this.combine(await allFulfilled(results, this.ignoreErrors));\n  }\n\n  /**\n   * Checks if all handlers can handle the input.\n   * If not, throw an error based on the errors of the failed handlers.\n   */\n  protected async allCanHandle(input: AsyncHandlerInput<T>): Promise<void> {\n    await allFulfilled(this.handlers.map(async(handler): Promise<void> => handler.canHandle(input)));\n  }\n\n  /**\n   * Combines the results of the handlers into a single output.\n   */\n  protected abstract combine(results: AsyncHandlerOutput<T>[]): Promise<AsyncHandlerOutput<T>>;\n}\n"]}