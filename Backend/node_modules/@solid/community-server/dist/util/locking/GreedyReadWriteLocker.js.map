{"version":3,"file":"GreedyReadWriteLocker.js","sourceRoot":"","sources":["../../../src/util/locking/GreedyReadWriteLocker.ts"],"names":[],"mappings":";;;AAEA,uEAAoE;AACpE,+DAA4D;AAG5D;;;;;;GAMG;AACH,MAAa,qBAAsB,SAAQ,yCAAmB;IACzC,OAAO,CAAkC;IACzC,UAAU,CAAS;IACnB,WAAW,CAAS;IAEvC;;;;;OAKG;IACH,YACE,MAAsB,EACtB,OAAwC,EACxC,UAAU,GAAG,MAAM,EACnB,WAAW,GAAG,OAAO;QAErB,KAAK,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;QACtB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;IACjC,CAAC;IAES,sBAAsB,CAAC,UAA8B;QAC7D,OAAO,EAAE,IAAI,EAAE,GAAG,UAAU,CAAC,IAAI,IAAI,IAAI,CAAC,UAAU,EAAE,EAAE,CAAC;IAC3D,CAAC;IAED;;OAEG;IACO,WAAW,CAAC,UAA8B;QAClD,OAAO,GAAG,UAAU,CAAC,IAAI,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;IAClD,CAAC;IAED;;;;OAIG;IACO,KAAK,CAAC,WAAW,CAAC,UAA8B,EAAE,GAAW;QACrE,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;QAC9C,IAAI,MAAM,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACnD,MAAM,IAAI,GAAG,CAAC;QACd,IAAI,MAAM,KAAK,CAAC,EAAE,CAAC;YACjB,mEAAmE;YACnE,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QACtC,CAAC;aAAM,IAAI,MAAM,GAAG,CAAC,EAAE,CAAC;YACtB,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAC3C,CAAC;aAAM,CAAC;YACN,+DAA+D;YAC/D,MAAM,IAAI,yCAAmB,CAAC,gFAAgF,CAAC,CAAC;QAClH,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;CACF;AAtDD,sDAsDC","sourcesContent":["import type { ResourceIdentifier } from '../../http/representation/ResourceIdentifier';\nimport type { KeyValueStorage } from '../../storage/keyvalue/KeyValueStorage';\nimport { InternalServerError } from '../errors/InternalServerError';\nimport { BaseReadWriteLocker } from './BaseReadWriteLocker';\nimport type { ResourceLocker } from './ResourceLocker';\n\n/**\n * A {@link BaseReadWriteLocker} that uses the same locker for the main lock and the count lock,\n * and uses a {@link KeyValueStorage} for keeping track of the counter.\n *\n * Since it is completely dependent on other implementations,\n * this locker is threadsafe if its inputs are as well.\n */\nexport class GreedyReadWriteLocker extends BaseReadWriteLocker {\n  protected readonly storage: KeyValueStorage<string, number>;\n  protected readonly readSuffix: string;\n  protected readonly countSuffix: string;\n\n  /**\n   * @param locker - Used for creating read and write locks.\n   * @param storage - Used for storing the amount of active read operations on a resource.\n   * @param readSuffix - Used to generate the identifier for the lock that is applied when updating the counter.\n   * @param countSuffix - Used to generate the identifier that will be used in the storage for storing the counter.\n   */\n  public constructor(\n    locker: ResourceLocker,\n    storage: KeyValueStorage<string, number>,\n    readSuffix = 'read',\n    countSuffix = 'count',\n  ) {\n    super(locker, locker);\n    this.storage = storage;\n    this.readSuffix = readSuffix;\n    this.countSuffix = countSuffix;\n  }\n\n  protected getCountLockIdentifier(identifier: ResourceIdentifier): ResourceIdentifier {\n    return { path: `${identifier.path}.${this.readSuffix}` };\n  }\n\n  /**\n   * This key is used for storing the count of active read operations.\n   */\n  protected getCountKey(identifier: ResourceIdentifier): string {\n    return `${identifier.path}.${this.countSuffix}`;\n  }\n\n  /**\n   * Updates the count with the given modifier.\n   * Creates the data if it didn't exist yet.\n   * Deletes the data when the count reaches zero.\n   */\n  protected async modifyCount(identifier: ResourceIdentifier, mod: number): Promise<number> {\n    const countKey = this.getCountKey(identifier);\n    let number = await this.storage.get(countKey) ?? 0;\n    number += mod;\n    if (number === 0) {\n      // Make sure there is no remaining data once all locks are released\n      await this.storage.delete(countKey);\n    } else if (number > 0) {\n      await this.storage.set(countKey, number);\n    } else {\n      // Failsafe in case something goes wrong with the count storage\n      throw new InternalServerError('Read counter would become negative. Something is wrong with the count storage.');\n    }\n    return number;\n  }\n}\n"]}